<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Health Score — מדד בריאות פיננסית</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
/* ═══════════════════════════════════════════
   1. DESIGN TOKENS
   ═══════════════════════════════════════════ */
:root {
    --font: 'Rubik', sans-serif;

    --bg: #F4F5FA;
    --bg-subtle: #ECEDF5;
    --surface: #FFFFFF;
    --surface-hover: #F8F9FE;
    --surface-active: #F0F1FA;

    --primary: #6366F1;
    --primary-hover: #5558E6;
    --primary-light: #C7D2FE;
    --primary-bg: #EEF2FF;
    --primary-dark: #4338CA;
    --primary-glow: rgba(99,102,241,0.25);

    --accent: #F59E0B;
    --accent-bg: #FFFBEB;

    --success: #059669;
    --success-bg: #ECFDF5;
    --success-light: #6EE7B7;

    --danger: #DC2626;
    --danger-bg: #FEF2F2;
    --danger-light: #FCA5A5;

    --warning: #D97706;
    --warning-bg: #FFFBEB;

    --text: #1E1B4B;
    --text-secondary: #64748B;
    --text-muted: #94A3B8;
    --text-inverse: #FFFFFF;

    --border: #E2E8F0;
    --border-hover: #CBD5E1;

    --radius-xs: 6px;
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --radius-pill: 9999px;

    --shadow-xs: 0 1px 2px rgba(15,23,42,0.04);
    --shadow-sm: 0 2px 8px rgba(15,23,42,0.06);
    --shadow-md: 0 4px 16px rgba(15,23,42,0.08);
    --shadow-lg: 0 8px 32px rgba(15,23,42,0.1);
    --shadow-xl: 0 16px 48px rgba(15,23,42,0.14);

    --topbar-h: 60px;
    --gauge-arc: 282.743; /* π × 90 */
}

/* ═══════════════════════════════════════════
   2. RESET & BASE
   ═══════════════════════════════════════════ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }
body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    direction: rtl;
    min-height: 100vh;
    padding-top: var(--topbar-h);
    -webkit-font-smoothing: antialiased;
}
input, button, select, textarea { font-family: var(--font); }
button { cursor: pointer; border: none; background: none; }
a { text-decoration: none; color: inherit; }

/* ═══════════════════════════════════════════
   3. TOPBAR
   ═══════════════════════════════════════════ */
.topbar {
    position: fixed; top: 0; left: 0; right: 0;
    height: var(--topbar-h);
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    z-index: 999;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px;
    transition: box-shadow .3s;
}
body.scrolled .topbar { box-shadow: var(--shadow-sm); }
.topbar-right { display:flex; align-items:center; gap:12px; min-width:0; }
.topbar-logo {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--primary), #818CF8);
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 16px;
    flex-shrink: 0;
}
.topbar-company {
    font-weight: 600; font-size: 15px; color: var(--text);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 200px;
}
.topbar-center {
    display: flex; align-items: center; gap: 12px;
    opacity: 0; transform: translateY(-4px);
    transition: opacity .3s, transform .3s;
    pointer-events: none;
}
body.scrolled .topbar-center { opacity: 1; transform: translateY(0); pointer-events: auto; }
.topbar-mini-gauge { width: 36px; height: 36px; }
.topbar-mini-gauge svg { width: 100%; height: 100%; display: block; }
.topbar-score {
    font-size: 18px; font-weight: 700;
    background: linear-gradient(135deg, var(--primary), #818CF8);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    min-width: 44px; text-align: center;
}
.topbar-left { display: flex; align-items: center; gap: 8px; }
.btn-icon {
    width: 36px; height: 36px;
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    color: var(--text-secondary);
    transition: background .2s, color .2s;
}
.btn-icon:hover { background: var(--surface-active); color: var(--primary); }
.btn-icon svg { width: 18px; height: 18px; }

.topbar-brand { display: flex; align-items: center; gap: 10px; }
.topbar-brand-name {
    font-size: 15px; font-weight: 700;
    background: linear-gradient(135deg, var(--primary-dark), var(--primary), #818CF8);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.4px;
    direction: ltr;
    white-space: nowrap;
}
.topbar-sep {
    width: 1px; height: 20px;
    background: var(--border);
    flex-shrink: 0;
    margin: 0 2px;
}

/* ═══════════════════════════════════════════
   4. LAYOUT
   ═══════════════════════════════════════════ */
.app { max-width: 1260px; margin: 0 auto; padding: 24px 20px 60px; }

.hero {
    text-align: center; padding: 32px 0 8px;
    animation: fadeUp .6s ease-out;
}
.hero h1 {
    font-size: clamp(1.8rem, 4vw, 2.6rem);
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary-dark), var(--primary), #818CF8);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
    margin-bottom: 8px;
}
.hero p { color: var(--text-secondary); font-size: 1.05rem; font-weight: 400; }

.dashboard {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
    margin-top: 24px;
}
@media (min-width: 1024px) {
    .dashboard {
        grid-template-columns: 1fr 340px;
        align-items: start;
    }
    .dashboard-side {
        position: sticky; top: calc(var(--topbar-h) + 16px);
    }
}

/* ═══════════════════════════════════════════
   5. INPUT SECTION
   ═══════════════════════════════════════════ */
.input-card {
    background: var(--surface);
    border-radius: var(--radius-xl);
    padding: 24px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 16px;
    animation: fadeUp .6s ease-out .1s both;
}
.input-card > input[type="text"] {
    width: 100%; padding: 14px 18px;
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 1.1rem; font-weight: 500;
    transition: border-color .2s, box-shadow .2s;
    background: var(--bg);
}
.input-card > input[type="text"]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-glow);
    background: var(--surface);
}
.input-card > input[type="text"]::placeholder { color: var(--text-muted); font-weight: 400; }

.controls-row {
    display: flex; flex-wrap: wrap; gap: 12px;
    align-items: center; justify-content: space-between;
}

.mode-tabs {
    display: inline-flex;
    background: var(--bg);
    border-radius: var(--radius-pill);
    padding: 4px;
    gap: 2px;
}
.mode-tab {
    padding: 8px 20px;
    border-radius: var(--radius-pill);
    font-size: 14px; font-weight: 500;
    color: var(--text-secondary);
    transition: all .25s;
}
.mode-tab:hover { color: var(--text); }
.mode-tab.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 2px 8px var(--primary-glow);
}

.toolbar {
    display: flex; flex-wrap: wrap; gap: 8px;
    align-items: center;
}
.tool-btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 14px;
    border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg);
    border: 1px solid transparent;
    transition: all .2s;
}
.tool-btn svg { width: 15px; height: 15px; }
.tool-btn:hover { background: var(--surface-active); color: var(--text); border-color: var(--border); }
.tool-btn.primary { background: var(--primary-bg); color: var(--primary); }
.tool-btn.primary:hover { background: var(--primary); color: white; }
.tool-btn.danger { background: var(--danger-bg); color: var(--danger); }
.tool-btn.danger:hover { background: var(--danger); color: white; }

.advanced-toggle {
    display: flex; align-items: center; gap: 10px;
    font-size: 13px; color: var(--text-secondary);
    padding-top: 4px;
}
.toggle-switch {
    position: relative; width: 40px; height: 22px;
    background: var(--border); border-radius: 11px;
    cursor: pointer; transition: background .3s;
    flex-shrink: 0;
}
.toggle-switch.active { background: var(--primary); }
.toggle-switch::after {
    content: '';
    position: absolute; top: 3px; right: 3px;
    width: 16px; height: 16px;
    background: white; border-radius: 50%;
    box-shadow: var(--shadow-xs);
    transition: transform .3s;
}
.toggle-switch.active::after { transform: translateX(-18px); }

/* ═══════════════════════════════════════════
   6. PROGRESS BAR
   ═══════════════════════════════════════════ */
.progress-card {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 16px 20px;
    box-shadow: var(--shadow-xs);
    border: 1px solid var(--border);
    margin-bottom: 8px;
    animation: fadeUp .6s ease-out .15s both;
}
.progress-head {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px;
}
.progress-head h3 { font-size: 14px; font-weight: 600; color: var(--text); }
.progress-head span { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
.progress-track {
    height: 8px; background: var(--bg);
    border-radius: 4px; overflow: hidden;
}
.progress-fill {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--primary), #818CF8);
    border-radius: 4px;
    transition: width .5s cubic-bezier(.4,0,.2,1);
}

/* ═══════════════════════════════════════════
   7. CATEGORIES
   ═══════════════════════════════════════════ */
.category { margin-bottom: 20px; }
.category-head {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 18px;
    background: var(--surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all .2s;
    user-select: none;
}
.category-head:hover { border-color: var(--primary-light); box-shadow: var(--shadow-xs); }
.cat-icon {
    width: 36px; height: 36px;
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
}
.cat-icon.profit { background: #DBEAFE; color: #2563EB; }
.cat-icon.growth { background: #D1FAE5; color: #059669; }
.cat-icon.value  { background: #FEF3C7; color: #D97706; }
.cat-icon.stable { background: #E0E7FF; color: #4338CA; }
.cat-icon.custom { background: #F3E8FF; color: #7C3AED; }
.cat-title { flex:1; font-weight: 600; font-size: 15px; color: var(--text); }
.cat-badge {
    font-size: 12px; font-weight: 500;
    padding: 3px 10px;
    border-radius: var(--radius-pill);
    background: var(--bg);
    color: var(--text-secondary);
}
.cat-chevron {
    width: 20px; height: 20px;
    color: var(--text-muted);
    transition: transform .3s;
    flex-shrink: 0;
}
.cat-chevron.collapsed { transform: rotate(-90deg); }

.category-body {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    margin-top: 12px;
    padding: 4px 2px;
    max-height: 3000px;
    overflow: hidden;
    opacity: 1;
    transition: max-height .4s ease, opacity .3s ease, margin-top .4s ease;
}
.category-body.collapsed {
    max-height: 0; opacity: 0; margin-top: 0;
    pointer-events: none;
}

/* ═══════════════════════════════════════════
   8. METRIC CARDS
   ═══════════════════════════════════════════ */
.metric-card {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 20px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-xs);
    display: flex; flex-direction: column; gap: 12px;
    transition: transform .25s, box-shadow .25s, border-color .25s;
    position: relative;
    animation: fadeUp .4s ease-out both;
}
.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary-light);
}
.metric-head {
    display: flex; justify-content: space-between; align-items: flex-start;
}
.metric-head h3 {
    font-size: 14px; font-weight: 600; color: var(--text);
    line-height: 1.4;
}
.info-btn {
    width: 24px; height: 24px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; color: var(--text-muted);
    transition: all .2s; flex-shrink: 0;
}
.info-btn:hover { background: var(--primary-bg); color: var(--primary); }
.metric-desc {
    font-size: 12.5px; color: var(--text-secondary);
    line-height: 1.5; margin-top: -4px;
}
.metric-input-area { display: flex; flex-direction: column; gap: 8px; }
.metric-input-row {
    display: flex; align-items: center; gap: 8px;
}
.metric-input-row label {
    font-size: 13px; color: var(--text-secondary);
    min-width: 55px; flex-shrink: 0;
}
.metric-input-row input[type="number"] {
    flex: 1; padding: 10px 12px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 15px; font-weight: 500;
    direction: ltr; text-align: left;
    transition: all .2s;
    background: var(--bg);
    min-width: 0;
}
.metric-input-row input[type="number"]:focus {
    outline: none; border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
    background: var(--surface);
}
.metric-input-row input[type="number"].pass {
    border-color: var(--success); background: var(--success-bg);
}
.metric-input-row input[type="number"].fail {
    border-color: var(--danger); background: var(--danger-bg);
}
.metric-input-row .unit {
    font-size: 13px; color: var(--text-muted); font-weight: 500;
    flex-shrink: 0;
}
@keyframes inputHighlight {
    from { background: var(--primary-light); }
    to { background: var(--bg); }
}
.input-highlighted { animation: inputHighlight .8s ease-out; }

.metric-bar-row {
    display: flex; align-items: center; gap: 10px;
}
.metric-bar {
    flex: 1; height: 6px;
    background: var(--bg-subtle);
    border-radius: 3px; overflow: hidden;
}
.metric-bar-fill {
    height: 100%; width: 0%;
    border-radius: 3px;
    background: var(--text-muted);
    transition: width .5s cubic-bezier(.4,0,.2,1), background .3s;
}
.metric-bar-score {
    font-size: 12px; font-weight: 600; color: var(--text-muted);
    min-width: 32px; text-align: left; direction: ltr;
}

.metric-footer {
    display: flex; justify-content: space-between; align-items: center;
    padding-top: 4px;
    border-top: 1px solid var(--bg-subtle);
}
.metric-threshold {
    font-size: 12px; color: var(--text-muted); font-weight: 500;
}
.metric-threshold .custom-tag {
    color: var(--warning); font-size: 10px; margin-right: 4px;
}
.metric-status {
    width: 26px; height: 26px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700;
    transition: all .3s;
}
.metric-status.pass {
    background: var(--success-bg); color: var(--success);
}
.metric-status.fail {
    background: var(--danger-bg); color: var(--danger);
}
.metric-status.neutral {
    background: var(--bg); color: var(--text-muted);
}

/* Custom threshold (advanced mode) */
.custom-threshold {
    display: none;
    align-items: center; gap: 8px;
    padding: 8px 10px;
    background: var(--primary-bg);
    border-radius: var(--radius-sm);
    border: 1px dashed var(--primary-light);
    font-size: 12px;
}
.custom-threshold.visible { display: flex; }
.custom-threshold label { color: var(--primary); font-weight: 500; white-space: nowrap; }
.custom-threshold input {
    width: 65px; padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius-xs);
    font-size: 13px; direction: ltr; text-align: left;
}
.custom-threshold input:focus {
    outline: none; border-color: var(--primary);
    box-shadow: 0 0 0 2px var(--primary-glow);
}
.custom-threshold button {
    color: var(--primary); padding: 2px;
    font-size: 16px; line-height: 1;
}
.custom-threshold button:hover { color: var(--primary-dark); }

/* Delete btn for custom metrics */
.delete-metric-btn {
    position: absolute; top: 10px; left: 10px;
    width: 26px; height: 26px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: var(--danger); opacity: 0;
    transition: opacity .2s, background .2s;
    font-size: 15px;
}
.metric-card:hover .delete-metric-btn { opacity: 1; }
.delete-metric-btn:hover { background: var(--danger-bg); }

/* ═══════════════════════════════════════════
   9. SCORE PANEL (Sidebar)
   ═══════════════════════════════════════════ */
.score-card {
    background: var(--surface);
    border-radius: var(--radius-xl);
    padding: 28px 24px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    display: flex; flex-direction: column; align-items: center;
    gap: 16px;
    animation: fadeUp .6s ease-out .2s both;
}
.score-card-title {
    font-size: 16px; font-weight: 700; color: var(--text);
    letter-spacing: -0.3px;
}
.gauge-wrap {
    width: 100%; max-width: 260px;
    position: relative;
}
.gauge-svg { width: 100%; height: auto; display: block; }
.gauge-svg .gauge-track {
    fill: none; stroke: var(--bg-subtle); stroke-width: 16;
    stroke-linecap: round;
}
.gauge-svg .gauge-progress {
    fill: none; stroke-width: 16; stroke-linecap: round;
    transition: stroke-dashoffset 1s cubic-bezier(.4,0,.2,1), stroke .5s;
}
.gauge-svg .gauge-score-text {
    font-family: var(--font);
    font-size: 52px; font-weight: 800;
    fill: var(--text);
    transition: fill .5s;
}
.gauge-svg .gauge-percent-text {
    font-family: var(--font);
    font-size: 20px; font-weight: 400;
    fill: var(--text-muted);
}
.gauge-svg .gauge-label-text {
    font-family: var(--font);
    font-size: 16px; font-weight: 600;
    transition: fill .5s;
}

.score-status {
    font-size: 14px; color: var(--text-secondary);
    text-align: center; min-height: 2.5em; line-height: 1.5;
}
.score-criteria {
    font-size: 13px; font-weight: 500;
    background: var(--bg);
    padding: 8px 16px;
    border-radius: var(--radius-pill);
    color: var(--text-secondary);
    text-align: center;
    width: 100%;
}

/* Radar */
.radar-wrap {
    width: 100%; margin-top: 8px;
}
.radar-title {
    font-size: 14px; font-weight: 600; color: var(--text);
    text-align: center; margin-bottom: 8px;
}
.radar-svg-container {
    width: 100%; height: 200px; position: relative;
}
.radar-svg-container svg { width: 100%; height: 100%; }
.radar-legend {
    display: flex; justify-content: center; gap: 16px;
    margin-top: 8px;
}
.radar-legend-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 12px; color: var(--text-secondary);
}
.legend-dot {
    width: 10px; height: 10px; border-radius: 3px;
}
.legend-dot.threshold { background: var(--primary-bg); border: 1px dashed var(--primary); }
.legend-dot.value { background: rgba(99,102,241,0.6); border: 1px solid var(--primary); }

.score-actions {
    display: flex; flex-direction: column; gap: 8px;
    width: 100%; margin-top: 8px;
}
.score-btn {
    width: 100%; padding: 11px 18px;
    border-radius: var(--radius-md);
    font-size: 14px; font-weight: 600;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all .2s;
}
.score-btn svg { width: 16px; height: 16px; }
.score-btn.primary {
    background: var(--primary); color: white;
    box-shadow: 0 2px 8px var(--primary-glow);
}
.score-btn.primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 4px 12px var(--primary-glow); }
.score-btn.secondary {
    background: var(--bg); color: var(--text-secondary);
    border: 1px solid var(--border);
}
.score-btn.secondary:hover { background: var(--surface-active); color: var(--text); }

/* ═══════════════════════════════════════════
   10. NOTES
   ═══════════════════════════════════════════ */
.notes-section {
    margin-top: 24px;
    animation: fadeUp .6s ease-out .3s both;
}
.notes-card {
    background: var(--surface);
    border-radius: var(--radius-xl);
    padding: 24px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-xs);
}
.notes-card h3 { font-size: 15px; font-weight: 600; margin-bottom: 10px; }
.notes-card textarea {
    width: 100%; min-height: 90px; padding: 14px;
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 14px; resize: vertical;
    background: var(--bg);
    transition: border-color .2s, box-shadow .2s;
}
.notes-card textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
    background: var(--surface);
}

/* ═══════════════════════════════════════════
   11. MODALS
   ═══════════════════════════════════════════ */
.modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(15,23,42,0.5);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 1100;
    align-items: center; justify-content: center;
    opacity: 0; transition: opacity .25s;
}
.modal-overlay.open { display: flex; opacity: 1; }
.modal-box {
    background: var(--surface);
    border-radius: var(--radius-xl);
    padding: 28px;
    width: 92%; max-width: 700px; max-height: 88vh;
    overflow-y: auto; position: relative;
    box-shadow: var(--shadow-xl);
    transform: scale(.96) translateY(8px);
    transition: transform .3s;
}
.modal-overlay.open .modal-box { transform: scale(1) translateY(0); }
.modal-close {
    position: absolute; top: 16px; left: 16px;
    width: 32px; height: 32px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; color: var(--text-muted);
    transition: all .2s;
}
.modal-close:hover { background: var(--bg); color: var(--text); }
.modal-header {
    text-align: center; margin-bottom: 20px;
    padding-bottom: 16px; border-bottom: 1px solid var(--border);
}
.modal-header h2 {
    font-size: 1.3rem; font-weight: 700; margin-bottom: 4px;
    word-wrap: break-word;
}
.modal-header p { font-size: 14px; color: var(--text-secondary); }

/* Tab system */
.modal-tabs {
    display: flex; border-bottom: 2px solid var(--border);
    margin-bottom: 20px; overflow-x: auto; gap: 0;
}
.modal-tab {
    padding: 10px 18px;
    font-size: 13px; font-weight: 500;
    color: var(--text-muted);
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    white-space: nowrap;
    transition: all .2s;
}
.modal-tab:hover { color: var(--text); }
.modal-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Term items */
.term-item {
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--bg);
}
.term-item:last-child { border-bottom: none; }
.term-name {
    font-size: 15px; font-weight: 600; color: var(--text);
    margin-bottom: 4px;
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 8px;
}
.term-formula {
    font-size: 12px; font-weight: 400;
    color: var(--text-muted);
    direction: ltr; text-align: left;
}
.term-desc {
    font-size: 13.5px; color: var(--text-secondary);
    line-height: 1.7;
}

/* Template metrics */
.template-btns {
    display: flex; flex-wrap: wrap; gap: 6px;
    margin-bottom: 16px; padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
}
.template-btn {
    padding: 7px 14px;
    border-radius: var(--radius-pill);
    font-size: 13px; font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg);
    transition: all .2s;
}
.template-btn:hover { color: var(--text); background: var(--surface-active); }
.template-btn.active { background: var(--primary); color: white; }
.template-desc {
    font-size: 13px; color: var(--text-secondary); line-height: 1.6;
    padding: 12px 16px;
    background: var(--bg);
    border-radius: var(--radius-md);
    margin-bottom: 16px;
}
.template-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px; max-height: 300px; overflow-y: auto; padding: 4px;
}
.template-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
}
.template-item-name { font-size: 12.5px; font-weight: 500; color: var(--text); }
.template-item-val { font-size: 13px; font-weight: 600; color: var(--primary); direction: ltr; }

/* Summary metrics */
.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
    gap: 12px;
}
.summary-item {
    background: var(--bg);
    padding: 12px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
}
.summary-item-name { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
.summary-item-value {
    font-size: 14px; font-weight: 600; color: var(--text);
    display: flex; align-items: center; gap: 6px;
}

/* History list */
.history-list { max-height: 400px; overflow-y: auto; }
.history-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 14px 8px;
    border-bottom: 1px solid var(--bg);
    transition: background .2s;
}
.history-item:hover { background: var(--surface-hover); }
.history-name { font-weight: 600; font-size: 14px; }
.history-date { font-size: 12px; color: var(--text-muted); }
.history-actions { display: flex; gap: 8px; }
.history-actions button { font-size: 12px; }
.no-history { text-align: center; padding: 40px 20px; color: var(--text-muted); }

/* Custom metric form */
.form-group { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
.form-group label { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
.form-group input, .form-group select, .form-group textarea {
    padding: 10px 12px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 14px;
    transition: border-color .2s;
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none; border-color: var(--primary);
}
.form-group input[type="number"] { direction: ltr; text-align: left; }
.form-group textarea { min-height: 60px; resize: vertical; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-weights { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
.form-weights .form-group { flex: 1; min-width: 70px; margin-bottom: 0; }

/* ═══════════════════════════════════════════
   12. TOAST
   ═══════════════════════════════════════════ */
.toast-container {
    position: fixed; bottom: 20px; left: 20px;
    z-index: 10000;
    display: flex; flex-direction: column-reverse; gap: 8px;
}
.toast {
    padding: 12px 20px;
    border-radius: var(--radius-md);
    font-size: 13px; font-weight: 500;
    color: white;
    box-shadow: var(--shadow-lg);
    display: flex; align-items: center; gap: 8px;
    min-width: 220px; max-width: 340px;
    opacity: 0; transform: translateX(-100%);
    transition: opacity .3s, transform .3s;
}
.toast.show { opacity: 1; transform: translateX(0); }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.warning { background: var(--warning); color: var(--text); }
.toast svg { width: 16px; height: 16px; flex-shrink: 0; }

/* ═══════════════════════════════════════════
   12.32 DEEP-DIVE TABS FIX & ENHANCEMENTS
   ═══════════════════════════════════════════ */

/* Primary tabs styling handled in section 12.34 and main fix section */

/* ═══════════════════════════════════════════
   12.33 DUAL COMPANY COMPARISON MODE
   ═══════════════════════════════════════════ */
.company-tabs-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, var(--primary-bg) 0%, #E0E7FF 100%);
    border-radius: var(--radius-lg);
    margin-bottom: 20px;
    border: 1px solid var(--primary-light);
}
.company-tab {
    flex: 1;
    max-width: 280px;
    padding: 10px 16px;
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: all .2s;
}
.company-tab:hover {
    border-color: var(--primary-light);
}
.company-tab.active {
    border-color: var(--primary);
    background: white;
    box-shadow: var(--shadow-sm);
}
.company-tab .ct-icon {
    width: 32px;
    height: 32px;
    background: var(--bg);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}
.company-tab.active .ct-icon {
    background: var(--primary);
    color: white;
}
.company-tab .ct-info { flex: 1; min-width: 0; }
.company-tab .ct-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.company-tab .ct-score {
    font-size: 11px;
    color: var(--text-muted);
}
.company-tab .ct-edit {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: var(--text-muted);
    transition: all .2s;
}
.company-tab .ct-edit:hover {
    background: var(--bg);
    color: var(--text);
}
.company-add-btn {
    padding: 10px 16px;
    background: var(--surface);
    border: 2px dashed var(--border);
    border-radius: var(--radius-md);
    color: var(--text-muted);
    font-size: 12px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all .2s;
}
.company-add-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: var(--primary-bg);
}
.company-compare-toggle {
    margin-right: auto;
    padding: 8px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all .2s;
}
.company-compare-toggle:hover {
    border-color: var(--primary);
    color: var(--primary);
}
.company-compare-toggle.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

/* ═══════════════════════════════════════════
   12.34 INFOGRAPHICS GALLERY MODAL
   ═══════════════════════════════════════════ */
.infographics-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 1300;
    align-items: flex-start;
    justify-content: center;
    padding: 40px 20px;
    overflow-y: auto;
}
.infographics-modal.open { display: flex; }
.infographics-container {
    background: var(--surface);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 1100px;
    box-shadow: var(--shadow-xl);
    overflow: hidden;
}
.infographics-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, var(--primary-bg) 0%, var(--surface) 100%);
}
.infographics-header h2 {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
}
.infographics-close {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: var(--text-muted);
    transition: all .2s;
}
.infographics-close:hover {
    background: var(--bg);
    color: var(--text);
}
.infographics-body {
    padding: 24px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    max-height: 75vh;
    overflow-y: auto;
}
.infographic-card {
    background: var(--bg);
    border-radius: var(--radius-lg);
    padding: 20px;
    border: 1px solid var(--border);
}
.infographic-card h3 {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ═══════════════════════════════════════════
   12.35 AI PROMPT MODAL
   ═══════════════════════════════════════════ */
.ai-prompt-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 1300;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.ai-prompt-modal.open { display: flex; }
.ai-prompt-box {
    background: var(--surface);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-xl);
}
.ai-prompt-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #FEF3C7 0%, #FFFBEB 100%);
}
.ai-prompt-header h2 {
    font-size: 1.1rem;
    font-weight: 700;
    color: #92400E;
    display: flex;
    align-items: center;
    gap: 10px;
}
.ai-prompt-close {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: #92400E;
    transition: all .2s;
}
.ai-prompt-close:hover { background: rgba(0,0,0,0.05); }
.ai-prompt-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
}
.ai-prompt-intro {
    background: var(--bg);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-bottom: 20px;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.7;
}
.ai-prompt-intro strong { color: var(--text); }
.ai-prompt-textarea {
    width: 100%;
    min-height: 300px;
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.6;
    resize: vertical;
    direction: ltr;
    text-align: left;
    background: #1E1B4B;
    color: #E0E7FF;
}
.ai-prompt-textarea:focus {
    outline: none;
    border-color: var(--primary);
}
.ai-prompt-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    background: var(--bg);
}
.ai-prompt-footer .apf-hint {
    font-size: 11px;
    color: var(--text-muted);
}
.ai-prompt-copy-btn {
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all .2s;
}
.ai-prompt-copy-btn:hover {
    background: var(--primary-hover);
}

/* ═══════════════════════════════════════════
   12.36 COMPARISON VIEW
   ═══════════════════════════════════════════ */
.comparison-view {
    display: none;
    background: var(--surface);
    border-radius: var(--radius-xl);
    border: 1px solid var(--border);
    padding: 24px;
    margin-bottom: 24px;
}
.comparison-view.visible { display: block; }
.comparison-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}
.comparison-header h3 {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 10px;
}
.comparison-close {
    padding: 6px 12px;
    font-size: 12px;
    color: var(--text-muted);
    border-radius: var(--radius-sm);
    transition: all .2s;
}
.comparison-close:hover {
    background: var(--bg);
    color: var(--text);
}
.comparison-grid {
    display: grid;
    grid-template-columns: 200px 1fr 1fr;
    gap: 1px;
    background: var(--border);
    border-radius: var(--radius-md);
    overflow: hidden;
}
.comparison-grid > div {
    padding: 12px 16px;
    background: var(--surface);
}
.cg-header {
    background: var(--bg) !important;
    font-size: 12px;
    font-weight: 700;
    color: var(--text);
    text-align: center;
}
.cg-metric {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
}
.cg-value {
    text-align: center;
    font-size: 14px;
    font-weight: 600;
}
.cg-value.better {
    color: var(--success);
    background: var(--success-bg) !important;
}
.cg-value.worse {
    color: var(--danger);
    background: var(--danger-bg) !important;
}
.cg-value.equal {
    color: var(--text-muted);
}

/* ═══════════════════════════════════════════
   12.37 TOOLBAR ENHANCEMENTS
   ═══════════════════════════════════════════ */
.toolbar-section {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
    border: 1px solid var(--border);
}
.toolbar-btn {
    padding: 8px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all .2s;
    cursor: pointer;
}
.toolbar-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: var(--primary-bg);
}
.toolbar-btn.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}
.toolbar-divider {
    width: 1px;
    background: var(--border);
    margin: 0 4px;
}

@media (max-width: 768px) {
    .company-tabs-bar { flex-wrap: wrap; }
    .company-tab { max-width: 100%; }
    .infographics-body { grid-template-columns: 1fr; }
    .comparison-grid { grid-template-columns: 1fr; }
    .comparison-grid .cg-header:first-child { display: none; }
    .toolbar-section { justify-content: center; }
    .toolbar-divider { display: none; }
}


/* ═══════════════════════════════════════════
   12.35 ENHANCED DEEP-DIVE VISUALS (Long Equity Style)
   ═══════════════════════════════════════════ */

/* ── Tabs Navigation ── */
/* ═══════════════════════════════════════════
   12.34 DEEP-DIVE TAB FIXES
   ═══════════════════════════════════════════ */
.dd-tabs {
    display: flex;
    border-bottom: 2px solid var(--border);
    margin-bottom: 0;
    gap: 4px;
    overflow-x: auto;
    padding-bottom: 2px;
    position: sticky;
    top: 0;
    background: var(--surface);
    z-index: 1000;
    padding-top: 4px;
    flex-shrink: 0;
}
.dd-tab-content {
    display: none;
    position: relative;
    z-index: 1;
    padding-top: 20px;
}
.dd-tab-content.active {
    display: block;
}

/* ═══════════════════════════════════════════
   12.36 DUAL COMPANY COMPARISON
   ═══════════════════════════════════════════ */
.company-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 16px;
    background: var(--bg);
    border-radius: var(--radius-lg);
    padding: 4px;
    position: relative;
}
.company-tab {
    flex: 1;
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    text-align: center;
    border-radius: var(--radius-md);
    transition: all .25s;
    cursor: pointer;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.company-tab:hover { color: var(--text); }
.company-tab.active {
    background: var(--surface);
    color: var(--primary);
    box-shadow: var(--shadow-sm);
}
.company-tab .ct-icon { font-size: 16px; }
.company-tab .ct-name {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.company-tab .ct-score {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: var(--radius-pill);
    background: var(--primary-bg);
    color: var(--primary);
    font-weight: 700;
}
.company-tab-edit {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: var(--text-muted);
    opacity: 0;
    transition: all .2s;
}
.company-tab:hover .company-tab-edit { opacity: 1; }
.company-tab-edit:hover { background: var(--bg); color: var(--text); }

.compare-toggle-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: var(--primary-bg);
    border-radius: var(--radius-md);
    margin-bottom: 16px;
    border: 1px solid var(--primary-light);
}
.compare-toggle-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    flex: 1;
}
.compare-toggle-desc {
    font-size: 11px;
    color: var(--text-muted);
}
.compare-toggle {
    width: 48px;
    height: 26px;
    background: var(--border);
    border-radius: 13px;
    position: relative;
    cursor: pointer;
    transition: background .3s;
}
.compare-toggle.active { background: var(--primary); }
.compare-toggle::after {
    content: '';
    position: absolute;
    width: 22px;
    height: 22px;
    background: white;
    border-radius: 50%;
    top: 2px;
    right: 2px;
    transition: transform .3s;
    box-shadow: var(--shadow-sm);
}
.compare-toggle.active::after { transform: translateX(-22px); }

/* ═══════════════════════════════════════════
   12.37 INFOGRAPHICS GALLERY
   ═══════════════════════════════════════════ */
/* ═══════════════════════════════════════════
   12.38 AI PROMPT GENERATOR
   ═══════════════════════════════════════════ */
.ai-prompt-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.7);
    backdrop-filter: blur(8px);
    z-index: 1300;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.ai-prompt-modal.open { display: flex; }
.ai-prompt-box {
    background: var(--surface);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-xl);
}
.ai-prompt-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
}
.ai-prompt-header h2 {
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
}
.ai-prompt-close {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: rgba(255,255,255,0.8);
    transition: all .2s;
}
.ai-prompt-close:hover { background: rgba(255,255,255,0.2); color: white; }
.ai-prompt-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
}
.ai-prompt-section {
    margin-bottom: 20px;
}
.ai-prompt-section-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.ai-prompt-textarea {
    width: 100%;
    min-height: 200px;
    padding: 14px;
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.6;
    resize: vertical;
    background: #1E1B4B;
    color: #E0E7FF;
    direction: ltr;
    text-align: left;
}
.ai-prompt-textarea:focus {
    outline: none;
    border-color: var(--primary);
}
.ai-prompt-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.ai-prompt-btn {
    padding: 10px 18px;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all .2s;
}
.ai-prompt-btn.primary {
    background: var(--primary);
    color: white;
}
.ai-prompt-btn.primary:hover { background: var(--primary-hover); }
.ai-prompt-btn.secondary {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
}
.ai-prompt-btn.secondary:hover { background: var(--surface); border-color: var(--primary-light); }

.ai-instructions {
    background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
    border-radius: var(--radius-md);
    padding: 14px;
    border-right: 4px solid #F59E0B;
    margin-bottom: 16px;
}
.ai-instructions-title {
    font-size: 12px;
    font-weight: 700;
    color: #92400E;
    margin-bottom: 6px;
}
.ai-instructions-text {
    font-size: 12px;
    color: #78350F;
    line-height: 1.6;
}

/* ═══════════════════════════════════════════
   12.39 ENHANCED CSV EXPORT
   ═══════════════════════════════════════════ */
.csv-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.7);
    backdrop-filter: blur(8px);
    z-index: 1300;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.csv-modal.open { display: flex; }
.csv-box {
    background: var(--surface);
    border-radius: var(--radius-xl);
    width: 100%;
    max-width: 500px;
    box-shadow: var(--shadow-xl);
}
.csv-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.csv-header h2 {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
}
.csv-body {
    padding: 24px;
}
.csv-option {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px;
    background: var(--bg);
    border-radius: var(--radius-md);
    margin-bottom: 12px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all .2s;
}
.csv-option:hover { border-color: var(--primary-light); }
.csv-option-icon {
    width: 44px;
    height: 44px;
    background: var(--primary-bg);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}
.csv-option-info { flex: 1; }
.csv-option-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
}
.csv-option-desc {
    font-size: 12px;
    color: var(--text-muted);
}

/* ═══════════════════════════════════════════
   12.40 TOOLBAR BUTTON FOR INFOGRAPHICS
   ═══════════════════════════════════════════ */
.toolbar-btn-info {
    background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%) !important;
    color: white !important;
    border: none !important;
}
.toolbar-btn-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99,102,241,0.3);
}

@media (max-width: 768px) {
    .company-tabs { flex-direction: column; }
    .company-tab { padding: 10px 16px; }
    .infographics-body { grid-template-columns: 1fr; padding: 16px; }
    .ai-prompt-textarea { min-height: 150px; }
}

.dd-tab {
    padding: 10px 16px;
    font-size: 12.5px;
    font-weight: 500;
    color: var(--text-muted);
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    white-space: nowrap;
    transition: all .2s;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
}
.dd-tab:hover { color: var(--text); background: var(--bg); }
.dd-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
    font-weight: 600;
    background: var(--primary-bg);
}


/* ── Flow Diagram (Like Long Equity) ── */
.dd-flow-container {
    margin-bottom: 24px;
}
.dd-flow-question {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
    line-height: 1.4;
}
.dd-flow-row {
    display: flex;
    align-items: stretch;
    justify-content: center;
    gap: 0;
    flex-wrap: wrap;
    margin-bottom: 20px;
}
.dd-flow-box {
    flex: 1;
    min-width: 130px;
    max-width: 200px;
    background: linear-gradient(135deg, #F1F5F9 0%, #E2E8F0 100%);
    border: 2px solid #94A3B8;
    border-radius: 12px;
    padding: 14px 12px;
    text-align: center;
    position: relative;
    transition: all .3s;
}
.dd-flow-box:hover {
    border-color: var(--primary);
    background: linear-gradient(135deg, var(--primary-bg) 0%, #E0E7FF 100%);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}
.dd-flow-box .fb-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
}
.dd-flow-box .fb-desc {
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.45;
}
.dd-flow-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    flex-shrink: 0;
    color: #64748B;
    font-size: 18px;
}

/* ── Why Section Cards ── */
.dd-why-section {
    margin-bottom: 20px;
}
.dd-why-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 14px;
}
.dd-why-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 16px;
    transition: all .25s;
}
.dd-why-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}
.dd-why-card .wc-question {
    font-size: 12px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 10px;
    text-decoration: underline;
    text-underline-offset: 3px;
}
.dd-why-card .wc-answer {
    font-size: 12.5px;
    color: var(--text-secondary);
    line-height: 1.7;
}
.dd-why-card .wc-answer strong {
    color: var(--text);
    font-weight: 600;
}
.dd-why-card .wc-list {
    margin-top: 8px;
    padding-right: 16px;
}
.dd-why-card .wc-list li {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    line-height: 1.5;
}

/* ── Barriers Section (Like slide 2) ── */
.dd-barriers-section {
    margin-bottom: 24px;
}
.dd-barriers-question {
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
}
.dd-barriers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}
.dd-barrier-box {
    background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
    border: 2px solid #CBD5E1;
    border-radius: var(--radius-lg);
    padding: 16px;
    text-align: center;
    transition: all .25s;
}
.dd-barrier-box:hover {
    border-color: var(--primary-light);
    background: var(--surface);
    box-shadow: var(--shadow-sm);
}
.dd-barrier-box .bb-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
}
.dd-barrier-box .bb-subtitle {
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.4;
}
.dd-barrier-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 14px;
}
.dd-barrier-detail {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 14px;
}
.dd-barrier-detail .bd-question {
    font-size: 11px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
    text-decoration: underline;
    text-underline-offset: 2px;
}
.dd-barrier-detail .bd-answer {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 10px;
}
.dd-barrier-detail .bd-examples-title {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-decoration: underline;
    margin-bottom: 6px;
}
.dd-barrier-detail .bd-examples {
    font-size: 11.5px;
    color: var(--text-secondary);
    line-height: 1.6;
}
.dd-barrier-detail .bd-examples strong {
    color: var(--text);
    font-weight: 700;
}

/* ── Real Examples Section ── */
.dd-examples-section {
    background: linear-gradient(135deg, #1E1B4B 0%, #312E81 100%);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 20px;
}
.dd-examples-title {
    font-size: 13px;
    font-weight: 700;
    color: #C7D2FE;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.dd-examples-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
}
.dd-example-card {
    background: rgba(255,255,255,0.08);
    border-radius: var(--radius-md);
    padding: 14px;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all .2s;
}
.dd-example-card:hover {
    background: rgba(255,255,255,0.12);
    border-color: rgba(255,255,255,0.2);
    transform: translateY(-2px);
}
.dd-example-card .ec-company {
    font-size: 13px;
    font-weight: 700;
    color: white;
    margin-bottom: 2px;
}
.dd-example-card .ec-ticker {
    font-size: 10px;
    background: rgba(99,102,241,0.5);
    color: #E0E7FF;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    display: inline-block;
    margin-bottom: 8px;
}
.dd-example-card .ec-value {
    font-size: 22px;
    font-weight: 800;
    color: #6EE7B7;
    margin-bottom: 6px;
    direction: ltr;
    text-align: right;
}
.dd-example-card .ec-context {
    font-size: 11px;
    color: rgba(255,255,255,0.7);
    line-height: 1.5;
}

/* ── Key Insight Box ── */
.dd-insight-box {
    background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
    border-radius: var(--radius-lg);
    padding: 16px 18px;
    border-right: 5px solid #059669;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 20px;
}
.dd-insight-box .ib-icon {
    font-size: 24px;
    flex-shrink: 0;
}
.dd-insight-box .ib-content {
    flex: 1;
}
.dd-insight-box .ib-title {
    font-size: 13px;
    font-weight: 700;
    color: #065F46;
    margin-bottom: 4px;
}
.dd-insight-box .ib-text {
    font-size: 12.5px;
    color: #047857;
    line-height: 1.65;
}

/* ── Visual Scale Enhanced ── */
.dd-scale-enhanced {
    background: var(--bg);
    border-radius: var(--radius-lg);
    padding: 18px;
    margin-bottom: 20px;
}
.dd-scale-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-secondary);
    margin-bottom: 12px;
}
.dd-scale-bar-wrap {
    position: relative;
    margin-bottom: 8px;
}
.dd-scale-bar {
    height: 14px;
    border-radius: 7px;
    background: linear-gradient(to left, #DC2626 0%, #F97316 25%, #F59E0B 50%, #10B981 75%, #6366F1 100%);
}
.dd-scale-marker {
    position: absolute;
    top: -4px;
    width: 22px;
    height: 22px;
    background: white;
    border: 3px solid var(--text);
    border-radius: 50%;
    transform: translateX(50%);
    box-shadow: var(--shadow-md);
    transition: right .5s ease-out;
}
.dd-scale-labels {
    display: flex;
    justify-content: space-between;
    padding-top: 8px;
}
.dd-scale-label {
    text-align: center;
    font-size: 10px;
}
.dd-scale-label .sl-emoji { font-size: 14px; display: block; margin-bottom: 2px; }
.dd-scale-label .sl-text { color: var(--text-secondary); font-weight: 600; }
.dd-your-value-box {
    margin-top: 14px;
    padding-top: 12px;
    border-top: 1px dashed var(--border);
    text-align: center;
}
.dd-your-value-box .yv-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 4px;
}
.dd-your-value-box .yv-num {
    font-size: 28px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary), #818CF8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.dd-your-value-box .yv-verdict {
    font-size: 13px;
    font-weight: 600;
    margin-top: 2px;
    padding: 4px 12px;
    border-radius: var(--radius-pill);
    display: inline-block;
}

/* ── Optional Metrics Picker ── */
.optional-metrics-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    padding: 18px;
    margin-bottom: 16px;
}
.oms-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
}
.oms-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
}
.oms-subtitle {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
}
.oms-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
}
.oms-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all .2s;
}
.oms-item:hover {
    border-color: var(--primary-light);
    background: var(--primary-bg);
}
.oms-item.added {
    border-color: var(--success);
    background: var(--success-bg);
}
.oms-item .oi-icon {
    width: 36px;
    height: 36px;
    background: var(--surface);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    border: 1px solid var(--border);
}
.oms-item.added .oi-icon {
    background: var(--success);
    border-color: var(--success);
}
.oms-item.added .oi-icon::after {
    content: '✓';
    color: white;
    font-size: 16px;
    font-weight: 700;
}
.oms-item:not(.added) .oi-icon::after {
    content: attr(data-icon);
}
.oms-item .oi-info { flex: 1; min-width: 0; }
.oms-item .oi-name {
    font-size: 12.5px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
}
.oms-item .oi-desc {
    font-size: 10.5px;
    color: var(--text-muted);
    line-height: 1.4;
}
.oms-item .oi-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: var(--radius-pill);
    font-weight: 600;
}
.oms-item .oi-badge.cat-profitability { background: #DBEAFE; color: #1E40AF; }
.oms-item .oi-badge.cat-growth { background: #D1FAE5; color: #065F46; }
.oms-item .oi-badge.cat-valuation { background: #FEF3C7; color: #92400E; }
.oms-item .oi-badge.cat-stability { background: #FEE2E2; color: #991B1B; }

/* ── Responsive ── */
@media (max-width: 768px) {
    .dd-flow-row { flex-direction: column; align-items: center; gap: 8px; }
    .dd-flow-arrow { transform: rotate(90deg); width: auto; height: 24px; margin: -4px 0; }
    .dd-flow-box { max-width: 100%; min-width: 100%; }
    .dd-barriers-grid { grid-template-columns: 1fr; }
    .dd-barrier-details { grid-template-columns: 1fr; }
    .dd-why-grid { grid-template-columns: 1fr; }
    .dd-examples-grid { grid-template-columns: 1fr 1fr; }
    .dd-tabs { gap: 2px; }
    .dd-tab { padding: 8px 10px; font-size: 11px; }
    .oms-grid { grid-template-columns: 1fr; }
}
@media (max-width: 480px) {
    .dd-examples-grid { grid-template-columns: 1fr; }
}

/* ═══════════════════════════════════════════
   12.4 METRIC DEEP-DIVE MODAL
   ═══════════════════════════════════════════ */
.deepdive-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.6);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 1200;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity .3s;
}
.deepdive-modal.open { display: flex; opacity: 1; }
.deepdive-box {
    background: var(--surface);
    border-radius: var(--radius-xl);
    width: 94%;
    max-width: 720px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-xl);
    transform: scale(0.96) translateY(12px);
    transition: transform .35s cubic-bezier(.4,0,.2,1);
}
.deepdive-modal.open .deepdive-box { transform: scale(1) translateY(0); }

.deepdive-header {
    padding: 24px 28px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    gap: 16px;
    position: relative;
    background: linear-gradient(135deg, var(--primary-bg) 0%, var(--surface) 100%);
}
.deepdive-header-icon {
    width: 52px; height: 52px;
    background: linear-gradient(135deg, var(--primary), #818CF8);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
    box-shadow: 0 4px 12px var(--primary-glow);
}
.deepdive-header-text { flex: 1; min-width: 0; }
.deepdive-header h2 {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
    line-height: 1.3;
}
.deepdive-header-cat {
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
    background: var(--primary-bg);
    padding: 3px 10px;
    border-radius: var(--radius-pill);
    display: inline-block;
}
.deepdive-close {
    position: absolute;
    top: 16px; left: 16px;
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    color: var(--text-muted);
    transition: all .2s;
}
.deepdive-close:hover { background: var(--bg); color: var(--text); }

.deepdive-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px 28px 28px;
    display: flex;
    flex-direction: column;
    gap: 24px;
}

/* ── Formula Section ── */
.dd-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.dd-section-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-secondary);
    letter-spacing: 0.3px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.dd-section-title::before {
    content: '';
    width: 4px; height: 4px;
    background: var(--primary);
    border-radius: 50%;
}

.dd-formula-box {
    background: linear-gradient(135deg, #1E1B4B 0%, #312E81 100%);
    border-radius: var(--radius-lg);
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}
.dd-formula-main {
    font-size: 1.4rem;
    font-weight: 600;
    color: white;
    direction: ltr;
    text-align: center;
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
}
.dd-formula-main .fm-num { color: #A5B4FC; }
.dd-formula-main .fm-den { color: #C4B5FD; }
.dd-formula-main .fm-op { color: #6EE7B7; margin: 0 6px; }
.dd-formula-parts {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
}
.dd-formula-part {
    background: rgba(255,255,255,0.1);
    border-radius: var(--radius-sm);
    padding: 8px 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}
.dd-formula-part .fp-symbol {
    font-size: 13px;
    font-weight: 700;
    color: #A5B4FC;
    direction: ltr;
}
.dd-formula-part .fp-meaning {
    font-size: 11px;
    color: rgba(255,255,255,0.7);
    text-align: center;
}

/* ── Interpretation Scale ── */
.dd-scale-wrap {
    background: var(--bg);
    border-radius: var(--radius-lg);
    padding: 20px;
}
.dd-scale-bar {
    height: 12px;
    border-radius: 6px;
    background: linear-gradient(to left, #DC2626 0%, #F59E0B 33%, #10B981 66%, #6366F1 100%);
    position: relative;
    margin-bottom: 8px;
}
.dd-scale-marker {
    position: absolute;
    top: -6px;
    width: 24px; height: 24px;
    background: white;
    border: 3px solid var(--text);
    border-radius: 50%;
    transform: translateX(50%);
    box-shadow: var(--shadow-md);
    transition: right .6s cubic-bezier(.4,0,.2,1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 800;
}
.dd-scale-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 12px;
}
.dd-scale-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}
.dd-scale-label .sl-emoji { font-size: 16px; }
.dd-scale-label .sl-text {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-secondary);
}
.dd-scale-label .sl-range {
    font-size: 9px;
    color: var(--text-muted);
    direction: ltr;
}
.dd-your-value {
    text-align: center;
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px dashed var(--border);
}
.dd-your-value .yv-label {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 4px;
}
.dd-your-value .yv-num {
    font-size: 1.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary), #818CF8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.dd-your-value .yv-verdict {
    font-size: 13px;
    font-weight: 600;
    margin-top: 4px;
}

/* ── Analogy Card ── */
.dd-analogy {
    background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
    border-radius: var(--radius-lg);
    padding: 18px 20px;
    border-right: 4px solid #F59E0B;
}
.dd-analogy-title {
    font-size: 13px;
    font-weight: 700;
    color: #92400E;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.dd-analogy-text {
    font-size: 14px;
    color: #78350F;
    line-height: 1.7;
}

/* ── Pitfalls Card ── */
.dd-pitfalls {
    background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
    border-radius: var(--radius-lg);
    padding: 18px 20px;
    border-right: 4px solid #DC2626;
}
.dd-pitfalls-title {
    font-size: 13px;
    font-weight: 700;
    color: #991B1B;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.dd-pitfall-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 8px;
}
.dd-pitfall-item:last-child { margin-bottom: 0; }
.dd-pitfall-item .pi-icon {
    flex-shrink: 0;
    width: 18px; height: 18px;
    background: #DC2626;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    margin-top: 2px;
}
.dd-pitfall-item .pi-text {
    font-size: 13px;
    color: #7F1D1D;
    line-height: 1.6;
}

/* ── Related Metrics ── */
.dd-related {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.dd-related-item {
    flex: 1;
    min-width: 140px;
    background: var(--bg);
    border-radius: var(--radius-md);
    padding: 14px 16px;
    border: 1px solid var(--border);
    transition: all .2s;
    cursor: pointer;
}
.dd-related-item:hover {
    border-color: var(--primary-light);
    background: var(--primary-bg);
    transform: translateY(-2px);
}
.dd-related-item .ri-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
}
.dd-related-item .ri-relation {
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.5;
}
.dd-related-item .ri-arrow {
    font-size: 10px;
    color: var(--primary);
    margin-top: 6px;
    display: block;
}

/* ═══════════════════════════════════════════
   12.45 METRIC INTERPRETATION PANEL
   ═══════════════════════════════════════════ */
.metric-interpretation {
    display: none;
    margin-top: 8px;
    padding: 14px 16px;
    background: linear-gradient(135deg, var(--primary-bg) 0%, #F8FAFF 100%);
    border-radius: var(--radius-md);
    border: 1px solid var(--primary-light);
    border-right: 4px solid var(--primary);
    animation: interpFadeIn .4s ease-out;
}
.metric-interpretation.visible { display: block; }
@keyframes interpFadeIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
}
.interp-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}
.interp-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--primary-dark);
    display: flex;
    align-items: center;
    gap: 6px;
}
.interp-title svg { width: 14px; height: 14px; }
.interp-toggle {
    font-size: 11px;
    color: var(--text-muted);
    padding: 2px 8px;
    border-radius: var(--radius-pill);
    transition: all .2s;
}
.interp-toggle:hover { background: var(--surface); color: var(--text); }
.interp-body {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.75;
}
.interp-body strong {
    color: var(--text);
    font-weight: 600;
}
.interp-verdict {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    border-radius: var(--radius-pill);
    font-size: 11px;
    font-weight: 600;
    margin-left: 4px;
}
.interp-verdict.excellent { background: #DBEAFE; color: #1E40AF; }
.interp-verdict.good { background: #D1FAE5; color: #065F46; }
.interp-verdict.average { background: #FEF3C7; color: #92400E; }
.interp-verdict.poor { background: #FEE2E2; color: #991B1B; }
.interp-questions {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px dashed var(--primary-light);
}
.interp-questions-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 6px;
}
.interp-question {
    font-size: 12px;
    color: var(--text-secondary);
    padding-right: 14px;
    position: relative;
    margin-bottom: 4px;
    line-height: 1.5;
}
.interp-question::before {
    content: '?';
    position: absolute;
    right: 0;
    color: var(--primary);
    font-weight: 700;
}
.interp-xref {
    margin-top: 10px;
    padding: 8px 12px;
    background: var(--surface);
    border-radius: var(--radius-sm);
    font-size: 12px;
    color: var(--text-secondary);
    border: 1px solid var(--border);
}
.interp-xref strong { color: var(--text); }

/* ── Deep-dive Responsive ── */
@media (max-width: 768px) {
    .deepdive-box { width: 98%; max-height: 95vh; }
    .deepdive-header { padding: 20px; gap: 12px; }
    .deepdive-header-icon { width: 44px; height: 44px; font-size: 20px; }
    .deepdive-header h2 { font-size: 1.1rem; }
    .deepdive-content { padding: 20px; gap: 20px; }
    .dd-formula-main { font-size: 1.1rem; }
    .dd-formula-parts { gap: 6px; }
    .dd-formula-part { padding: 6px 10px; }
    .dd-related { flex-direction: column; }
    .dd-related-item { min-width: 100%; }
    .metric-interpretation { padding: 12px 14px; }
}

/* ═══════════════════════════════════════════
   12.5 INSIGHTS PANEL
   ═══════════════════════════════════════════ */
.insights-section {
    margin-top: 32px;
    animation: fadeUp .6s ease-out .35s both;
}
.insights-card {
    background: var(--surface);
    border-radius: var(--radius-xl);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    position: relative;
}
.insights-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, #EF4444, #F59E0B, #6366F1, #059669);
    opacity: 0.85;
}

.insights-header {
    padding: 24px 28px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}
.insights-header-right {
    display: flex;
    align-items: center;
    gap: 14px;
}
.insights-header-icon {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, #1E1B4B, #312E81);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.insights-header-icon svg { width: 22px; height: 22px; color: #A5B4FC; }
.insights-header h2 {
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.3px;
}
.insights-header-subtitle {
    font-size: 12.5px;
    color: var(--text-secondary);
    margin-top: 1px;
}
.insights-toggle-btn {
    padding: 7px 16px;
    border-radius: var(--radius-pill);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    background: var(--bg);
    border: 1px solid var(--border);
    transition: all .2s;
}
.insights-toggle-btn:hover {
    background: var(--surface-active);
    color: var(--text);
    border-color: var(--border-hover);
}

.insights-body {
    padding: 0 28px 28px;
}
.insights-body.collapsed { display: none; }

.insights-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
    font-size: 13.5px;
}
.insights-empty svg {
    width: 48px;
    height: 48px;
    color: var(--border);
    margin-bottom: 12px;
    display: inline-block;
}

#insights-content {
    display: none;
}
#insights-content.active {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

/* ── Category Rings ── */
.insights-rings {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
}
.ring-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px 8px 14px;
    background: var(--bg);
    border-radius: var(--radius-lg);
    border: 1px solid transparent;
    transition: all .25s;
}
.ring-item:hover {
    border-color: var(--border-hover);
    background: var(--surface-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-xs);
}
.ring-svg { width: 68px; height: 68px; }
.ring-svg circle {
    transition: stroke-dashoffset .8s cubic-bezier(.4,0,.2,1), stroke .5s;
}
.ring-label {
    font-size: 12.5px;
    font-weight: 600;
    color: var(--text);
    text-align: center;
}
.ring-score {
    font-size: 11px;
    color: var(--text-muted);
}

/* ── Heatmap ── */
.insights-heatmap {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.heatmap-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
}
.heatmap-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}
.heatmap-cell {
    width: 54px;
    height: 54px;
    border-radius: var(--radius-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: default;
    transition: transform .2s, box-shadow .2s;
    position: relative;
}
.heatmap-cell:hover {
    transform: scale(1.14);
    box-shadow: var(--shadow-md);
    z-index: 5;
}
.heatmap-cell .hm-abbr {
    font-size: 10px;
    font-weight: 700;
    opacity: 0.95;
    line-height: 1;
}
.heatmap-cell .hm-score {
    font-size: 9px;
    font-weight: 500;
    opacity: 0.75;
    margin-top: 2px;
}
.heatmap-cell.hm-empty {
    background: var(--bg-subtle);
    color: var(--text-muted);
    border: 1.5px dashed var(--border);
}
.heatmap-cell.hm-filled {
    color: white;
    box-shadow: var(--shadow-xs);
}

/* ── Severity Summary ── */
.severity-summary {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.severity-badge {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 7px 14px;
    border-radius: var(--radius-pill);
    font-size: 12.5px;
    font-weight: 600;
    transition: transform .15s;
}
.severity-badge:hover { transform: scale(1.04); }
.severity-badge .sev-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}
.severity-badge.sev-critical {
    background: #FEF2F2;
    color: #B91C1C;
    border: 1px solid #FECACA;
}
.severity-badge.sev-critical .sev-dot {
    background: #DC2626;
    animation: sevPulse 1.5s ease-in-out infinite;
}
.severity-badge.sev-warning {
    background: #FFFBEB;
    color: #92400E;
    border: 1px solid #FDE68A;
}
.severity-badge.sev-warning .sev-dot { background: #D97706; }
.severity-badge.sev-positive {
    background: #ECFDF5;
    color: #065F46;
    border: 1px solid #A7F3D0;
}
.severity-badge.sev-positive .sev-dot { background: #059669; }
.severity-badge.sev-info {
    background: #EEF2FF;
    color: #3730A3;
    border: 1px solid #C7D2FE;
}
.severity-badge.sev-info .sev-dot { background: #6366F1; }

@keyframes sevPulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(1.5); }
}

/* ── Insight Groups ── */
.insight-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.insight-group-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--bg-subtle);
}
.insight-group-title .igt-icon {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    color: white;
    flex-shrink: 0;
}
.igt-icon.critical { background: var(--danger); }
.igt-icon.warning { background: var(--warning); }
.igt-icon.positive { background: var(--success); }
.igt-icon.info { background: var(--primary); }

/* ── Individual Insight Card ── */
.insight-item {
    display: flex;
    gap: 14px;
    padding: 14px 16px;
    border-radius: var(--radius-md);
    border-right: 4px solid transparent;
    transition: all .2s;
    cursor: default;
}
.insight-item:hover {
    transform: translateX(-3px);
}
.insight-item.sev-critical {
    border-right-color: #DC2626;
    background: linear-gradient(to left, #FEF2F2 0%, var(--bg) 80%);
}
.insight-item.sev-critical:hover { background: linear-gradient(to left, #FEE2E2 0%, var(--surface-hover) 80%); }
.insight-item.sev-warning {
    border-right-color: #D97706;
    background: linear-gradient(to left, #FFFBEB 0%, var(--bg) 80%);
}
.insight-item.sev-warning:hover { background: linear-gradient(to left, #FEF3C7 0%, var(--surface-hover) 80%); }
.insight-item.sev-positive {
    border-right-color: #059669;
    background: linear-gradient(to left, #ECFDF5 0%, var(--bg) 80%);
}
.insight-item.sev-positive:hover { background: linear-gradient(to left, #D1FAE5 0%, var(--surface-hover) 80%); }
.insight-item.sev-info {
    border-right-color: #6366F1;
    background: linear-gradient(to left, #EEF2FF 0%, var(--bg) 80%);
}
.insight-item.sev-info:hover { background: linear-gradient(to left, #E0E7FF 0%, var(--surface-hover) 80%); }

.insight-icon {
    width: 38px;
    height: 38px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 17px;
}
.insight-icon.critical { background: #FEE2E2; }
.insight-icon.warning { background: #FEF3C7; }
.insight-icon.positive { background: #D1FAE5; }
.insight-icon.info { background: #E0E7FF; }

.insight-content { flex: 1; min-width: 0; }
.insight-title {
    font-size: 13.5px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 3px;
    line-height: 1.4;
}
.insight-desc {
    font-size: 12.5px;
    color: var(--text-secondary);
    line-height: 1.65;
}
.insight-metrics {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
}
.insight-metric-pill {
    padding: 2px 9px;
    border-radius: var(--radius-pill);
    font-size: 10px;
    font-weight: 600;
    background: var(--surface);
    color: var(--text-secondary);
    border: 1px solid var(--border);
    white-space: nowrap;
}

/* ── Strongest / Weakest ── */
.insights-extremes {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}
.extreme-section {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.extreme-title {
    font-size: 11.5px;
    font-weight: 700;
    color: var(--text-secondary);
    letter-spacing: 0.3px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding-bottom: 4px;
}
.extreme-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: var(--bg);
    border-radius: var(--radius-sm);
    transition: background .15s;
}
.extreme-item:hover { background: var(--surface-hover); }
.extreme-rank {
    font-size: 11px;
    font-weight: 800;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.extreme-rank.strong { background: #D1FAE5; color: #065F46; }
.extreme-rank.weak { background: #FEE2E2; color: #991B1B; }
.extreme-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.extreme-bar-wrap {
    width: 44px;
    height: 5px;
    background: var(--bg-subtle);
    border-radius: 3px;
    overflow: hidden;
    flex-shrink: 0;
}
.extreme-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width .6s cubic-bezier(.4,0,.2,1);
}
.extreme-score-val {
    font-size: 12px;
    font-weight: 700;
    min-width: 24px;
    text-align: left;
    direction: ltr;
}

/* ── Insights Responsive ── */
@media (max-width: 768px) {
    .insights-header { padding: 20px; flex-wrap: wrap; }
    .insights-body { padding: 0 16px 20px; }
    #insights-content.active { gap: 20px; }
    .insights-rings { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .ring-svg { width: 56px; height: 56px; }
    .heatmap-cell { width: 44px; height: 44px; }
    .heatmap-cell .hm-abbr { font-size: 9px; }
    .insights-extremes { grid-template-columns: 1fr; }
    .insight-item { padding: 12px; gap: 10px; }
    .insight-icon { width: 32px; height: 32px; font-size: 15px; }
}
@media (max-width: 480px) {
    .insights-rings { grid-template-columns: repeat(2, 1fr); }
    .heatmap-cell { width: 38px; height: 38px; }
    .heatmap-cell .hm-score { display: none; }
    .severity-summary { gap: 6px; }
    .severity-badge { padding: 5px 10px; font-size: 11px; }
}

/* ═══════════════════════════════════════════
   13. ANIMATIONS
   ═══════════════════════════════════════════ */
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
}

/* ═══════════════════════════════════════════
   14. RESPONSIVE
   ═══════════════════════════════════════════ */
@media (max-width: 768px) {
    .app { padding: 16px 12px 40px; }
    .hero { padding: 20px 0 4px; }
    .hero h1 { font-size: 1.6rem; }
    .input-card { padding: 16px; }
    .controls-row { flex-direction: column; align-items: stretch; }
    .mode-tabs { align-self: center; }
    .toolbar { justify-content: center; }
    .category-body { grid-template-columns: 1fr; }
    .metric-card { padding: 16px; }
    .score-card { padding: 20px 16px; }
    .gauge-wrap { max-width: 220px; }
    .topbar-company { max-width: 120px; font-size: 13px; }
    .topbar-brand-name { font-size: 13px; }
    .topbar-center { display: none !important; }
    .modal-box { padding: 20px; width: 95%; }
    .form-row { grid-template-columns: 1fr; }
    .form-weights { flex-direction: column; }
}
@media (max-width: 480px) {
    .tool-btn span { display: none; }
    .tool-btn { padding: 8px 10px; }
    .topbar { padding: 0 12px; }
    .topbar-brand-name { display: none; }
    .topbar-sep { display: none; }
    .template-grid { grid-template-columns: 1fr; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    
/* ═══════════════════════════════════════════
   FIX: Deep-dive tabs z-index and positioning
   ═══════════════════════════════════════════ */
.deepdive-content {
    position: relative;
    overflow-y: auto;
    overflow-x: hidden;
}

/* Sticky tabs that ALWAYS stay visible above content */
.deepdive-content .dd-tabs {
    position: sticky !important;
    top: 0 !important;
    background: var(--surface) !important;
    z-index: 1000 !important;
    margin: -24px -28px 0 -28px !important;
    padding: 16px 28px 0 28px !important;
    border-bottom: 2px solid var(--border) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
}

/* Content area below tabs - ensure lower z-index */
.dd-tab-content {
    position: relative;
    z-index: 1;
    padding-top: 20px;
}

.dd-tab-content > * {
    position: relative;
    z-index: 1;
}

/* Ensure ALL child elements don't overlap tabs */
.dd-flow-container,
.dd-scale-enhanced,
.dd-insight-box,
.dd-why-section,
.dd-barriers-section,
.dd-examples-section,
.dd-analogy,
.dd-pitfalls,
.dd-section,
.dd-formula-box,
.dd-related,
.dd-interp-box,
.dd-calc-section {
    position: relative;
    z-index: 1;
}

</style>
</head>
<body>
    <!-- ═══ TOPBAR ═══ -->
    <header class="topbar" id="topbar">
        <div class="topbar-right">
            <div class="topbar-brand">
                <div class="topbar-logo">
                    <svg viewBox="0 0 20 20" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="2,15 7,9 11,12 18,4"/>
                        <polyline points="14,4 18,4 18,8"/>
                    </svg>
                </div>
                <span class="topbar-brand-name">NextGen Finance</span>
            </div>
            <div class="topbar-sep"></div>
            <span class="topbar-company" id="topbar-company">ניתוח חדש</span>
        </div>
        <div class="topbar-center" id="topbar-center">
            <div class="topbar-mini-gauge" id="topbar-mini-gauge"></div>
            <span class="topbar-score" id="topbar-score">0%</span>
        </div>
        <div class="topbar-left">
            <button class="btn-icon" id="tour-btn" title="סיור מודרך">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </button>
        </div>
    </header>

    <!-- ═══ APP ═══ -->
    <main class="app">
        <!-- Hero -->
        <section class="hero">
            <h1>מדד בריאות פיננסית</h1>
            <p>כלי מקצועי להערכת האיכות הפיננסית של חברות ציבוריות</p>
        </section>

        <!-- Input Section -->
        <section class="input-card" id="input-section">
            <input type="text" id="company-name" placeholder="הקלד שם חברה לניתוח...">
            <div class="controls-row">
                <div class="mode-tabs" id="mode-tabs">
                    <button class="mode-tab" data-mode="growth">🚀 צמיחה</button>
                    <button class="mode-tab active" data-mode="balanced">⚖️ מאוזן</button>
                    <button class="mode-tab" data-mode="value">💎 ערך</button>
                </div>
                <div class="toolbar">
                    <button class="tool-btn primary" id="show-templates-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        <span>תבניות</span>
                    </button>
                    <input type="file" id="csv-file-input" accept=".csv" style="display:none">
                    <button class="tool-btn" id="import-csv-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <span>ייבוא CSV</span>
                    </button>
                    <button class="tool-btn" id="download-csv-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        <span>הורד תבנית</span>
                    </button>
                    <button class="tool-btn" id="save-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        <span>שמור</span>
                    </button>
                    <button class="tool-btn" id="load-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
                        <span>טען</span>
                    </button>
                    <button class="tool-btn danger" id="reset-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
                        <span>אפס</span>
                    </button>
                </div>
            </div>
            <div class="advanced-toggle">
                <div class="toggle-switch" id="advanced-toggle" role="switch" aria-checked="false" tabindex="0"></div>
                <span>מצב מתקדם (עריכת ספים)</span>
            </div>
        </section>

        <!-- Company Comparison Tabs -->
        <div class="company-tabs-bar" id="company-tabs-bar" style="display:none;background:var(--surface);border-radius:12px;padding:8px;margin-bottom:16px;border:1px solid var(--border);gap:8px;">
            <div class="company-tab active" data-company="1" onclick="switchCompany(1)" style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;background:var(--primary);color:white;border-radius:8px;cursor:pointer;">
                <span>🏢</span>
                <span id="company1-name">חברה 1</span>
                <span class="ct-score" id="company1-score" style="font-size:11px;padding:2px 8px;background:rgba(255,255,255,0.2);border-radius:20px;">--</span>
            </div>
            <div class="company-tab" data-company="2" onclick="switchCompany(2)" style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;background:var(--bg);color:var(--text-secondary);border-radius:8px;cursor:pointer;">
                <span>🏢</span>
                <span id="company2-name">חברה 2</span>
                <span class="ct-score" id="company2-score" style="font-size:11px;padding:2px 8px;background:var(--border);border-radius:20px;">--</span>
            </div>
            <button onclick="showCompareResults()" style="padding:10px 16px;background:var(--success);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">📊 השווה</button>
        </div>

        <!-- Compare Results View -->
        <div class="compare-view" id="compare-view" style="display:none;background:var(--surface);border-radius:12px;border:1px solid var(--border);padding:20px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);">
                <h3 style="font-size:16px;font-weight:700;color:var(--text);">📊 השוואת חברות</h3>
                <button onclick="hideCompareResults()" style="padding:8px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;cursor:pointer;">✕ סגור</button>
            </div>
            <div id="compare-grid" style="display:grid;grid-template-columns:180px 1fr 1fr;gap:1px;background:var(--border);border-radius:8px;overflow:hidden;font-size:13px;"></div>
            <div id="compare-summary" style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;"></div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard">
            <!-- Left: Main Content -->
            <div class="dashboard-main">
                <!-- Progress -->
                <div class="progress-card" id="progress-card">
                    <div class="progress-head">
                        <h3>התקדמות מילוי נתונים</h3>
                        <span id="progress-stats">0/13 מדדים</span>
                    </div>
                    <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
                </div>

                <!-- Profitability Category -->
                <div class="category" id="cat-profitability">
                    <div class="category-head" data-cat="profitability">
                        <div class="cat-icon profit">💰</div>
                        <span class="cat-title">רווחיות</span>
                        <span class="cat-badge" id="profitability-stats">0/5</span>
                        <svg class="cat-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="category-body" id="profitability-body"></div>
                </div>

                <!-- Growth Category -->
                <div class="category" id="cat-growth">
                    <div class="category-head" data-cat="growth">
                        <div class="cat-icon growth">📈</div>
                        <span class="cat-title">צמיחה</span>
                        <span class="cat-badge" id="growth-stats">0/3</span>
                        <svg class="cat-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="category-body" id="growth-body"></div>
                </div>

                <!-- Valuation Category -->
                <div class="category" id="cat-valuation">
                    <div class="category-head" data-cat="valuation">
                        <div class="cat-icon value">⚖️</div>
                        <span class="cat-title">הערכת שווי</span>
                        <span class="cat-badge" id="valuation-stats">0/2</span>
                        <svg class="cat-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="category-body" id="valuation-body"></div>
                </div>

                <!-- Stability Category -->
                <div class="category" id="cat-stability">
                    <div class="category-head" data-cat="stability">
                        <div class="cat-icon stable">🛡️</div>
                        <span class="cat-title">יציבות פיננסית</span>
                        <span class="cat-badge" id="stability-stats">0/3</span>
                        <svg class="cat-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="category-body" id="stability-body"></div>
                </div>

                <!-- Custom Category -->
                <div class="category" id="cat-custom">
                    <div class="category-head" data-cat="custom">
                        <div class="cat-icon custom">🔧</div>
                        <span class="cat-title">מדדים מותאמים אישית</span>
                        <span class="cat-badge" id="custom-stats">0/0</span>
                        <svg class="cat-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="category-body" id="custom-body"></div>

                    <!-- Optional Pre-Built Metrics -->
                    <div class="optional-metrics-section" id="optional-metrics-section">
                        <div class="oms-header">
                            <div>
                                <div class="oms-title">✨ מדדים מומלצים להוספה</div>
                                <div class="oms-subtitle">לחץ כדי להוסיף מדד מוכן עם הסברים מלאים</div>
                            </div>
                        </div>
                        <div class="oms-grid" id="oms-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <button class="tool-btn primary" id="add-custom-btn" style="margin-top:12px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                        <span>הוסף מדד מותאם</span>
                    </button>
                </div>
            </div>

            <!-- Right: Score Panel -->
            <aside class="dashboard-side">
                <div class="score-card" id="score-card">
                    <div class="score-card-title">מדד בריאות פיננסית</div>
                    <div class="gauge-wrap">
                        <svg class="gauge-svg" viewBox="0 0 220 135">
                            <defs>
                                <linearGradient id="gPoor" x1="0%" y1="0%" x2="100%"><stop offset="0%" stop-color="#EF4444"/><stop offset="100%" stop-color="#F97316"/></linearGradient>
                                <linearGradient id="gAvg" x1="0%" y1="0%" x2="100%"><stop offset="0%" stop-color="#F59E0B"/><stop offset="100%" stop-color="#EAB308"/></linearGradient>
                                <linearGradient id="gGood" x1="0%" y1="0%" x2="100%"><stop offset="0%" stop-color="#10B981"/><stop offset="100%" stop-color="#34D399"/></linearGradient>
                                <linearGradient id="gExc" x1="0%" y1="0%" x2="100%"><stop offset="0%" stop-color="#6366F1"/><stop offset="100%" stop-color="#818CF8"/></linearGradient>
                            </defs>
                            <path class="gauge-track" d="M 20,120 A 90,90 0 0,1 200,120"/>
                            <path class="gauge-progress" id="gauge-progress" d="M 20,120 A 90,90 0 0,1 200,120" stroke="url(#gPoor)" stroke-dasharray="282.743" stroke-dashoffset="282.743"/>
                            <text x="110" y="82" text-anchor="middle" class="gauge-score-text" id="gauge-score-text">0</text>
                            <text x="144" y="70" text-anchor="start" class="gauge-percent-text">%</text>
                            <text x="110" y="112" text-anchor="middle" class="gauge-label-text" id="gauge-label-text" fill="#94A3B8">חלש</text>
                        </svg>
                    </div>
                    <div class="score-status" id="score-status">הזן נתונים כדי לחשב את הציון...</div>
                    <div class="score-criteria" id="score-criteria">0/13 קריטריונים עומדים בסף</div>

                    <div class="radar-wrap">
                        <div class="radar-title">ניתוח לפי קטגוריה</div>
                        <div class="radar-svg-container">
                            <svg id="radar-svg" viewBox="0 0 400 400">
                                <text x="200" y="200" text-anchor="middle" fill="#94A3B8" font-family="Rubik" font-size="13">הזן 3+ מדדים להצגת הגרף</text>
                            </svg>
                        </div>
                        <div class="radar-legend">
                            <div class="radar-legend-item"><div class="legend-dot threshold"></div><span>סף (50%)</span></div>
                            <div class="radar-legend-item"><div class="legend-dot value"></div><span>ניקוד החברה</span></div>
                        </div>
                    </div>

                    <div class="score-actions">
                        <button class="score-btn primary" id="show-summary-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            הצג סיכום
                        </button>
                        <button class="score-btn secondary" id="show-terms-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
                            ספריית מונחים
                        </button>
                    </div>
                </div>
            </aside>
        </div>


        <!-- Insights Panel -->
        <section class="insights-section" id="insights-section">
            <div class="insights-card">
                <div class="insights-header">
                    <div class="insights-header-right">
                        <div class="insights-header-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/><line x1="6" y1="8" x2="6" y2="8.01"/><line x1="6" y1="12" x2="8" y2="12"/><line x1="6" y1="16" x2="8" y2="16"/><line x1="18" y1="8" x2="18" y2="8.01"/><line x1="16" y1="12" x2="18" y2="12"/><line x1="16" y1="16" x2="18" y2="16"/></svg>
                        </div>
                        <div>
                            <h2>תובנות וניתוח אוטומטי</h2>
                            <span class="insights-header-subtitle" id="insights-subtitle">הזן נתונים כדי לקבל תובנות</span>
                        </div>
                    </div>
                    <button class="insights-toggle-btn" id="insights-toggle">הסתר ▴</button>
                </div>
                <div class="insights-body" id="insights-body">
                    <div class="insights-empty" id="insights-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        <div>הזן לפחות 3 מדדים כדי לקבל ניתוח אוטומטי</div>
                    </div>
                    <div id="insights-content">
                        <div class="insights-rings" id="insights-rings"></div>
                        <div class="insights-heatmap">
                            <div class="heatmap-title">מפת חום — ביצועי מדדים</div>
                            <div class="heatmap-grid" id="heatmap-grid"></div>
                        </div>
                        <div class="severity-summary" id="severity-summary"></div>
                        <div id="insights-groups"></div>
                        <div class="insights-extremes" id="insights-extremes"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Notes -->
        <section class="notes-section">
            <div class="notes-card">
                <h3>📝 הערות אישיות</h3>
                <textarea id="user-notes" placeholder="כתוב כאן הערות על הניתוח..."></textarea>
            </div>
        </section>


    <!-- Infographics Gallery Modal -->
    <div class="infographics-modal" id="infographics-modal">
        <div class="infographics-container">
            <div class="infographics-header">
                <h2>📊 גלריית אינפוגרפיקות</h2>
                <button class="infographics-close" onclick="closeInfographicsModal()">&times;</button>
            </div>
            <div class="infographics-body" id="infographics-body">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- AI Prompt Modal -->
    <div class="ai-prompt-modal" id="ai-prompt-modal">
        <div class="ai-prompt-box">
            <div class="ai-prompt-header">
                <h2>🤖 הפקת נתונים באמצעות AI</h2>
                <button class="ai-prompt-close" onclick="closeAIPromptModal()">&times;</button>
            </div>
            <div class="ai-prompt-content">
                <div class="ai-prompt-intro">
                    <strong>איך להשתמש:</strong><br>
                    1. העתק את הפרומפט למטה<br>
                    2. הדבק אותו ב-ChatGPT, Claude, או Gemini<br>
                    3. הוסף את שם החברה שאתה רוצה לנתח<br>
                    4. קבל CSV מוכן להעתקה לכלי הזה<br><br>
                    <strong>טיפ:</strong> הפרומפט מבקש מה-AI לספק נתונים מדויקים עם מקורות. תמיד בדוק את הנתונים מול דוחות החברה.
                </div>
                <textarea class="ai-prompt-textarea" id="ai-prompt-text" readonly></textarea>
            </div>
            <div class="ai-prompt-footer">
                <span class="apf-hint">💡 הפרומפט מותאם לקבלת כל 13 המדדים הבסיסיים + 5 המדדים האופציונליים</span>
                <button class="ai-prompt-copy-btn" onclick="copyAIPrompt()">
                    <span>📋</span> העתק פרומפט
                </button>
            </div>
        </div>
    </div>

    <!-- Metric Deep-Dive Modal -->
    <div class="deepdive-modal" id="deepdive-modal">
        <div class="deepdive-box">
            <div class="deepdive-header">
                <button class="deepdive-close" id="deepdive-close">&times;</button>
                <div class="deepdive-header-icon" id="dd-icon">📊</div>
                <div class="deepdive-header-text">
                    <h2 id="dd-title">שם המדד</h2>
                    <span class="deepdive-header-cat" id="dd-category">קטגוריה</span>
                </div>
            </div>
            <div class="deepdive-content" id="dd-content">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>


    <!-- Infographics Gallery Modal -->
        </main>

    <!-- ═══ MODALS ═══ -->
    <!-- Summary Modal -->
    <div class="modal-overlay" id="summary-modal">
        <div class="modal-box">
            <button class="modal-close" data-modal="summary-modal">&times;</button>
            <div class="modal-header">
                <h2 id="summary-company">סיכום ניתוח</h2>
                <p id="summary-status-text">סטטוס: טרם הוזנו נתונים</p>
            </div>
            <div class="summary-grid" id="summary-grid">
                <div class="summary-item"><div class="summary-item-name">טען נתונים...</div><div class="summary-item-value">-</div></div>
            </div>
        </div>
    </div>

    <!-- Terminology Modal -->
    <div class="modal-overlay" id="terms-modal">
        <div class="modal-box" style="max-width:800px">
            <button class="modal-close" data-modal="terms-modal">&times;</button>
            <div class="modal-header"><h2>ספריית מונחים פיננסיים</h2></div>
            <div class="modal-tabs" id="terms-tabs">
                <button class="modal-tab active" data-tab="terms-profit">רווחיות</button>
                <button class="modal-tab" data-tab="terms-growth">צמיחה</button>
                <button class="modal-tab" data-tab="terms-valuation">הערכת שווי</button>
                <button class="modal-tab" data-tab="terms-stability">יציבות פיננסית</button>
            </div>
            <div id="terms-content"></div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div class="modal-overlay" id="templates-modal">
        <div class="modal-box" style="max-width:800px">
            <button class="modal-close" data-modal="templates-modal">&times;</button>
            <div class="modal-header"><h2>תבניות ענפיות</h2><p>ערכי סף מומלצים לפי ענף ופרופיל השקעה</p></div>
            <div class="template-btns" id="template-btns"></div>
            <div class="template-desc" id="template-desc"></div>
            <div class="template-grid" id="template-grid"></div>
            <button class="score-btn primary" id="apply-template-btn" style="margin-top:16px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                החל תבנית
            </button>
        </div>
    </div>

    <!-- Load History Modal -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal-box">
            <button class="modal-close" data-modal="history-modal">&times;</button>
            <div class="modal-header"><h2>היסטוריית ניתוחים</h2><p>טען או מחק ניתוחים שנשמרו</p></div>
            <div class="history-list" id="history-list">
                <div class="no-history">לא נמצאו ניתוחים שמורים.</div>
            </div>
        </div>
    </div>

    <!-- Add Custom Metric Modal -->
    <div class="modal-overlay" id="custom-modal">
        <div class="modal-box" style="max-width:550px">
            <button class="modal-close" data-modal="custom-modal">&times;</button>
            <div class="modal-header"><h2>הוספת מדד מותאם אישית</h2></div>
            <div>
                <div class="form-group"><label>שם המדד:</label><input type="text" id="cm-name" placeholder="לדוגמה: יחס X ל-Y"></div>
                <div class="form-group"><label>תיאור קצר:</label><textarea id="cm-desc" maxlength="150" placeholder="לדוגמה: מודד את יעילות Z..."></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label>ערך סף (✔️/❌):</label><input type="number" id="cm-threshold" step="any" placeholder="10"></div>
                    <div class="form-group"><label>תנאי:</label><select id="cm-compare"><option value="above">גבוה יותר = טוב (> סף)</option><option value="below">נמוך יותר = טוב (< סף)</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>ערך אופטימלי (ציון 100):</label><input type="number" id="cm-optimal" step="any" placeholder="20"></div>
                    <div class="form-group"><label>ערך גרוע (ציון 0):</label><input type="number" id="cm-worst" step="any" placeholder="0"></div>
                </div>
                <div style="margin-bottom:12px">
                    <label style="font-size:13px;font-weight:500;color:var(--text-secondary);display:block;margin-bottom:6px;">משקלים (0.1–2.0):</label>
                    <div class="form-weights">
                        <div class="form-group"><label>צמיחה</label><input type="number" id="cm-wg" step="0.1" min="0.1" max="2" value="1.0"></div>
                        <div class="form-group"><label>מאוזן</label><input type="number" id="cm-wb" step="0.1" min="0.1" max="2" value="1.0"></div>
                        <div class="form-group"><label>ערך</label><input type="number" id="cm-wv" step="0.1" min="0.1" max="2" value="1.0"></div>
                    </div>
                </div>
                <div class="form-group"><label>יחידה (אופציונלי):</label><input type="text" id="cm-unit" placeholder="%, ימים, יחס"></div>
                <button class="score-btn primary" id="save-custom-btn" style="margin-top:8px;width:100%;">שמור מדד</button>
            </div>
        </div>
    </div>

    <!-- CSV Export Modal -->
    <div class="csv-modal" id="csv-modal">
        <div class="csv-box">
            <div class="csv-header">
                <h2>📥 ייצוא/הורדה</h2>
                <button onclick="closeCSVModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted);">&times;</button>
            </div>
            <div class="csv-body">
                <div class="csv-option" id="csv-download-current" onclick="downloadCurrentDataCSV()">
                    <div class="csv-option-icon" style="background:var(--success-bg);color:var(--success);border-radius:12px;display:flex;align-items:center;justify-content:center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </div>
                    <div>
                        <div style="font-weight:600;color:var(--text);margin-bottom:4px;">הורד נתונים נוכחיים</div>
                        <div style="font-size:13px;color:var(--text-secondary);">ייצא את כל הנתונים שהזנת לקובץ CSV</div>
                    </div>
                </div>
                <div class="csv-option" id="csv-download-template" onclick="downloadEmptyTemplate()">
                    <div class="csv-option-icon" style="background:var(--primary-bg);color:var(--primary);border-radius:12px;display:flex;align-items:center;justify-content:center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    </div>
                    <div>
                        <div style="font-weight:600;color:var(--text);margin-bottom:4px;">הורד תבנית ריקה</div>
                        <div style="font-size:13px;color:var(--text-secondary);">קובץ CSV עם כותרות בלבד למילוי</div>
                    </div>
                </div>
                <div class="csv-option" id="csv-ai-prompt" onclick="generateAIPrompt()">
                    <div class="csv-option-icon" style="background:linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);color:white;border-radius:12px;display:flex;align-items:center;justify-content:center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><path d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 017 7h1a1 1 0 011 1v3a1 1 0 01-1 1h-1v1a2 2 0 01-2 2H5a2 2 0 01-2-2v-1H2a1 1 0 01-1-1v-3a1 1 0 011-1h1a7 7 0 017-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 012-2z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>
                    </div>
                    <div>
                        <div style="font-weight:600;color:var(--text);margin-bottom:4px;">🤖 צור פרומפט ל-AI</div>
                        <div style="font-size:13px;color:var(--text-secondary);">פרומפט מפורט שיעזור ל-AI למלא את הנתונים עבורך</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    <script>
// ═══════════════════════════════════════════
// METRIC DEFINITIONS
// ═══════════════════════════════════════════
const baseMetrics = [
    { id:'roi', name:'תשואה על ההשקעה (ROI)', description:'מודדת את יעילות ורווחיות השקעות החברה.', category:'profitability', termId:'roi', threshold:10, compare:'above', unit:'%', inputs:[{id:'roi-value',step:0.1,unit:'%'}], weights:{growth:1.2,balanced:1.4,value:1.6}, evaluate:v=>{if(isNaN(v)||v<=0)return 0;if(v>=20)return 100;return Math.min(100,Math.round(v*5))} },
    { id:'roe', name:'תשואה על ההון (ROE)', description:'כמה רווח החברה מייצרת ביחס להון העצמי.', category:'profitability', termId:'roe', threshold:15, compare:'above', unit:'%', inputs:[{id:'roe-value',step:0.1,unit:'%'}], weights:{growth:1.2,balanced:1.5,value:1.8}, evaluate:v=>{if(isNaN(v)||v<=0)return 0;if(v>=30)return 100;return Math.min(100,Math.round(v*100/30))} },
    { id:'gross-margin', name:'מרווח גולמי', description:'מצביע על רווחיות בסיסית ויתרון תחרותי.', category:'profitability', termId:'gross-margin', threshold:30, compare:'combined', unit:'%', inputs:[{id:'gross-margin-value',label:'מרווח:',step:0.1,unit:'%'},{id:'gross-margin-growth-value',label:'צמיחה:',step:0.1,unit:'%'}], weights:{growth:1.3,balanced:1.4,value:1.5}, evaluate:(v,g)=>{if(isNaN(v))return 0;let s=0;if(v>=30)s=100;else if(v>=15)s=Math.round(50+(v-15)*50/15);else s=Math.round(v*50/15);if(s<100&&!isNaN(g)&&g>3){const gs=Math.min(100,Math.round(50+g*50/10));s=Math.max(s,gs)}return s} },
    { id:'pm', name:'שולי רווח נקי', description:'כמה מההכנסות הופכות לרווח נקי בפועל.', category:'profitability', termId:'pm', threshold:10, compare:'above', unit:'%', inputs:[{id:'pm-value',step:0.1,unit:'%'}], weights:{growth:1.0,balanced:1.3,value:1.6}, evaluate:v=>{if(isNaN(v)||v<=0)return 0;if(v>=20)return 100;return Math.min(100,Math.round(v*5))} },
    { id:'fcf-yield', name:'תשואת FCF', description:'תזרים מזומנים חופשי ביחס לשווי השוק.', category:'profitability', termId:'fcf-yield', threshold:5, compare:'above', unit:'%', inputs:[{id:'fcf-yield-value',step:0.1,unit:'%'}], weights:{growth:1.0,balanced:1.4,value:1.8}, evaluate:v=>{if(isNaN(v)||v<=0)return 0;if(v>=10)return 100;return Math.min(100,Math.round(v*10))} },
    { id:'fcf-growth', name:'צמיחת FCF (5Y CAGR)', description:'קצב צמיחה שנתי מורכב של תזרים מזומנים חופשי.', category:'growth', termId:'fcf-growth', threshold:10, compare:'above', unit:'%', inputs:[{id:'fcf-growth-value',step:0.1,unit:'%'}], weights:{growth:1.8,balanced:1.5,value:1.2}, evaluate:v=>{if(isNaN(v)||v<=0)return 0;if(v>=20)return 100;return Math.min(100,Math.round(v*5))} },
    { id:'eps-growth', name:'צמיחת EPS (5Y CAGR)', description:'קצב צמיחת הרווח למניה לאורך 5 שנים.', category:'growth', termId:'eps-growth', threshold:8, compare:'above', unit:'%', inputs:[{id:'eps-growth-value',step:0.1,unit:'%'}], weights:{growth:1.8,balanced:1.5,value:1.2}, evaluate:v=>{if(isNaN(v)||v<=0)return 0;if(v>=16)return 100;return Math.min(100,Math.round(v*100/16))} },
    { id:'buyback', name:'רכישה עצמית (שנתי)', description:'אחוז המניות שהחברה רכשה חזרה מהשוק.', category:'growth', termId:'buyback', threshold:1.0, compare:'above', unit:'%', inputs:[{id:'buyback-value',step:0.1,unit:'%'}], weights:{growth:0.8,balanced:1.2,value:1.6}, evaluate:v=>{if(isNaN(v)||v<=0)return 0;if(v>=3)return 100;return Math.min(100,Math.round(v*100/3))} },
    { id:'pe', name:'יחס מחיר לרווח (P/E)', description:'כמה משקיעים משלמים עבור כל שקל של רווח.', category:'valuation', termId:'pe-ratio', threshold:15, compare:'below', unit:'', inputs:[{id:'pe-value',step:0.1}], weights:{growth:0.8,balanced:1.0,value:1.2}, evaluate:(v,_,m)=>{if(isNaN(v)||v<=0)return 0;if(m==='growth'){if(v<=25)return 100;if(v<=40)return Math.round(50+(40-v)*50/15);return Math.max(0,Math.round(50-(v-40)*50/20))}else if(m==='value'){if(v<=10)return 100;if(v<=15)return Math.round(50+(15-v)*50/5);return Math.max(0,Math.round(50-(v-15)*50/15))}else{if(v<=15)return 100;if(v<=25)return Math.round(50+(25-v)*50/10);return Math.max(0,Math.round(50-(v-25)*50/15))}} },
    { id:'peg', name:'יחס PEG', description:'משווה P/E לשיעור צמיחת הרווחים.', category:'valuation', termId:'peg-ratio', threshold:1.0, compare:'below', unit:'', inputs:[{id:'peg-value',step:0.01}], weights:{growth:1.2,balanced:1.0,value:0.8}, evaluate:v=>{if(isNaN(v)||v<=0)return 0;if(v<=1.0)return 100;if(v<=2.0)return Math.max(0,Math.round(100-(v-1)*100));return 0} },
    { id:'cr', name:'יחס שוטף (CR)', description:'יכולת לעמוד בהתחייבויות לטווח קצר.', category:'stability', termId:'cr', threshold:1.5, compare:'above', unit:'', inputs:[{id:'cr-value',step:0.01}], weights:{growth:1.0,balanced:1.3,value:1.6}, evaluate:v=>{if(isNaN(v)||v<=0)return 0;if(v>=3)return 100;if(v>=1.5)return Math.round(50+(v-1.5)*50/1.5);return Math.min(50,Math.round(v*50/1.5))} },
    { id:'de', name:'יחס חוב להון (D/E)', description:'מודד את המינוף הפיננסי של החברה.', category:'stability', termId:'de', threshold:0.5, compare:'below', unit:'', inputs:[{id:'de-value',step:0.01}], weights:{growth:0.9,balanced:1.2,value:1.5}, evaluate:v=>{if(isNaN(v)||v<0)return 0;if(v<=0.25)return 100;if(v<=0.5)return Math.round(50+(0.5-v)*50/0.25);if(v<=1.0)return Math.round(50-(v-0.5)*50/0.5);return Math.max(0,Math.round(25-(v-1)*25/2))} },
    { id:'altman-z', name:'Altman Z-Score', description:'מדד מורכב לבחינת סיכון פשיטת רגל.', category:'stability', termId:'altman-z', threshold:2.99, compare:'above', unit:'', inputs:[{id:'altman-z-value',step:0.01}], weights:{growth:0.8,balanced:1.5,value:1.8}, evaluate:v=>{if(isNaN(v))return 0;if(v<=1.81)return Math.max(0,Math.round(v*25/1.81));if(v<=2.99)return Math.round(25+(v-1.81)*25/(2.99-1.81));if(v>=4.0)return 100;return Math.round(50+(v-2.99)*50/(4.0-2.99))} }
];

// ═══════════════════════════════════════════
// TERMINOLOGY DATA
// ═══════════════════════════════════════════
const termsData = {
    'terms-profit': [
        {id:'roi',name:'תשואה על ההשקעה (ROI)',formula:'רווח נקי / סך השקעות × 100%',desc:'מדד המשמש למדידת רווחיות או יעילות של השקעה. ROI גבוה מצביע על כך שהחברה מצליחה להפיק תשואה טובה על ההון המושקע בה. ערך של 10% ומעלה נחשב בדרך כלל לטוב.'},
        {id:'roe',name:'תשואה על ההון (ROE)',formula:'רווח נקי / הון עצמי × 100%',desc:'מודד את היעילות שבה חברה משתמשת בהון העצמי שלה ליצירת רווחים. ROE גבוה מעיד על ניהול יעיל של ההון. ערך של 15% ומעלה נחשב בדרך כלל לטוב.'},
        {id:'gross-margin',name:'מרווח גולמי (Gross Margin)',formula:'(הכנסות − עלות המכר) / הכנסות × 100%',desc:'משקף את אחוז הרווח שנותר לאחר כיסוי העלויות הישירות. מרווח גולמי גבוה מעיד על יתרון תחרותי ויכולת תמחור. ערך של 30% ומעלה נחשב לטוב.'},
        {id:'pm',name:'שולי רווח נקי (Net Profit Margin)',formula:'רווח נקי / הכנסות × 100%',desc:'מודד את אחוז הרווח הנקי מתוך סך ההכנסות, לאחר כל ההוצאות, מסים וריבית. שולי רווח של 10% ומעלה נחשבים בדרך כלל לטובים.'},
        {id:'fcf-yield',name:'תשואת תזרים מזומנים חופשי (FCF Yield)',formula:'FCF למניה / מחיר למניה × 100%',desc:'מודד את כמות המזומנים החופשיים שהחברה מייצרת ביחס לשווי השוק שלה. תשואה של 5% ומעלה נחשבת טובה ומעידה על יכולת לממן דיבידנדים, רכישות עצמיות או הפחתת חוב.'}
    ],
    'terms-growth': [
        {id:'fcf-growth',name:'צמיחת תזרים מזומנים (FCF Growth)',formula:'CAGR של FCF לאורך 5 שנים',desc:'מודד את הקצב שבו החברה מגדילה את יכולתה לייצר מזומנים פנויים. צמיחת FCF חיובית מעידה על שיפור ביכולת הרווח הממשי של החברה.'},
        {id:'eps-growth',name:'צמיחת רווח למניה (EPS Growth)',formula:'CAGR של EPS לאורך 5 שנים',desc:'מודד את הקצב שבו הרווח המיוחס לכל מניה גדל לאורך זמן. צמיחת EPS עקבית מעידה על יכולת החברה להגדיל רווחים.'},
        {id:'buyback',name:'רכישה עצמית (Share Buyback)',formula:'אחוז מניות שנרכשו / סך מניות',desc:'כאשר חברה רוכשת מניותיה מהשוק, היא מפחיתה את כמות המניות הקיימות ומגדילה את חלקו של כל בעל מניות ברווחים העתידיים.'}
    ],
    'terms-valuation': [
        {id:'pe-ratio',name:'יחס מחיר לרווח (P/E)',formula:'מחיר למניה / רווח למניה',desc:'אחד המדדים הנפוצים ביותר להערכת שווי. P/E נמוך יכול להעיד על הערכת חסר, אך גם על בעיות צפויות. P/E גבוה מצביע על ציפיות צמיחה.'},
        {id:'peg-ratio',name:'יחס P/E לצמיחה (PEG)',formula:'P/E / שיעור צמיחת EPS',desc:'כלי הערכה המתחשב גם ביחס P/E וגם בצמיחה הצפויה. PEG < 1 נחשב לזול ביחס לצמיחה, PEG > 2 יקר יחסית.'}
    ],
    'terms-stability': [
        {id:'cr',name:'יחס שוטף (Current Ratio)',formula:'נכסים שוטפים / התחייבויות שוטפות',desc:'מודד את יכולת החברה לעמוד בהתחייבויות הפיננסיות לטווח הקצר. יחס של 1.5 ומעלה נחשב בריא.'},
        {id:'de',name:'יחס חוב להון (D/E)',formula:'סך חובות / הון עצמי',desc:'מודד את המינוף הפיננסי. יחס נמוך מ-0.5 מצביע על מינוף שמרני. יחס גבוה מ-1 מצביע על מינוף משמעותי.'},
        {id:'altman-z',name:'Altman Z-Score',formula:'נוסחה מורכבת (5 יחסים פיננסיים)',desc:'מדד סטטיסטי לחיזוי סיכון פשיטת רגל. Z > 2.99: אזור בטוח. 1.81 < Z < 2.99: אזור אפור. Z < 1.81: סיכון גבוה.'}
    ]
};

// ═══════════════════════════════════════════
// TEMPLATES DATA
// ═══════════════════════════════════════════
const industryTemplates = {
    tech:{name:'טכנולוגיה',desc:'חברות טכנולוגיה מאופיינות בצמיחה מהירה, מרווחים גבוהים ושווי שוק גבוה ביחס לרווחים.',values:{growth:{roi:12,roe:18,'fcf-yield':4,'fcf-growth':15,'eps-growth':20,'gross-margin':45,'gross-margin-growth':5,cr:2.0,pm:15,pe:25,de:0.3,peg:1.2,buyback:2,'altman-z':5},balanced:{roi:10,roe:15,'fcf-yield':5,'fcf-growth':12,'eps-growth':15,'gross-margin':40,'gross-margin-growth':3,cr:1.8,pm:12,pe:20,de:0.4,peg:1.0,buyback:1.5,'altman-z':4},value:{roi:8,roe:12,'fcf-yield':6,'fcf-growth':8,'eps-growth':10,'gross-margin':35,'gross-margin-growth':2,cr:1.5,pm:10,pe:15,de:0.5,peg:0.8,buyback:3,'altman-z':3.5}}},
    finance:{name:'פיננסים',desc:'חברות פיננסיות (בנקים, ביטוח) פועלות עם מינוף גבוה. מדדי FCF פחות רלוונטיים עבורן.',values:{growth:{roi:8,roe:15,'fcf-yield':-1,'fcf-growth':8,'eps-growth':10,'gross-margin':30,'gross-margin-growth':2,cr:1.2,pm:20,pe:15,de:3.0,peg:1.0,buyback:3,'altman-z':1.5},balanced:{roi:7,roe:12,'fcf-yield':-1,'fcf-growth':6,'eps-growth':8,'gross-margin':25,'gross-margin-growth':1,cr:1.1,pm:18,pe:12,de:5.0,peg:0.9,buyback:2,'altman-z':1.2},value:{roi:6,roe:10,'fcf-yield':-1,'fcf-growth':5,'eps-growth':5,'gross-margin':20,'gross-margin-growth':0,cr:1.0,pm:15,pe:8,de:7.0,peg:0.7,buyback:4,'altman-z':1.0}}},
    retail:{name:'קמעונאות',desc:'קמעונאות מתאפיינת במרווחים נמוכים יחסית ותחרות עזה.',values:{growth:{roi:10,roe:15,'fcf-yield':5,'fcf-growth':10,'eps-growth':12,'gross-margin':30,'gross-margin-growth':2,cr:1.3,pm:5,pe:20,de:0.8,peg:1.2,buyback:1.5,'altman-z':3.5},balanced:{roi:8,roe:12,'fcf-yield':6,'fcf-growth':7,'eps-growth':8,'gross-margin':25,'gross-margin-growth':1,cr:1.2,pm:4,pe:15,de:1.0,peg:1.0,buyback:2,'altman-z':3.0},value:{roi:6,roe:10,'fcf-yield':7,'fcf-growth':5,'eps-growth':5,'gross-margin':20,'gross-margin-growth':0,cr:1.1,pm:3,pe:10,de:1.2,peg:0.8,buyback:3,'altman-z':2.8}}},
    healthcare:{name:'בריאות',desc:'חברות תרופות וציוד רפואי נהנות ממרווחים גבוהים אך מחזור פיתוח ארוך.',values:{growth:{roi:12,roe:18,'fcf-yield':4,'fcf-growth':12,'eps-growth':15,'gross-margin':60,'gross-margin-growth':3,cr:2.0,pm:15,pe:25,de:0.5,peg:1.3,buyback:1,'altman-z':4.5},balanced:{roi:10,roe:15,'fcf-yield':5,'fcf-growth':10,'eps-growth':12,'gross-margin':55,'gross-margin-growth':2,cr:1.8,pm:12,pe:20,de:0.7,peg:1.1,buyback:1.5,'altman-z':4.0},value:{roi:8,roe:12,'fcf-yield':6,'fcf-growth':8,'eps-growth':8,'gross-margin':50,'gross-margin-growth':1,cr:1.5,pm:10,pe:15,de:0.8,peg:0.9,buyback:2,'altman-z':3.5}}},
    industrial:{name:'תעשייה',desc:'חברות תעשייתיות מחזוריות, תלויות בהשקעות הון משמעותיות.',values:{growth:{roi:9,roe:15,'fcf-yield':5,'fcf-growth':8,'eps-growth':10,'gross-margin':30,'gross-margin-growth':2,cr:1.5,pm:8,pe:18,de:1.0,peg:1.2,buyback:1.5,'altman-z':3.0},balanced:{roi:7,roe:12,'fcf-yield':6,'fcf-growth':6,'eps-growth':7,'gross-margin':25,'gross-margin-growth':1,cr:1.3,pm:6,pe:15,de:1.2,peg:1.0,buyback:2,'altman-z':2.5},value:{roi:6,roe:10,'fcf-yield':7,'fcf-growth':4,'eps-growth':5,'gross-margin':20,'gross-margin-growth':0,cr:1.2,pm:5,pe:12,de:1.5,peg:0.8,buyback:2.5,'altman-z':2.2}}},
    utilities:{name:'אנרגיה ותשתיות',desc:'חברות יציבות עם מינוף גבוה ותשואות דיבידנד.',values:{growth:{roi:7,roe:11,'fcf-yield':5,'fcf-growth':6,'eps-growth':7,'gross-margin':40,'gross-margin-growth':1,cr:1.2,pm:15,pe:18,de:1.5,peg:1.5,buyback:1,'altman-z':2.0},balanced:{roi:6,roe:9,'fcf-yield':6,'fcf-growth':4,'eps-growth':5,'gross-margin':35,'gross-margin-growth':0.5,cr:1.1,pm:12,pe:15,de:1.8,peg:1.2,buyback:1.5,'altman-z':1.8},value:{roi:5,roe:8,'fcf-yield':7,'fcf-growth':3,'eps-growth':4,'gross-margin':30,'gross-margin-growth':0,cr:1.0,pm:10,pe:12,de:2.0,peg:1.0,buyback:2,'altman-z':1.5}}},
    realestate:{name:'נדל"ן',desc:'חברות נדל"ן (REITs) מחזיקות נכסים מניבים עם מינוף.',values:{growth:{roi:8,roe:12,'fcf-yield':4,'fcf-growth':7,'eps-growth':8,'gross-margin':45,'gross-margin-growth':2,cr:1.5,pm:25,pe:18,de:1.8,peg:1.5,buyback:0.5,'altman-z':1.8},balanced:{roi:7,roe:10,'fcf-yield':5,'fcf-growth':5,'eps-growth':6,'gross-margin':40,'gross-margin-growth':1,cr:1.3,pm:20,pe:15,de:2.0,peg:1.2,buyback:1,'altman-z':1.5},value:{roi:6,roe:9,'fcf-yield':6,'fcf-growth':4,'eps-growth':4,'gross-margin':35,'gross-margin-growth':0,cr:1.2,pm:18,pe:12,de:2.2,peg:1.0,buyback:1.5,'altman-z':1.2}}}
};

// ═══════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════
let currentMode = 'balanced';
let metricScores = {};
let customMetricsData = [];
let customMetricInputs = {};
let customThresholds = {};
let isAdvancedMode = false;
let lastGaugeScore = -1;
let activeTemplate = 'tech';
const STORAGE_KEY = 'fh_history_v6';
const CUSTOM_KEY = 'fh_custom_v3';
const MAX_HIST = 20;

function getAllMetrics() {
    return [...baseMetrics, ...customMetricsData.map(cm => ({
        ...cm, category:'custom', isCustom:true,
        evaluate: v => evaluateCustom(v, cm)
    }))];
}
function evaluateCustom(value, def) {
    if(isNaN(value)||!def||isNaN(def.optimalValue)||isNaN(def.worstValue))return 0;
    if(def.optimalValue===def.worstValue) return value===def.optimalValue?100:0;
    let score;
    if(def.optimalValue>def.worstValue){
        if(value>=def.optimalValue)score=100;else if(value<=def.worstValue)score=0;
        else score=((value-def.worstValue)/(def.optimalValue-def.worstValue))*100;
    } else {
        if(value<=def.optimalValue)score=100;else if(value>=def.worstValue)score=0;
        else score=((def.worstValue-value)/(def.worstValue-def.optimalValue))*100;
    }
    return Math.max(0,Math.min(100,Math.round(score)));
}

// ═══════════════════════════════════════════
// SVG ICONS (inline)
// ═══════════════════════════════════════════
const ICONS = {
    check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
    x: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    minus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="5" y1="12" x2="19" y2="12"/></svg>',
    info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
    trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>',
    checkCircle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    alertCircle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    xCircle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
};

// ═══════════════════════════════════════════
// RENDER METRIC CARDS
// ═══════════════════════════════════════════
function buildMetricCard(metric, isCustom=false) {
    const card = document.createElement('div');
    card.className = 'metric-card';
    card.id = `${metric.id}-card`;
    if(isCustom) card.style.animationDelay = '.1s';

    let inputsHTML = metric.inputs.map(inp => `
        <div class="metric-input-row">
            ${inp.label ? `<label>${inp.label}</label>` : ''}
            <input type="number" id="${inp.id}" step="${inp.step||0.1}" placeholder="הזן ערך..." class="metric-input">
            ${inp.unit ? `<span class="unit">${inp.unit}</span>` : ''}
        </div>
    `).join('');

    let thresholdText = getThresholdText(metric);

    card.innerHTML = `
        ${isCustom ? `<button class="delete-metric-btn" data-id="${metric.id}" title="מחק מדד">${ICONS.trash}</button>` : ''}
        <div class="metric-head">
            <h3>${metric.name}</h3>
            ${metric.termId ? `<button class="info-btn" data-term="${metric.termId}" title="מידע נוסף">${ICONS.info}</button>` : ''}
        </div>
        <p class="metric-desc">${metric.description}</p>
        <div class="metric-input-area">${inputsHTML}</div>
        <div class="metric-bar-row">
            <div class="metric-bar"><div class="metric-bar-fill" id="${metric.id}-bar"></div></div>
            <span class="metric-bar-score" id="${metric.id}-bscore">0</span>
        </div>
        <div class="custom-threshold ${isAdvancedMode && metric.compare!=='combined' && metric.id!=='pe' ? 'visible' : ''}" id="${metric.id}-ct">
            <label>סף מותאם:</label>
            <input type="number" id="${metric.id}-ct-input" step="any" placeholder="${metric.threshold}"
                ${(metric.compare==='combined'||metric.id==='pe')&&!isCustom ? 'disabled' : ''}>
            <button class="ct-apply" data-id="${metric.id}" ${(metric.compare==='combined'||metric.id==='pe')&&!isCustom ? 'disabled' : ''}>✓</button>
        </div>
        <div class="metric-footer">
            <span class="metric-threshold" id="${metric.id}-threshold">${thresholdText}</span>
            <span class="metric-status neutral" id="${metric.id}-status">${ICONS.minus}</span>
        </div>
    `;
    return card;
}

function getThresholdText(metric) {
    if(metric.id==='gross-margin') return 'סף: > 30% (או צמיחה > 3%)';
    if(metric.id==='pe') {
        const t = currentMode==='growth'?25:currentMode==='value'?10:15;
        return `סף: < ${t}`;
    }
    const prefix = metric.compare==='above'?'> ':'< ';
    return `סף: ${prefix}${metric.threshold}${metric.unit||''}`;
}

function renderBaseCards() {
    const containers = {
        profitability: document.getElementById('profitability-body'),
        growth: document.getElementById('growth-body'),
        valuation: document.getElementById('valuation-body'),
        stability: document.getElementById('stability-body')
    };
    baseMetrics.forEach((m, i) => {
        const card = buildMetricCard(m);
        card.style.animationDelay = `${0.05 * i}s`;
        containers[m.category]?.appendChild(card);
    });
}

// ═══════════════════════════════════════════
// GAUGE FUNCTIONS
// ═══════════════════════════════════════════
const ARC = 282.743;
function updateGauge(pct) {
    const p = Math.max(0,Math.min(100, isNaN(pct)?0:pct));
    const progress = document.getElementById('gauge-progress');
    const scoreText = document.getElementById('gauge-score-text');
    const labelText = document.getElementById('gauge-label-text');
    if(!progress||!scoreText||!labelText)return;

    progress.setAttribute('stroke-dashoffset', ARC*(1-p/100));
    let gradId, label, color;
    if(p>=75){gradId='gExc';label='מצוין';color='#6366F1';}
    else if(p>=50){gradId='gGood';label='טוב';color='#10B981';}
    else if(p>=25){gradId='gAvg';label='בינוני';color='#F59E0B';}
    else{gradId='gPoor';label='חלש';color='#EF4444';}
    progress.setAttribute('stroke',`url(#${gradId})`);
    scoreText.textContent = Math.round(p);
    scoreText.setAttribute('fill', color);
    labelText.textContent = label;
    labelText.setAttribute('fill', color);
}

function createMiniGauge() {
    const c = document.getElementById('topbar-mini-gauge');
    if(!c) return;
    c.innerHTML = `<svg viewBox="0 0 40 40"><circle cx="20" cy="20" r="16" fill="none" stroke="#E2E8F0" stroke-width="4"/>
        <circle id="mini-g-progress" cx="20" cy="20" r="16" fill="none" stroke="url(#gPoor)" stroke-width="4"
            stroke-dasharray="100.53" stroke-dashoffset="100.53" transform="rotate(-90 20 20)"
            stroke-linecap="round" style="transition:stroke-dashoffset .5s,stroke .5s"/></svg>`;
}
function updateMiniGauge(pct) {
    const el = document.getElementById('mini-g-progress');
    if(!el)return;
    const p=Math.max(0,Math.min(100,isNaN(pct)?0:pct));
    const circ=100.53;
    el.setAttribute('stroke-dashoffset', circ*(1-p/100));
    let gradId;
    if(p>=75)gradId='gExc';else if(p>=50)gradId='gGood';else if(p>=25)gradId='gAvg';else gradId='gPoor';
    el.setAttribute('stroke',`url(#${gradId})`);
}

// ═══════════════════════════════════════════
// CORE UPDATE FUNCTIONS
// ═══════════════════════════════════════════
function updateSingleMetric(metric) {
    const card = document.getElementById(`${metric.id}-card`);
    if(!card) return;
    const inputEl = card.querySelector(`#${metric.inputs[0].id}`);
    if(!inputEl) return;

    let value = parseFloat(inputEl.value);
    let growthValue = NaN;
    if(metric.id==='gross-margin') {
        const gEl = card.querySelector('#gross-margin-growth-value');
        if(gEl) growthValue = parseFloat(gEl.value);
    }
    if(metric.isCustom) customMetricInputs[metric.id] = inputEl.value;

    // Get current threshold
    let threshold = metric.threshold;
    if(isAdvancedMode && customThresholds[metric.id]!==undefined && metric.compare!=='combined' && metric.id!=='pe')
        threshold = customThresholds[metric.id];

    // Update threshold text
    const threshEl = document.getElementById(`${metric.id}-threshold`);
    if(threshEl) {
        if(metric.id==='gross-margin') threshEl.innerHTML='סף: > 30% (או צמיחה > 3%)';
        else if(metric.id==='pe') {
            const t=currentMode==='growth'?25:currentMode==='value'?10:15;
            threshold=t;
            threshEl.textContent=`סף: < ${t}`;
        } else {
            const pre=metric.compare==='above'?'> ':'< ';
            threshEl.innerHTML=`סף: ${pre}${threshold}${metric.unit||''}`;
            if(isAdvancedMode && customThresholds[metric.id]!==undefined && metric.compare!=='combined' && metric.id!=='pe')
                threshEl.innerHTML+=` <span class="custom-tag">מותאם</span>`;
        }
    }

    // Calculate score and pass/fail
    let score=0, meetsThreshold=false;
    const hasVal=!isNaN(value), hasGrowth=!isNaN(growthValue);
    if(hasVal||(metric.id==='gross-margin'&&hasGrowth)){
        try {
            if(metric.isCustom){
                score=metric.evaluate(value);
                meetsThreshold = metric.compare==='above' ? hasVal&&value>=threshold : hasVal&&value<=threshold;
            } else if(metric.id==='gross-margin'){
                score=metric.evaluate(value,growthValue);
                meetsThreshold=(hasVal&&value>30)||(hasGrowth&&growthValue>3&&hasVal&&value>=0);
            } else if(metric.id==='pe'){
                score=metric.evaluate(value,null,currentMode);
                meetsThreshold=hasVal&&value<=threshold&&value>0;
            } else {
                score=metric.evaluate(value);
                meetsThreshold = metric.compare==='above' ? hasVal&&value>=threshold : hasVal&&value<=threshold;
            }
        } catch(e){ score=0; meetsThreshold=false; }
    }
    metricScores[metric.id]=score;

    // Update bar
    const bar=document.getElementById(`${metric.id}-bar`);
    const bscore=document.getElementById(`${metric.id}-bscore`);
    if(bar){bar.style.width=`${score}%`;}
    if(bscore)bscore.textContent=score;

    // Update status
    const status=document.getElementById(`${metric.id}-status`);
    const inputs=card.querySelectorAll('input[type="number"].metric-input');
    inputs.forEach(inp=>inp.classList.remove('pass','fail'));

    if((hasVal&&metric.id!=='gross-margin')||(metric.id==='gross-margin'&&(hasVal||hasGrowth))||(metric.isCustom&&hasVal)){
        if(meetsThreshold){
            status.className='metric-status pass'; status.innerHTML=ICONS.check;
            bar.style.background='var(--success)';
            inputs.forEach(inp=>inp.classList.add('pass'));
            bscore.style.color='var(--success)';
        } else {
            status.className='metric-status fail'; status.innerHTML=ICONS.x;
            bar.style.background='var(--danger)';
            inputs.forEach(inp=>inp.classList.add('fail'));
            bscore.style.color='var(--danger)';
        }
    } else {
        status.className='metric-status neutral'; status.innerHTML=ICONS.minus;
        bar.style.background='var(--text-muted)';
        bscore.style.color='var(--text-muted)';
        metricScores[metric.id]=0;
    }
}

function updateAllMetrics() {
    getAllMetrics().forEach(m=>{try{updateSingleMetric(m)}catch(e){console.error(e)}});
    updateTotalScore(); updateProgress(); updateCategoryStats(); updateRadar(); updateInsights(); updateAllInterpretations();
}

function updateTotalScore() {
    let tws=0,tw=0,mc=0,hasInput=false;
    getAllMetrics().forEach(m=>{
        const s=metricScores[m.id], w=m.weights[currentMode];
        const card=document.getElementById(`${m.id}-card`);
        if(!card)return;
        const inp=card.querySelector(`#${m.inputs[0].id}`);
        let hasIn=inp&&inp.value!=='';
        if(m.id==='gross-margin'){const g=card.querySelector('#gross-margin-growth-value');hasIn=hasIn||(g&&g.value!=='');}
        if(hasIn&&typeof s==='number'&&!isNaN(s)){
            hasInput=true; tws+=s*w; tw+=w;
            const st=document.getElementById(`${m.id}-status`);
            if(st&&st.classList.contains('pass'))mc++;
        }
    });
    const fs=tw>0?Math.round(tws/tw):0;
    updateGauge(fs);
    document.getElementById('topbar-score').textContent=`${fs}%`;
    if(fs!==lastGaugeScore){updateMiniGauge(fs);lastGaugeScore=fs;}

    const statusEl=document.getElementById('score-status');
    if(statusEl){
        if(!hasInput)statusEl.textContent='הזן נתונים לחישוב...';
        else if(fs>=75)statusEl.textContent='החברה מראה איכות פיננסית גבוהה מאוד';
        else if(fs>=50)statusEl.textContent='איכות פיננסית טובה עם פוטנציאל שיפור';
        else if(fs>=25)statusEl.textContent='איכות בינונית — מומלץ לבדוק לעומק';
        else statusEl.textContent='איכות נמוכה — סימני אזהרה משמעותיים';
    }
    const all=getAllMetrics();
    document.getElementById('score-criteria').textContent=`${mc}/${all.length} קריטריונים עומדים בסף`;
    const sumSt=document.getElementById('summary-status-text');
    if(sumSt){
        if(!hasInput)sumSt.textContent='סטטוס: טרם הוזנו נתונים';
        else if(fs>=75)sumSt.textContent=`סטטוס: איכות גבוהה מאוד (${fs}%)`;
        else if(fs>=50)sumSt.textContent=`סטטוס: איכות טובה (${fs}%)`;
        else if(fs>=25)sumSt.textContent=`סטטוס: איכות בינונית (${fs}%)`;
        else sumSt.textContent=`סטטוס: איכות נמוכה (${fs}%)`;
    }
}

function updateProgress() {
    const all=getAllMetrics();
    let filled=0;
    all.forEach(m=>{
        const card=document.getElementById(`${m.id}-card`);if(!card)return;
        const inp=card.querySelector(`#${m.inputs[0].id}`);
        let has=inp&&inp.value!=='';
        if(m.id==='gross-margin'){const g=card.querySelector('#gross-margin-growth-value');has=has||(g&&g.value!=='');}
        if(has)filled++;
    });
    const pf=document.getElementById('progress-fill');
    const ps=document.getElementById('progress-stats');
    if(pf)pf.style.width=`${all.length>0?(filled/all.length)*100:0}%`;
    if(ps)ps.textContent=`${filled}/${all.length} מדדים`;
}

function updateCategoryStats() {
    const all=getAllMetrics();
    const cats=[...new Set(all.map(m=>m.category))];
    cats.forEach(cat=>{
        const cm=all.filter(m=>m.category===cat);
        let f=0;
        cm.forEach(m=>{
            const card=document.getElementById(`${m.id}-card`);if(!card)return;
            const inp=card.querySelector(`#${m.inputs[0].id}`);
            let has=inp&&inp.value!=='';
            if(m.id==='gross-margin'){const g=card.querySelector('#gross-margin-growth-value');has=has||(g&&g.value!=='');}
            if(has)f++;
        });
        const el=document.getElementById(`${cat}-stats`);
        if(el)el.textContent=`${f}/${cm.length}`;
    });
}

// ═══════════════════════════════════════════
// RADAR CHART
// ═══════════════════════════════════════════
function updateRadar() {
    const svg=document.getElementById('radar-svg');if(!svg)return;
    svg.innerHTML='';
    const all=getAllMetrics();
    const mfr=all.filter(m=>metricScores[m.id]>=0&&document.getElementById(`${m.id}-card`)?.querySelector(`#${m.inputs[0].id}`)?.value!=='');
    if(mfr.length<3){
        svg.innerHTML=`<text x="200" y="200" text-anchor="middle" fill="#94A3B8" font-family="Rubik" font-size="13">הזן 3+ מדדים להצגת הגרף</text>`;
        return;
    }
    const cx=200,cy=200,r=150,as=2*Math.PI/mfr.length;
    // Grid
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    [0.25,0.5,0.75,1].forEach(p=>{
        const pts=mfr.map((_,i)=>{const a=i*as-Math.PI/2;return`${cx+r*p*Math.cos(a)},${cy+r*p*Math.sin(a)}`}).join(' ');
        const poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
        poly.setAttribute('points',pts);poly.setAttribute('fill','none');
        poly.setAttribute('stroke','#E2E8F0');poly.setAttribute('stroke-width','1');
        g.appendChild(poly);
    });
    mfr.forEach((_,i)=>{
        const a=i*as-Math.PI/2;
        const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1',cx);ln.setAttribute('y1',cy);
        ln.setAttribute('x2',cx+r*Math.cos(a));ln.setAttribute('y2',cy+r*Math.sin(a));
        ln.setAttribute('stroke','#E2E8F0');ln.setAttribute('stroke-width','1');
        g.appendChild(ln);
    });
    svg.appendChild(g);
    // Threshold (50%)
    const tp=mfr.map((_,i)=>{const a=i*as-Math.PI/2;return`${cx+r*0.5*Math.cos(a)},${cy+r*0.5*Math.sin(a)}`}).join(' ');
    const tpoly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    tpoly.setAttribute('points',tp);tpoly.setAttribute('fill','rgba(99,102,241,0.05)');
    tpoly.setAttribute('stroke','#6366F1');tpoly.setAttribute('stroke-width','1');tpoly.setAttribute('stroke-dasharray','4,4');
    svg.appendChild(tpoly);
    // Data
    const dp=mfr.map((m,i)=>{const a=i*as-Math.PI/2;const s=(metricScores[m.id]||0)/100;return`${cx+r*Math.max(0,s)*Math.cos(a)},${cy+r*Math.max(0,s)*Math.sin(a)}`}).join(' ');
    const dpoly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    dpoly.setAttribute('points',dp);dpoly.setAttribute('fill','rgba(99,102,241,0.5)');
    dpoly.setAttribute('stroke','#6366F1');dpoly.setAttribute('stroke-width','2');
    svg.appendChild(dpoly);
    // Labels
    mfr.forEach((m,i)=>{
        const a=i*as-Math.PI/2;const lr=r+18;
        const x=cx+lr*Math.cos(a),y=cy+lr*Math.sin(a);
        let ta='middle',dy='0.35em';
        if(Math.abs(Math.cos(a))<0.1){ta='middle';dy=Math.sin(a)>0?'0.8em':'-0.1em';}
        else if(Math.cos(a)>0)ta='start';else ta='end';
        const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x',x);txt.setAttribute('y',y);txt.setAttribute('text-anchor',ta);
        txt.setAttribute('dominant-baseline','middle');txt.setAttribute('dy',dy);
        txt.setAttribute('font-family','Rubik');txt.setAttribute('font-size','11');txt.setAttribute('fill','#64748B');
        let nm=m.name;if(nm.length>16)nm=nm.substring(0,14)+'…';
        txt.textContent=nm;
        svg.appendChild(txt);
    });
}

// ═══════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════
function showToast(msg, type='success', dur=3000) {
    const c=document.getElementById('toast-container');
    if(!c) return;
    const t=document.createElement('div');
    t.className=`toast ${type}`;
    const icon=type==='success'?ICONS.checkCircle:type==='error'?ICONS.xCircle:ICONS.alertCircle;
    t.innerHTML=`${icon}<span>${msg}</span>`;
    c.appendChild(t);
    requestAnimationFrame(()=>t.classList.add('show'));
    
    const removeToast = () => {
        t.classList.remove('show');
        setTimeout(() => {
            if(t.parentNode) t.parentNode.removeChild(t);
        }, 300);
    };
    
    setTimeout(removeToast, dur);
}

// ═══════════════════════════════════════════
// MODAL HELPERS
// ═══════════════════════════════════════════
function openModal(id){const m=document.getElementById(id);if(m){m.classList.add('open');document.body.style.overflow='hidden';}}
function closeModal(id){const m=document.getElementById(id);if(m){m.classList.remove('open');document.body.style.overflow='';}}

// ═══════════════════════════════════════════
// TEMPLATES
// ═══════════════════════════════════════════
function renderTemplateButtons() {
    const c=document.getElementById('template-btns');if(!c)return;
    c.innerHTML='';
    Object.keys(industryTemplates).forEach(k=>{
        const btn=document.createElement('button');
        btn.className=`template-btn${k===activeTemplate?' active':''}`;
        btn.dataset.template=k;
        btn.textContent=industryTemplates[k].name;
        btn.onclick=()=>{activeTemplate=k;renderTemplateButtons();renderTemplateMetrics();}
        c.appendChild(btn);
    });
    renderTemplateMetrics();
}
function renderTemplateMetrics() {
    const t=industryTemplates[activeTemplate];if(!t)return;
    document.getElementById('template-desc').textContent=t.desc;
    const grid=document.getElementById('template-grid');grid.innerHTML='';
    const vals=t.values[currentMode];if(!vals)return;
    baseMetrics.forEach(m=>{
        const v=vals[m.id], gv=vals['gross-margin-growth'];
        if(v===undefined&&!(m.id==='gross-margin'&&gv!==undefined))return;
        const item=document.createElement('div');item.className='template-item';
        let displayVal='-';
        if(v!==undefined){
            if(v===-1&&m.id==='fcf-yield')displayVal='לא רלוונטי';
            else{const dec=(['peg','de','cr','altman-z'].includes(m.id))?2:1;displayVal=`${v.toFixed(dec)}${m.unit||''}`;}
        }
        if(m.id==='gross-margin'&&gv!==undefined)displayVal+=` (צמיחה: ${gv.toFixed(1)}%)`;
        item.innerHTML=`<span class="template-item-name">${m.name}</span><span class="template-item-val">${displayVal}</span>`;
        grid.appendChild(item);
    });
}
function applyTemplate() {
    const t=industryTemplates[activeTemplate];if(!t)return;
    const vals=t.values[currentMode];if(!vals)return;
    let changed=[];
    baseMetrics.forEach(m=>{
        const inp=document.getElementById(m.inputs[0].id);
        const tv=vals[m.id];
        if(inp&&tv!==undefined&&tv!==-1){if(String(inp.value)!==String(tv)){inp.value=tv;changed.push(inp);}}
        else if(inp&&tv===-1){if(inp.value!==''){inp.value='';changed.push(inp);}}
        if(m.id==='gross-margin'){
            const gi=document.getElementById('gross-margin-growth-value');
            const gtv=vals['gross-margin-growth'];
            if(gi&&gtv!==undefined&&String(gi.value)!==String(gtv)){gi.value=gtv;changed.push(gi);}
        }
    });
    if(changed.length){
        updateAllMetrics();
        changed.forEach(inp=>{inp.classList.add('input-highlighted');setTimeout(()=>inp.classList.remove('input-highlighted'),800)});
        showToast('תבנית הוחלה בהצלחה');
    } else showToast('הערכים כבר תואמים לתבנית','warning');
    closeModal('templates-modal');
}

// ═══════════════════════════════════════════
// TERMINOLOGY
// ═══════════════════════════════════════════
function renderTerms(tabId) {
    const data=termsData[tabId];if(!data)return;
    const c=document.getElementById('terms-content');
    c.innerHTML='';
    data.forEach(t=>{
        c.innerHTML+=`<div class="term-item" data-term-id="${t.id}">
            <div class="term-name"><span>${t.name}</span><span class="term-formula">${t.formula}</span></div>
            <div class="term-desc">${t.desc}</div>
        </div>`;
    });
}
function showTermDetails(termId) {
    const mapping={roi:'terms-profit',roe:'terms-profit','gross-margin':'terms-profit',pm:'terms-profit','fcf-yield':'terms-profit','fcf-growth':'terms-growth','eps-growth':'terms-growth',buyback:'terms-growth','pe-ratio':'terms-valuation','peg-ratio':'terms-valuation',cr:'terms-stability',de:'terms-stability','altman-z':'terms-stability'};
    const tabId=mapping[termId];if(!tabId)return;
    openModal('terms-modal');
    document.querySelectorAll('#terms-tabs .modal-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tabId));
    renderTerms(tabId);
    setTimeout(()=>{
        const item=document.querySelector(`#terms-content .term-item[data-term-id="${termId}"]`);
        if(item){item.scrollIntoView({behavior:'smooth',block:'center'});item.style.transition='background .5s';item.style.background='var(--primary-bg)';setTimeout(()=>item.style.background='',1000);}
    },150);
}

// ═══════════════════════════════════════════
// SUMMARY
// ═══════════════════════════════════════════
function updateSummary() {
    const grid=document.getElementById('summary-grid');if(!grid)return;grid.innerHTML='';
    const cn=document.getElementById('company-name')?.value||'חברה ללא שם';
    document.getElementById('summary-company').textContent=`סיכום: ${cn}`;
    let hasData=false;
    getAllMetrics().forEach(m=>{
        const card=document.getElementById(`${m.id}-card`);if(!card)return;
        const inp=card.querySelector(`#${m.inputs[0].id}`);
        let v=NaN,gv=NaN;
        if(inp)v=parseFloat(inp.value);
        if(m.id==='gross-margin'){const g=card.querySelector('#gross-margin-growth-value');if(g)gv=parseFloat(g.value);}
        if(isNaN(v)&&!(m.id==='gross-margin'&&!isNaN(gv)))return;
        hasData=true;
        const st=document.getElementById(`${m.id}-status`);
        const pass=st&&st.classList.contains('pass');
        let dv='-';
        if(!isNaN(v)){const dec=['peg','de','cr','altman-z'].includes(m.id)?2:1;dv=`${v.toFixed(dec)}${m.unit||''}`;}
        if(m.id==='gross-margin'&&!isNaN(gv))dv+=` (צמיחה: ${gv.toFixed(1)}%)`;
        grid.innerHTML+=`<div class="summary-item"><div class="summary-item-name">${m.name}</div><div class="summary-item-value" style="color:${pass?'var(--success)':'var(--danger)'}"><span style="width:16px;height:16px;display:inline-flex">${pass?ICONS.check:ICONS.x}</span>${dv}</div></div>`;
    });
    if(!hasData)grid.innerHTML='<div class="summary-item"><div class="summary-item-name">לא הוזנו נתונים</div><div class="summary-item-value">-</div></div>';
}

// ═══════════════════════════════════════════
// SAVE / LOAD / RESET
// ═══════════════════════════════════════════
function getHistory() {
    try {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
    } catch(e) {
        console.warn('Failed to read history:', e.message);
        return [];
    }
}

function saveHistory(h) {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(h.slice(0, MAX_HIST)));
    } catch(e) {
        console.warn('Failed to save history:', e.message);
        showToast('שגיאה בשמירה - ייתכן שהזיכרון מלא', 'error');
    }
}

function saveAnalysis() {
    const data={id:`a_${Date.now()}`,ver:6,ts:new Date().toISOString(),company:document.getElementById('company-name')?.value.trim()||'ללא שם',mode:currentMode,notes:document.getElementById('user-notes')?.value||'',isAdv:isAdvancedMode,ct:{...customThresholds},base:{},customDefs:[...customMetricsData],customVals:{...customMetricInputs}};
    baseMetrics.forEach(m=>{const inp=document.getElementById(m.inputs[0].id);if(inp)data.base[m.id]=inp.value;if(m.id==='gross-margin'){const g=document.getElementById('gross-margin-growth-value');if(g)data.base['gross-margin-growth']=g.value;}});
    const h=getHistory();h.unshift(data);saveHistory(h);
    showToast(`"${data.company}" נשמר בהצלחה`);
}

function loadAnalysis(id) {
    const h=getHistory(),a=h.find(x=>x.id===id);
    if(!a||a.ver<6){showToast('פורמט שמירה ישן או לא נמצא','error');return;}
    document.getElementById('custom-body').innerHTML='';
    customMetricsData=[];customMetricInputs={};
    document.getElementById('company-name').value=a.company||'';
    document.getElementById('user-notes').value=a.notes||'';
    isAdvancedMode=a.isAdv||false;customThresholds=a.ct||{};
    const toggle=document.getElementById('advanced-toggle');
    toggle.classList.toggle('active',isAdvancedMode);toggle.setAttribute('aria-checked',isAdvancedMode);
    document.querySelectorAll('.custom-threshold').forEach(el=>el.classList.toggle('visible',isAdvancedMode));
    switchMode(a.mode||'balanced');
    metricScores={};
    baseMetrics.forEach(m=>{const inp=document.getElementById(m.inputs[0].id);if(inp)inp.value=a.base[m.id]!==undefined?a.base[m.id]:'';if(m.id==='gross-margin'){const g=document.getElementById('gross-margin-growth-value');if(g)g.value=a.base['gross-margin-growth']!==undefined?a.base['gross-margin-growth']:'';}});
    if(a.customDefs&&Array.isArray(a.customDefs)){
        customMetricsData=[...a.customDefs];
        customMetricsData.forEach(cm=>{addCustomMetricCard(cm);const inp=document.getElementById(`${cm.id}-value`);if(inp&&a.customVals&&a.customVals[cm.id]!==undefined){inp.value=a.customVals[cm.id];customMetricInputs[cm.id]=inp.value;}});
    }
    document.getElementById('topbar-company').textContent=a.company||'ניתוח חדש';
    updateAllMetrics();
    closeModal('history-modal');
    showToast(`"${a.company}" נטען בהצלחה`);
}

function deleteAnalysis(id) {
    if(!confirm('למחוק שמירה זו?'))return;
    let h=getHistory();h=h.filter(a=>a.id!==id);saveHistory(h);populateHistory();showToast('נמחק','warning');
}

function populateHistory() {
    const list=document.getElementById('history-list'),h=getHistory();
    list.innerHTML='';
    if(!h.length){list.innerHTML='<div class="no-history">לא נמצאו ניתוחים שמורים.</div>';return;}
    h.forEach(a=>{
        const d=new Date(a.ts);
        const item=document.createElement('div');item.className='history-item';
        item.innerHTML=`<div><span class="history-name">${a.company||'ללא שם'}</span><br><span class="history-date">${d.toLocaleDateString('he-IL')} ${d.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})} ${a.ver<6?'(פורמט ישן)':''}</span></div>
        <div class="history-actions"><button class="tool-btn primary" ${a.ver<6?'disabled':''} data-load="${a.id}"><span>טען</span></button><button class="tool-btn danger" data-delete="${a.id}">${ICONS.trash}</button></div>`;
        list.appendChild(item);
    });
    list.querySelectorAll('[data-load]').forEach(b=>b.onclick=()=>loadAnalysis(b.dataset.load));
    list.querySelectorAll('[data-delete]').forEach(b=>b.onclick=e=>{e.stopPropagation();deleteAnalysis(b.dataset.delete)});
}

function resetAll() {
    if(!confirm('לאפס את כל הנתונים? פעולה זו אינה הפיכה.'))return;
    document.getElementById('company-name').value='';
    document.getElementById('user-notes').value='';
    getAllMetrics().forEach(m=>{
        const card=document.getElementById(`${m.id}-card`);if(!card)return;
        card.querySelectorAll('input[type="number"]').forEach(inp=>inp.value='');
    });
    document.getElementById('custom-body').innerHTML='';
    customMetricsData=[];customMetricInputs={};metricScores={};customThresholds={};
    isAdvancedMode=false;
    const toggle=document.getElementById('advanced-toggle');
    toggle.classList.remove('active');toggle.setAttribute('aria-checked','false');
    document.querySelectorAll('.custom-threshold').forEach(el=>el.classList.remove('visible'));
    switchMode('balanced');
    document.getElementById('topbar-company').textContent='ניתוח חדש';
    updateAllMetrics();saveCustomStorage();
    showToast('הנתונים אופסו','warning');
}


// ═══════════════════════════════════════════
// DUAL COMPANY COMPARISON MODE
// ═══════════════════════════════════════════
let compareMode = false;
let activeCompany = 1;
const companyData = {
    1: { name: 'חברה 1', metrics: {}, score: null },
    2: { name: 'חברה 2', metrics: {}, score: null }
};



function saveCurrentCompanyData(companyNum) {
    const data = {};
    baseMetrics.forEach(m => {
        const inp = document.getElementById(m.inputs[0].id);
        if (inp) data[m.id] = inp.value;
    });
    customMetricsData.forEach(m => {
        const inp = document.getElementById(m.inputs[0].id);
        if (inp) data[m.id] = inp.value;
    });
    companyData[companyNum].metrics = data;
    companyData[companyNum].score = getCurrentScore();
    updateCompanyTabScore(companyNum);
}

function loadCompanyData(companyNum) {
    const data = companyData[companyNum].metrics;
    document.querySelectorAll('.metric-card input[type="number"]').forEach(inp => { inp.value = ''; });
    Object.entries(data).forEach(([metricId, value]) => {
        const metric = baseMetrics.find(m => m.id === metricId) || customMetricsData.find(m => m.id === metricId);
        if (metric) {
            const inp = document.getElementById(metric.inputs[0].id);
            if (inp) inp.value = value;
        }
    });
    updateAllMetrics();
}

function getCurrentScore() {
    const scoreEl = document.querySelector('.score-number');
    return scoreEl ? scoreEl.textContent : '--';
}

function updateCompanyTabScore(companyNum) {
    const scoreEl = document.getElementById(`company${companyNum}-score`);
    if (scoreEl) scoreEl.textContent = companyData[companyNum].score || '--';
}

function switchCompany(companyNum) {
    if (activeCompany === companyNum) return;
    saveCurrentCompanyData(activeCompany);
    activeCompany = companyNum;
    document.querySelectorAll('.company-tab').forEach(tab => {
        tab.classList.toggle('active', parseInt(tab.dataset.company) === companyNum);
    });
    loadCompanyData(companyNum);
    showToast(`עבר ל${companyData[companyNum].name}`);
}

function editCompanyName(companyNum) {
    const currentName = companyData[companyNum].name;
    const newName = prompt('הזן שם חברה:', currentName);
    if (newName && newName.trim()) {
        companyData[companyNum].name = newName.trim();
        document.getElementById(`company${companyNum}-name`).textContent = newName.trim();
    }
}

function showCompareResults() {
    // Save current company data first
    saveCurrentCompanyData(activeCompany);
    
    const grid = document.getElementById('compare-grid');
    const summary = document.getElementById('compare-summary');
    
    // Build header
    let html = `
        <div style="background:var(--bg);padding:10px 12px;font-weight:700;color:var(--text);">מדד</div>
        <div style="background:var(--bg);padding:10px 12px;font-weight:700;color:var(--text);text-align:center;">${companyData[1].name}</div>
        <div style="background:var(--bg);padding:10px 12px;font-weight:700;color:var(--text);text-align:center;">${companyData[2].name}</div>
    `;
    
    let c1Wins = 0, c2Wins = 0;
    
    // Build rows for each metric
    baseMetrics.forEach(m => {
        const v1 = companyData[1].metrics[m.id] ? parseFloat(companyData[1].metrics[m.id]) : null;
        const v2 = companyData[2].metrics[m.id] ? parseFloat(companyData[2].metrics[m.id]) : null;
        
        let style1 = 'background:var(--surface);padding:10px 12px;text-align:center;';
        let style2 = 'background:var(--surface);padding:10px 12px;text-align:center;';
        
        if (v1 !== null && v2 !== null && !isNaN(v1) && !isNaN(v2)) {
            const better1 = m.compare === 'above' ? v1 > v2 : v1 < v2;
            if (v1 !== v2) {
                if (better1) {
                    style1 += 'background:var(--success-bg);color:var(--success);font-weight:600;';
                    style2 += 'background:var(--danger-bg);color:var(--danger);';
                    c1Wins++;
                } else {
                    style1 += 'background:var(--danger-bg);color:var(--danger);';
                    style2 += 'background:var(--success-bg);color:var(--success);font-weight:600;';
                    c2Wins++;
                }
            }
        }
        
        const display1 = v1 !== null && !isNaN(v1) ? v1.toFixed(1) + (m.unit || '') : '-';
        const display2 = v2 !== null && !isNaN(v2) ? v2.toFixed(1) + (m.unit || '') : '-';
        
        html += `
            <div style="background:var(--surface);padding:10px 12px;font-weight:500;color:var(--text-secondary);font-size:12px;">${m.name}</div>
            <div style="${style1}">${display1}</div>
            <div style="${style2}">${display2}</div>
        `;
    });
    
    grid.innerHTML = html;
    
    // Build summary
    const score1 = companyData[1].score || '--';
    const score2 = companyData[2].score || '--';
    const winner = parseFloat(score1) > parseFloat(score2) ? 1 : parseFloat(score2) > parseFloat(score1) ? 2 : 0;
    
    summary.innerHTML = `
        <div style="background:var(--bg);border-radius:8px;padding:16px;text-align:center;${winner === 1 ? 'border:2px solid var(--success);' : ''}">
            <div style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:8px;">${companyData[1].name} ${winner === 1 ? '🏆' : ''}</div>
            <div style="font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),#818CF8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">${score1}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">מנצחת ב-${c1Wins} מדדים</div>
        </div>
        <div style="background:var(--bg);border-radius:8px;padding:16px;text-align:center;${winner === 2 ? 'border:2px solid var(--success);' : ''}">
            <div style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:8px;">${companyData[2].name} ${winner === 2 ? '🏆' : ''}</div>
            <div style="font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--primary),#818CF8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">${score2}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">מנצחת ב-${c2Wins} מדדים</div>
        </div>
    `;
    
    document.getElementById('compare-view').style.display = 'block';
}

function hideCompareResults() {
    document.getElementById('compare-view').style.display = 'none';
}

// ═══════════════════════════════════════════
// INFOGRAPHICS GALLERY
// ═══════════════════════════════════════════
function openInfographicsGallery() {
    const modal = document.getElementById('infographics-modal');
    const body = document.getElementById('infographics-body');
    
    let html = `
        <div class="info-card"><div class="info-card-title">🎯 ציון קטגוריות</div><div class="info-card-content" id="gallery-rings"></div></div>
        <div class="info-card"><div class="info-card-title">🌡️ מפת חום מדדים</div><div class="info-card-content" id="gallery-heatmap"></div></div>
        <div class="info-card"><div class="info-card-title">⭐ ציון כולל</div><div class="info-card-content" id="gallery-score"></div></div>
        <div class="info-card"><div class="info-card-title">📊 מדדים חזקים וחלשים</div><div class="info-card-content" id="gallery-extremes"></div></div>
        <div class="info-card"><div class="info-card-title">⚠️ סיכום התראות</div><div class="info-card-content" id="gallery-severity"></div></div>
    `;
    body.innerHTML = html;
    populateGalleryContent();
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
}

function populateGalleryContent() {
    const categoryScores = {};
    ['profitability', 'growth', 'valuation', 'stability'].forEach(cat => {
        const cards = document.querySelectorAll(`.metric-card[data-category="${cat}"]`);
        let sum = 0, count = 0;
        cards.forEach(card => {
            const scoreEl = card.querySelector('.score-value');
            if (scoreEl && scoreEl.textContent !== '--') { sum += parseInt(scoreEl.textContent); count++; }
        });
        categoryScores[cat] = count > 0 ? Math.round(sum / count) : 0;
    });
    
    // Rings
    const ringsEl = document.getElementById('gallery-rings');
    if (ringsEl) {
        const catNames = { profitability: 'רווחיות', growth: 'צמיחה', valuation: 'הערכת שווי', stability: 'יציבות' };
        const catColors = { profitability: '#6366F1', growth: '#10B981', valuation: '#F59E0B', stability: '#06B6D4' };
        ringsEl.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;">
            ${Object.entries(categoryScores).map(([cat, score]) => {
                const circumference = 2 * Math.PI * 40;
                const offset = circumference - (score / 100) * circumference;
                return `<div style="text-align:center;"><svg width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="#E2E8F0" stroke-width="8"/><circle cx="50" cy="50" r="40" fill="none" stroke="${catColors[cat]}" stroke-width="8" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" stroke-linecap="round" transform="rotate(-90 50 50)"/><text x="50" y="55" text-anchor="middle" font-size="18" font-weight="700" fill="${catColors[cat]}">${score}</text></svg><div style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-top:4px;">${catNames[cat]}</div></div>`;
            }).join('')}
        </div>`;
    }
    
    // Heatmap
    const heatmapEl = document.getElementById('gallery-heatmap');
    if (heatmapEl) {
        const metricAbbr = { roi: 'ROI', roe: 'ROE', 'gross-margin': 'GM', pm: 'PM', 'fcf-yield': 'FCF%', 'fcf-growth': 'FCFg', 'eps-growth': 'EPSg', buyback: 'BB', pe: 'P/E', peg: 'PEG', cr: 'CR', de: 'D/E', 'altman-z': 'AZ' };
        let heatmapHtml = '<div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;">';
        baseMetrics.forEach(m => {
            const card = document.getElementById(`${m.id}-card`);
            const scoreEl = card?.querySelector('.score-value');
            const score = scoreEl?.textContent !== '--' ? parseInt(scoreEl.textContent) : null;
            const bgColor = score !== null ? (score >= 80 ? '#6366F1' : score >= 60 ? '#10B981' : score >= 40 ? '#F59E0B' : score >= 20 ? '#F97316' : '#DC2626') : '#E2E8F0';
            heatmapHtml += `<div style="width:48px;height:48px;background:${bgColor};border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:${score !== null && score > 50 ? 'white' : 'var(--text)'};">
                <span>${metricAbbr[m.id] || m.id}</span><span style="font-size:12px;font-weight:700;">${score !== null ? score : '-'}</span>
            </div>`;
        });
        heatmapHtml += '</div>';
        heatmapEl.innerHTML = heatmapHtml;
    }
    
    // Score
    const scoreGalleryEl = document.getElementById('gallery-score');
    if (scoreGalleryEl) {
        const currentScore = getCurrentScore();
        const scoreNum = parseInt(currentScore) || 0;
        const scoreColor = scoreNum >= 80 ? '#6366F1' : scoreNum >= 60 ? '#10B981' : scoreNum >= 40 ? '#F59E0B' : '#DC2626';
        scoreGalleryEl.innerHTML = `<div style="text-align:center;padding:20px;"><div style="font-size:64px;font-weight:900;color:${scoreColor};">${currentScore}</div><div style="font-size:14px;color:var(--text-secondary);margin-top:8px;">ציון בריאות פיננסית</div></div>`;
    }
    
    // Extremes
    const extremesEl = document.getElementById('gallery-extremes');
    if (extremesEl) {
        const scores = {};
        baseMetrics.forEach(m => {
            const card = document.getElementById(`${m.id}-card`);
            const scoreEl = card?.querySelector('.score-value');
            if (scoreEl?.textContent !== '--') { scores[m.id] = { name: m.name, score: parseInt(scoreEl.textContent) }; }
        });
        if (Object.keys(scores).length >= 4) {
            const sorted = Object.entries(scores).sort((a, b) => b[1].score - a[1].score);
            const top3 = sorted.slice(0, 3);
            const bottom3 = sorted.slice(-3).reverse();
            extremesEl.innerHTML = `<div style="display:flex;gap:20px;"><div style="flex:1;"><div style="font-size:11px;font-weight:700;color:var(--success);margin-bottom:8px;">💪 חזקים</div>${top3.map(([id, d]) => `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><div style="flex:1;height:8px;background:var(--bg);border-radius:4px;overflow:hidden;"><div style="height:100%;width:${d.score}%;background:var(--success);border-radius:4px;"></div></div><span style="font-size:11px;color:var(--text-secondary);min-width:40px;">${d.name.split(' ')[0]}</span><span style="font-size:12px;font-weight:700;color:var(--success);">${d.score}</span></div>`).join('')}</div><div style="flex:1;"><div style="font-size:11px;font-weight:700;color:var(--danger);margin-bottom:8px;">⚠️ חלשים</div>${bottom3.map(([id, d]) => `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><div style="flex:1;height:8px;background:var(--bg);border-radius:4px;overflow:hidden;"><div style="height:100%;width:${d.score}%;background:var(--danger);border-radius:4px;"></div></div><span style="font-size:11px;color:var(--text-secondary);min-width:40px;">${d.name.split(' ')[0]}</span><span style="font-size:12px;font-weight:700;color:var(--danger);">${d.score}</span></div>`).join('')}</div></div>`;
        } else { extremesEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">הזן לפחות 4 מדדים</div>'; }
    }
    
    // Severity
    const severityEl = document.getElementById('gallery-severity');
    if (severityEl && typeof evaluateInsights === 'function') {
        try {
            const insights = evaluateInsights();
            const counts = { critical: 0, warning: 0, positive: 0, info: 0 };
            insights.forEach(i => counts[i.severity]++);
            severityEl.innerHTML = `<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                <div style="text-align:center;padding:12px 16px;background:${counts.critical > 0 ? '#FEE2E2' : 'var(--bg)'};border-radius:8px;min-width:60px;"><div style="font-size:24px;font-weight:800;color:${counts.critical > 0 ? '#DC2626' : 'var(--text-muted)'};">${counts.critical}</div><div style="font-size:10px;color:var(--text-muted);">קריטי</div></div>
                <div style="text-align:center;padding:12px 16px;background:${counts.warning > 0 ? '#FEF3C7' : 'var(--bg)'};border-radius:8px;min-width:60px;"><div style="font-size:24px;font-weight:800;color:${counts.warning > 0 ? '#D97706' : 'var(--text-muted)'};">${counts.warning}</div><div style="font-size:10px;color:var(--text-muted);">אזהרה</div></div>
                <div style="text-align:center;padding:12px 16px;background:${counts.positive > 0 ? '#D1FAE5' : 'var(--bg)'};border-radius:8px;min-width:60px;"><div style="font-size:24px;font-weight:800;color:${counts.positive > 0 ? '#059669' : 'var(--text-muted)'};">${counts.positive}</div><div style="font-size:10px;color:var(--text-muted);">חיובי</div></div>
                <div style="text-align:center;padding:12px 16px;background:${counts.info > 0 ? '#DBEAFE' : 'var(--bg)'};border-radius:8px;min-width:60px;"><div style="font-size:24px;font-weight:800;color:${counts.info > 0 ? '#2563EB' : 'var(--text-muted)'};">${counts.info}</div><div style="font-size:10px;color:var(--text-muted);">מידע</div></div>
            </div>`;
        } catch (e) { severityEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">הזן מדדים לקבלת תובנות</div>'; }
    }
}

function closeInfographicsGallery() {
    document.getElementById('infographics-modal')?.classList.remove('open');
    document.body.style.overflow = '';
}

// ═══════════════════════════════════════════
// ENHANCED CSV FUNCTIONS
// ═══════════════════════════════════════════
function openCSVModal() {
    document.getElementById('csv-modal')?.classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closeCSVModal() {
    document.getElementById('csv-modal')?.classList.remove('open');
    document.body.style.overflow = '';
}

function downloadCurrentDataCSV() {
    const companyName = compareMode ? companyData[activeCompany].name : 'Company';
    const headers = ['company_name'];
    const values = [companyName];
    
    baseMetrics.forEach(m => {
        headers.push(m.id.replace(/-/g, '_'));
        const inp = document.getElementById(m.inputs[0].id);
        values.push(inp?.value || '');
    });
    customMetricsData.forEach(m => {
        headers.push(m.id.replace(/-/g, '_').replace('opt_', ''));
        const inp = document.getElementById(m.inputs[0].id);
        values.push(inp?.value || '');
    });
    
    let csv = '\uFEFF' + headers.join(',') + '\r\n' + values.join(',') + '\r\n';
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${companyName.replace(/\s+/g, '_')}_financial_data.csv`;
    link.click();
    closeCSVModal();
    showToast('הנתונים הורדו כ-CSV');
}

function downloadEmptyTemplate() {
    const headers = ['company_name'];
    baseMetrics.forEach(m => headers.push(m.id.replace(/-/g, '_')));
    let csv = '\uFEFF' + headers.join(',') + '\r\n' + headers.map(() => '').join(',') + '\r\n';
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'financial_template.csv';
    link.click();
    closeCSVModal();
    showToast('תבנית CSV הורדה');
}

function generateAIPrompt() {
    const companyName = document.getElementById('company-name')?.value?.trim() || '';
    
    const prompt = `I need financial data for ${companyName ? `"${companyName}"` : '[COMPANY NAME - please specify]'} to calculate a Financial Health Score.

## IMPORTANT INSTRUCTIONS:
1. **DO NOT OMIT DATA** - If you cannot calculate a metric directly, use data from financial websites like:
   - macrotrends.net
   - stockanalysis.com
   - gurufocus.com
   - morningstar.com
   - yahoo finance
   - Simply Wall St
   
2. **PREFER ESTIMATION OVER OMISSION** - A reasonable estimate from a reputable source is better than leaving a field empty.

3. **RETURN A DOWNLOADABLE CSV FILE** - Your response must include an actual downloadable CSV file, not just text.

## THE 13 REQUIRED METRICS:

### PROFITABILITY (5 metrics)
| Metric | Formula | Unit | Good Value | Data Sources |
|--------|---------|------|------------|--------------|
| ROI | Net Income ÷ Total Assets × 100 (or use ROIC/ROCE as proxy) | % | >10% | macrotrends.net, gurufocus |
| ROE | Net Income ÷ Shareholders Equity × 100 | % | >15% | Most financial sites |
| Gross Margin | (Revenue - COGS) ÷ Revenue × 100 | % | >30% | Income statement |
| Net Profit Margin (PM) | Net Income ÷ Revenue × 100 | % | >10% | Income statement |
| FCF Yield | Free Cash Flow per Share ÷ Stock Price × 100 | % | >5% | stockanalysis.com, gurufocus |

### GROWTH (3 metrics)
| Metric | Formula | Unit | Good Value | Data Sources |
|--------|---------|------|------------|--------------|
| FCF Growth 5Y | 5-year CAGR of Free Cash Flow | % | >10% | macrotrends.net (FCF history) |
| EPS Growth 5Y | 5-year CAGR of Earnings Per Share | % | >8% | macrotrends.net, stockanalysis |
| Buyback Yield | Annual Buybacks ÷ Market Cap × 100 | % | >1% | Cash flow statement, gurufocus |

### VALUATION (2 metrics)
| Metric | Formula | Unit | Good Value | Data Sources |
|--------|---------|------|------------|--------------|
| P/E Ratio | Stock Price ÷ EPS | ratio | <15-25 | Everywhere |
| PEG Ratio | P/E ÷ Expected EPS Growth Rate | ratio | <1 | yahoo finance, morningstar |

### STABILITY (3 metrics)
| Metric | Formula | Unit | Good Value | Data Sources |
|--------|---------|------|------------|--------------|
| Current Ratio | Current Assets ÷ Current Liabilities | ratio | 1.5-3.0 | Balance sheet |
| Debt/Equity | Total Debt ÷ Shareholders Equity | ratio | <0.5 | Balance sheet |
| Altman Z-Score | Complex formula (5 ratios) | score | >2.99 safe | gurufocus, stockanalysis |

## METRIC-SPECIFIC GUIDANCE:

**ROI**: If "Return on Investment" isn't directly available:
- Use ROIC (Return on Invested Capital) - very common
- Use ROCE (Return on Capital Employed)  
- Calculate: Net Income ÷ (Total Assets - Current Liabilities) × 100
- macrotrends.net often has this under "Return on Investment"

**Altman Z-Score**: If not directly available:
- gurufocus.com usually has it
- stockanalysis.com has it
- Or calculate: 1.2×(WC/TA) + 1.4×(RE/TA) + 3.3×(EBIT/TA) + 0.6×(MVE/TL) + 1.0×(Sales/TA)

**FCF Growth / EPS Growth**: 
- Go to macrotrends.net → search company → "Free Cash Flow" or "EPS - Earnings Per Share"
- Calculate CAGR from 5 years ago to now: ((End/Start)^(1/5) - 1) × 100

## REQUIRED OUTPUT FORMAT:

Create a downloadable CSV file with this exact structure:

\`\`\`
company_name,roi,roe,gross_margin,pm,fcf_yield,fcf_growth,eps_growth,buyback,pe,peg,cr,de,altman_z
${companyName || 'COMPANY_NAME'},ROI_VALUE,ROE_VALUE,GM_VALUE,PM_VALUE,FCF_YIELD,FCF_GROWTH,EPS_GROWTH,BUYBACK,PE,PEG,CR,DE,ALTMAN_Z
\`\`\`

## RULES:
1. Use the most recent TTM (Trailing Twelve Months) or annual data
2. Round to 1-2 decimal places
3. For ratios (P/E, PEG, CR, D/E, Altman Z) - no % sign, just the number
4. For percentages (ROI, ROE, margins, yields, growth) - just the number without % sign
5. **NEVER leave a field empty if data exists ANYWHERE online**
6. If using a proxy metric (like ROIC for ROI), note it but still provide the value
7. Cite your sources briefly

## EXAMPLE OUTPUT:
\`\`\`csv
company_name,roi,roe,gross_margin,pm,fcf_yield,fcf_growth,eps_growth,buyback,pe,peg,cr,de,altman_z
Apple Inc,28.5,147.3,43.8,25.3,3.8,12.4,9.2,2.8,28.5,2.1,0.99,1.81,5.2
\`\`\`

Please provide the CSV file for download along with a brief summary of where you found each metric.`;

    // Show modal with prompt
    showAIPromptModal(prompt);
}

function showAIPromptModal(prompt) {
    // Remove existing modal if any
    document.getElementById('ai-prompt-modal')?.remove();
    
    const modal = document.createElement('div');
    modal.id = 'ai-prompt-modal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(15,23,42,0.8);backdrop-filter:blur(8px);z-index:1400;display:flex;align-items:center;justify-content:center;padding:20px;';
    
    modal.innerHTML = `
        <div style="background:var(--surface);border-radius:16px;width:100%;max-width:800px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 24px 48px rgba(0,0,0,0.2);">
            <div style="padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
                <div style="display:flex;align-items:center;gap:12px;">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width:22px;height:22px;"><path d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 017 7h1a1 1 0 011 1v3a1 1 0 01-1 1h-1v1a2 2 0 01-2 2H5a2 2 0 01-2-2v-1H2a1 1 0 01-1-1v-3a1 1 0 011-1h1a7 7 0 017-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 012-2z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>
                    </div>
                    <div>
                        <h2 style="font-size:18px;font-weight:700;color:var(--text);margin:0;">AI Prompt Ready</h2>
                        <p style="font-size:13px;color:var(--text-secondary);margin:0;">Copy and paste into ChatGPT, Claude, or any AI</p>
                    </div>
                </div>
                <button onclick="document.getElementById('ai-prompt-modal').remove();document.body.style.overflow='';" style="width:36px;height:36px;border-radius:50%;border:none;background:var(--bg);cursor:pointer;font-size:20px;color:var(--text-muted);display:flex;align-items:center;justify-content:center;">&times;</button>
            </div>
            <div style="padding:20px 24px;overflow-y:auto;flex:1;">
                <div style="position:relative;">
                    <pre id="ai-prompt-text" style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:16px;font-size:12px;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;color:var(--text);max-height:400px;overflow-y:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;">${prompt.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                </div>
            </div>
            <div style="padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;flex-shrink:0;">
                <button onclick="copyAIPrompt()" style="flex:1;padding:14px 20px;background:linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);color:white;border:none;border-radius:10px;font-weight:600;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                    Copy to Clipboard
                </button>
                <button onclick="downloadAIPromptFile()" style="padding:14px 20px;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:10px;font-weight:600;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Download .txt
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
    closeCSVModal();
    
    // Store prompt for copy/download
    window._aiPromptText = prompt;
    
    // Close on background click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
            document.body.style.overflow = '';
        }
    });
}

function copyAIPrompt() {
    const prompt = window._aiPromptText;
    navigator.clipboard.writeText(prompt).then(() => {
        showToast('Copied to clipboard! 📋', 'success');
        // Visual feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
        btn.style.background = 'var(--success)';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.style.background = 'linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%)';
        }, 2000);
    }).catch(() => {
        showToast('Failed to copy - try download instead', 'error');
    });
}

function downloadAIPromptFile() {
    const prompt = window._aiPromptText;
    const companyName = document.getElementById('company-name')?.value?.trim() || 'company';
    const blob = new Blob([prompt], { type: 'text/plain;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ai_prompt_${companyName.replace(/\s+/g, '_')}.txt`;
    link.click();
    showToast('Prompt downloaded!');
}


// ═══════════════════════════════════════════
// CSV
// ═══════════════════════════════════════════
function importCSV(file) {
    if(typeof Papa==='undefined'){showToast('ספריית CSV לא נטענה','error');return;}
    Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>{if(r.data&&r.data.length)applyCsvData(r.data[0],r.meta.fields);else showToast('קובץ CSV ריק','warning')},error:()=>showToast('שגיאה בקריאת CSV','error')});
}
function applyCsvData(data, headers) {
    let count=0;
    const cn=data['שם החברה']||data['Company Name'];
    if(cn){document.getElementById('company-name').value=cn;document.getElementById('topbar-company').textContent=cn;}
    const mode=(data['פרופיל השקעה']||'').toLowerCase();
    if(['growth','balanced','value'].includes(mode))switchMode(mode);
    const notes=data['הערות']||data['Notes'];
    if(notes)document.getElementById('user-notes').value=notes;
    const all=getAllMetrics();
    const expected={};
    all.forEach(m=>{expected[m.id]=m.name;if(m.id==='gross-margin')expected['gross-margin-growth']='צמיחת מרווח גולמי';});
    const mapped={};
    headers.forEach(h=>{
        const ht=h.trim(),hl=ht.toLowerCase();
        let found=Object.keys(expected).find(id=>id.toLowerCase()===hl||(expected[id]&&expected[id].toLowerCase()===hl)||id.replace(/-/g,'_').toLowerCase()===hl);
        if(!found&&(hl==='gross margin growth'||hl==='gross_margin_growth'||hl==='צמיחת מרווח גולמי'))found='gross-margin-growth';
        if(found&&data[ht]!==undefined)mapped[found]=data[ht];
    });
    Object.keys(mapped).forEach(mid=>{
        let inp;
        if(mid==='gross-margin-growth')inp=document.getElementById('gross-margin-growth-value');
        else inp=document.getElementById(`${mid}-value`);
        if(inp){const clean=String(mapped[mid]).replace(/[%$,\s]/g,'').trim();if(!isNaN(parseFloat(clean))&&clean!==inp.value){inp.value=clean;count++;}}
    });
    if(count){updateAllMetrics();showToast(`${count} ערכים יובאו`);}
    else showToast('לא נמצאו נתונים חדשים','warning');
}
function downloadCSVTemplate() {
    let csv='\uFEFF';
    const h=['שם החברה','פרופיל השקעה (growth/balanced/value)','הערות'];
    baseMetrics.forEach(m=>{h.push(m.name);if(m.id==='gross-margin')h.push('צמיחת מרווח גולמי');});
    csv+=h.join(',')+'\r\n';
    const row=['שם חברה','balanced',''];
    baseMetrics.forEach(m=>{row.push('');if(m.id==='gross-margin')row.push('');});
    csv+=row.join(',')+'\r\n';
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download='financial_template.csv';link.click();
    URL.revokeObjectURL(link.href);
    showToast('תבנית CSV הורדה');
}

// ═══════════════════════════════════════════
// CUSTOM METRICS
// ═══════════════════════════════════════════
function saveCustomMetric() {
    const name=document.getElementById('cm-name').value.trim();
    const desc=document.getElementById('cm-desc').value.trim();
    const threshold=parseFloat(document.getElementById('cm-threshold').value);
    const compare=document.getElementById('cm-compare').value;
    const optimal=parseFloat(document.getElementById('cm-optimal').value);
    const worst=parseFloat(document.getElementById('cm-worst').value);
    const wg=parseFloat(document.getElementById('cm-wg').value);
    const wb=parseFloat(document.getElementById('cm-wb').value);
    const wv=parseFloat(document.getElementById('cm-wv').value);
    const unit=document.getElementById('cm-unit').value.trim();
    if(!name){showToast('שם המדד חובה','error');return;}
    if(isNaN(threshold)){showToast('ערך סף חובה','error');return;}
    if(isNaN(optimal)||isNaN(worst)){showToast('ערכי טווח ניקוד חובה','error');return;}
    if(optimal===worst){showToast('הערכים חייבים להיות שונים','error');return;}
    if([wg,wb,wv].some(w=>isNaN(w)||w<0.1||w>2)){showToast('משקלים 0.1–2.0','error');return;}
    const cm={id:`cm_${Date.now()}`,name,description:desc,threshold,compare,optimalValue:optimal,worstValue:worst,weights:{growth:wg,balanced:wb,value:wv},unit,inputs:[{id:`cm_${Date.now()}-value`,step:0.1,unit:unit||undefined}]};
    customMetricsData.push(cm);saveCustomStorage();
    addCustomMetricCard(cm);updateAllMetrics();closeModal('custom-modal');
    showToast(`"${name}" נוסף`);
}
function addCustomMetricCard(cmDef) {
    const container=document.getElementById('custom-body');
    const fullMetric={...cmDef,category:'custom',isCustom:true,evaluate:v=>evaluateCustom(v,cmDef)};
    const card=buildMetricCard(fullMetric,true);
    container.appendChild(card);
    // Bind events
    const inp=card.querySelector(`#${cmDef.inputs[0].id}`);
    if(inp)inp.addEventListener('input',()=>{updateSingleMetric(fullMetric);updateTotalScore();updateProgress();updateCategoryStats();updateRadar();});
    const delBtn=card.querySelector('.delete-metric-btn');
    if(delBtn)delBtn.onclick=()=>deleteCustomMetric(cmDef.id);
    const ctBtn=card.querySelector('.ct-apply');
    if(ctBtn)ctBtn.onclick=()=>{
        const ctInp=card.querySelector(`#${cmDef.id}-ct-input`);
        const nv=parseFloat(ctInp?.value);
        if(!isNaN(nv)){customThresholds[cmDef.id]=nv;updateSingleMetric(fullMetric);updateTotalScore();showToast('סף עודכן');}
        else{delete customThresholds[cmDef.id];if(ctInp)ctInp.value='';updateSingleMetric(fullMetric);updateTotalScore();showToast('סף אופס','warning');}
    };
}
function deleteCustomMetric(id) {
    if(!confirm('למחוק מדד זה?'))return;
    setTimeout(renderOptionalMetricsPicker, 100);
    customMetricsData=customMetricsData.filter(m=>m.id!==id);
    delete customMetricInputs[id];delete metricScores[id];delete customThresholds[id];
    document.getElementById(`${id}-card`)?.remove();
    saveCustomStorage();updateAllMetrics();showToast('המדד נמחק','warning');
}
function loadCustomStorage(){try{const d=JSON.parse(localStorage.getItem(CUSTOM_KEY));if(Array.isArray(d)){customMetricsData=d;d.forEach(cm=>{if(!cm.optimalValue)cm.optimalValue=cm.threshold*2;if(!cm.worstValue)cm.worstValue=0;addCustomMetricCard(cm);});}}catch(e){customMetricsData=[];}}
function saveCustomStorage(){localStorage.setItem(CUSTOM_KEY,JSON.stringify(customMetricsData))}

// ═══════════════════════════════════════════
// MODE SWITCHING
// ═══════════════════════════════════════════
function switchMode(mode) {
    currentMode=mode;
    document.querySelectorAll('.mode-tab').forEach(b=>b.classList.toggle('active',b.dataset.mode===mode));
    updateAllMetrics();
    if(document.getElementById('templates-modal').classList.contains('open'))renderTemplateMetrics();
}

// ═══════════════════════════════════════════
// METRIC DEEP-DIVE DATA
// ═══════════════════════════════════════════

// NOTE: Dual company comparison mode variables are defined above (around line 4287)
// Do not redeclare companyData, compareMode, or activeCompany here

function toggleCompareMode() {
    compareMode = !compareMode;
    const tabsBar = document.getElementById('company-tabs-bar');
    
    if (compareMode) {
        tabsBar.style.display = 'flex';
        saveCurrentCompanyData(1);
        showToast('מצב השוואה הופעל. מלא נתונים לחברה 1, לחץ על "חברה 2" כדי לעבור.');
    } else {
        tabsBar.style.display = 'none';
        document.getElementById('compare-view').style.display = 'none';
        showToast('מצב השוואה כובה');
    }
}

function saveCurrentToCompany(companyNum) {
    const data = {};
    baseMetrics.forEach(m => {
        const inp = document.getElementById(m.inputs[0].id);
        if (inp && inp.value !== '') {
            data[m.id] = parseFloat(inp.value);
        }
    });
    customMetricsData.forEach(m => {
        const inp = document.getElementById(m.inputs[0].id);
        if (inp && inp.value !== '') {
            data[m.id] = parseFloat(inp.value);
        }
    });
    companyData[companyNum].metrics = data;
    companyData[companyNum].score = calculateTotalScoreValue();
    updateCompanyTabDisplay(companyNum);
}

function loadCompanyData(companyNum) {
    const data = companyData[companyNum].metrics;
    baseMetrics.forEach(m => {
        const inp = document.getElementById(m.inputs[0].id);
        if (inp) inp.value = '';
    });
    customMetricsData.forEach(m => {
        const inp = document.getElementById(m.inputs[0].id);
        if (inp) inp.value = '';
    });
    Object.entries(data).forEach(([id, value]) => {
        const metric = baseMetrics.find(m => m.id === id) || customMetricsData.find(m => m.id === id);
        if (metric) {
            const inp = document.getElementById(metric.inputs[0].id);
            if (inp) inp.value = value;
        }
    });
    updateAllMetrics();
}

function calculateTotalScoreValue() {
    let total = 0, count = 0;
    document.querySelectorAll('.metric-score').forEach(el => {
        const val = parseInt(el.textContent);
        if (!isNaN(val)) { total += val; count++; }
    });
    return count > 0 ? Math.round(total / count) : null;
}

function switchCompany(companyNum) {
    if (currentCompany === companyNum) return;
    saveCurrentToCompany(currentCompany);
    currentCompany = companyNum;
    document.querySelectorAll('.company-tab').forEach((tab, i) => {
        tab.classList.toggle('active', i + 1 === companyNum);
    });
    loadCompanyData(companyNum);
}

function updateCompanyTabDisplay(companyNum) {
    const nameEl = document.getElementById(`company-${companyNum}-name`);
    const scoreEl = document.getElementById(`company-${companyNum}-score`);
    const data = companyData[companyNum];
    if (nameEl) nameEl.textContent = data.name;
    if (scoreEl) {
        const metricCount = Object.keys(data.metrics).length;
        if (data.score !== null) {
            scoreEl.textContent = `ציון: ${data.score} | ${metricCount} מדדים`;
        } else {
            scoreEl.textContent = metricCount > 0 ? `${metricCount} מדדים` : 'טרם הוזנו נתונים';
        }
    }
}

function editCompanyName(companyNum) {
    const newName = prompt('הזן שם חברה:', companyData[companyNum].name);
    if (newName && newName.trim()) {
        companyData[companyNum].name = newName.trim();
        updateCompanyTabDisplay(companyNum);
    }
}

function showComparisonView() {
    saveCurrentToCompany(currentCompany);
    const grid = document.getElementById('comparison-grid');
    const view = document.getElementById('comparison-view');
    
    let html = `
        <div class="cg-header">מדד</div>
        <div class="cg-header">${companyData[1].name}</div>
        <div class="cg-header">${companyData[2].name}</div>
    `;
    
    const allMetrics = [...baseMetrics, ...customMetricsData];
    
    allMetrics.forEach(m => {
        const val1 = companyData[1].metrics[m.id];
        const val2 = companyData[2].metrics[m.id];
        
        if (val1 !== undefined || val2 !== undefined) {
            let class1 = 'equal', class2 = 'equal';
            
            if (val1 !== undefined && val2 !== undefined) {
                const higher = m.compare === 'below' ? 'worse' : 'better';
                const lower = m.compare === 'below' ? 'better' : 'worse';
                
                if (val1 > val2) { class1 = higher; class2 = lower; }
                else if (val2 > val1) { class2 = higher; class1 = lower; }
            }
            
            html += `
                <div class="cg-metric">${m.name}</div>
                <div class="cg-value ${class1}">${val1 !== undefined ? val1.toFixed(1) + (m.unit || '') : '—'}</div>
                <div class="cg-value ${class2}">${val2 !== undefined ? val2.toFixed(1) + (m.unit || '') : '—'}</div>
            `;
        }
    });
    
    html += `
        <div class="cg-metric" style="font-weight:700;">ציון כולל</div>
        <div class="cg-value ${companyData[1].score > companyData[2].score ? 'better' : companyData[1].score < companyData[2].score ? 'worse' : ''}" style="font-size:18px;font-weight:700;">${companyData[1].score || '—'}</div>
        <div class="cg-value ${companyData[2].score > companyData[1].score ? 'better' : companyData[2].score < companyData[1].score ? 'worse' : ''}" style="font-size:18px;font-weight:700;">${companyData[2].score || '—'}</div>
    `;
    
    grid.innerHTML = html;
    view.classList.add('visible');
}

function hideComparisonView() {
    document.getElementById('comparison-view').classList.remove('visible');
}

// ═══════════════════════════════════════════
// INFOGRAPHICS GALLERY
// ═══════════════════════════════════════════
function openInfographicsModal() {
    const body = document.getElementById('infographics-body');
    
    let html = '';
    
    html += `
        <div class="infographic-card">
            <h3>🎯 ציון לפי קטגוריה</h3>
            <div id="gallery-rings" style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;"></div>
        </div>
    `;
    
    html += `
        <div class="infographic-card">
            <h3>🌡️ מפת חום מדדים</h3>
            <div id="gallery-heatmap" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;"></div>
        </div>
    `;
    
    html += `
        <div class="infographic-card">
            <h3>💪 חזקים וחלשים</h3>
            <div id="gallery-extremes"></div>
        </div>
    `;
    
    html += `
        <div class="infographic-card">
            <h3>📡 תרשים רדאר</h3>
            <div style="text-align:center;">
                <canvas id="gallery-radar" width="280" height="280"></canvas>
            </div>
        </div>
    `;
    
    html += `
        <div class="infographic-card">
            <h3>🎯 ציון כולל</h3>
            <div id="gallery-gauge" style="text-align:center;"></div>
        </div>
    `;
    
    html += `
        <div class="infographic-card">
            <h3>💡 סיכום תובנות</h3>
            <div id="gallery-insights"></div>
        </div>
    `;
    
    body.innerHTML = html;
    
    setTimeout(() => {
        populateGalleryInfographics();
    }, 100);
    
    document.getElementById('infographics-modal').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function populateGalleryInfographics() {
    const values = typeof getInsightValues === 'function' ? getInsightValues() : {};
    const scores = {};
    baseMetrics.forEach(m => {
        const scoreEl = document.getElementById(`${m.id}-card`)?.querySelector('.metric-score');
        if (scoreEl) scores[m.id] = parseInt(scoreEl.textContent) || 0;
    });
    
    const catScores = { profitability: [], growth: [], valuation: [], stability: [] };
    baseMetrics.forEach(m => {
        if (scores[m.id] !== undefined) catScores[m.category]?.push(scores[m.id]);
    });
    
    const ringContainer = document.getElementById('gallery-rings');
    if (ringContainer) {
        const catNames = { profitability: 'רווחיות', growth: 'צמיחה', valuation: 'הערכת שווי', stability: 'יציבות' };
        const catColors = { profitability: '#6366F1', growth: '#10B981', valuation: '#F59E0B', stability: '#DC2626' };
        
        let ringsHtml = '';
        Object.entries(catScores).forEach(([cat, arr]) => {
            const avg = arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
            const circumference = 2 * Math.PI * 36;
            const offset = circumference - (avg / 100) * circumference;
            
            ringsHtml += `
                <div style="text-align:center;">
                    <svg width="90" height="90" viewBox="0 0 90 90">
                        <circle cx="45" cy="45" r="36" fill="none" stroke="#E2E8F0" stroke-width="8"/>
                        <circle cx="45" cy="45" r="36" fill="none" stroke="${catColors[cat]}" stroke-width="8"
                            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                            stroke-linecap="round" transform="rotate(-90 45 45)"
                            style="transition:stroke-dashoffset .8s ease-out"/>
                        <text x="45" y="45" text-anchor="middle" dy="5" font-size="18" font-weight="700" fill="${catColors[cat]}">${avg}</text>
                    </svg>
                    <div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-top:4px;">${catNames[cat]}</div>
                </div>
            `;
        });
        ringContainer.innerHTML = ringsHtml;
    }
    
    const heatmapContainer = document.getElementById('gallery-heatmap');
    if (heatmapContainer) {
        const metricAbbr = { roi:'ROI', roe:'ROE', 'gross-margin':'GM', pm:'PM', 'fcf-yield':'FCF%', 'fcf-growth':'FCFg', 'eps-growth':'EPSg', buyback:'BB', pe:'P/E', peg:'PEG', cr:'CR', de:'D/E', 'altman-z':'AZ' };
        
        let heatHtml = '';
        baseMetrics.forEach(m => {
            const score = scores[m.id] || 0;
            const bg = typeof scoreToHeatmapBg === 'function' ? scoreToHeatmapBg(score) : `hsl(${score * 1.2}, 70%, 50%)`;
            heatHtml += `
                <div style="width:50px;height:50px;background:${bg};border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;text-shadow:0 1px 2px rgba(0,0,0,0.3);">
                    <span style="font-size:10px;font-weight:700;">${metricAbbr[m.id] || m.id}</span>
                    <span style="font-size:12px;font-weight:800;">${score}</span>
                </div>
            `;
        });
        heatmapContainer.innerHTML = heatHtml;
    }
    
    const extremesContainer = document.getElementById('gallery-extremes');
    if (extremesContainer && Object.keys(scores).length >= 3) {
        const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]);
        const top3 = sorted.slice(0, 3);
        const bottom3 = sorted.slice(-3).reverse();
        
        let extHtml = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">';
        
        extHtml += '<div><div style="font-size:11px;font-weight:700;color:var(--success);margin-bottom:8px;">💪 חזקים</div>';
        top3.forEach(([id, score], i) => {
            const m = baseMetrics.find(x => x.id === id);
            extHtml += `
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <span style="font-size:12px;font-weight:700;color:var(--text-muted);">${i+1}</span>
                    <div style="flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden;">
                        <div style="width:${score}%;height:100%;background:var(--success);"></div>
                    </div>
                    <span style="font-size:11px;font-weight:600;">${m?.name || id}</span>
                </div>
            `;
        });
        extHtml += '</div>';
        
        extHtml += '<div><div style="font-size:11px;font-weight:700;color:var(--danger);margin-bottom:8px;">⚠️ לשיפור</div>';
        bottom3.forEach(([id, score], i) => {
            const m = baseMetrics.find(x => x.id === id);
            extHtml += `
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <span style="font-size:12px;font-weight:700;color:var(--text-muted);">${i+1}</span>
                    <div style="flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden;">
                        <div style="width:${score}%;height:100%;background:var(--danger);"></div>
                    </div>
                    <span style="font-size:11px;font-weight:600;">${m?.name || id}</span>
                </div>
            `;
        });
        extHtml += '</div></div>';
        
        extremesContainer.innerHTML = extHtml;
    }
    
    const radarCanvas = document.getElementById('gallery-radar');
    if (radarCanvas) {
        const ctx = radarCanvas.getContext('2d');
        const cx = 140, cy = 140, r = 100;
        const cats = ['profitability', 'growth', 'valuation', 'stability'];
        const catAvgs = cats.map(cat => {
            const arr = catScores[cat] || [];
            return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length/100 : 0;
        });
        
        ctx.clearRect(0, 0, 280, 280);
        
        [0.25, 0.5, 0.75, 1].forEach(scale => {
            ctx.beginPath();
            ctx.arc(cx, cy, r * scale, 0, Math.PI * 2);
            ctx.strokeStyle = '#E2E8F0';
            ctx.stroke();
        });
        
        cats.forEach((_, i) => {
            const angle = (Math.PI * 2 * i / 4) - Math.PI / 2;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + Math.cos(angle) * r, cy + Math.sin(angle) * r);
            ctx.strokeStyle = '#E2E8F0';
            ctx.stroke();
        });
        
        ctx.beginPath();
        catAvgs.forEach((val, i) => {
            const angle = (Math.PI * 2 * i / 4) - Math.PI / 2;
            const x = cx + Math.cos(angle) * r * val;
            const y = cy + Math.sin(angle) * r * val;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.closePath();
        ctx.fillStyle = 'rgba(99, 102, 241, 0.3)';
        ctx.fill();
        ctx.strokeStyle = '#6366F1';
        ctx.lineWidth = 2;
        ctx.stroke();
    }
    
    const gaugeContainer = document.getElementById('gallery-gauge');
    if (gaugeContainer) {
        const totalScore = calculateTotalScoreValue() || 0;
        gaugeContainer.innerHTML = `
            <div style="position:relative;width:120px;height:60px;margin:0 auto;">
                <svg width="120" height="60" viewBox="0 0 120 60">
                    <path d="M10 55 A50 50 0 0 1 110 55" fill="none" stroke="#E2E8F0" stroke-width="10" stroke-linecap="round"/>
                    <path d="M10 55 A50 50 0 0 1 110 55" fill="none" stroke="url(#gaugeGrad2)" stroke-width="10" stroke-linecap="round"
                        stroke-dasharray="${Math.PI * 50}" stroke-dashoffset="${Math.PI * 50 * (1 - totalScore/100)}"/>
                    <defs>
                        <linearGradient id="gaugeGrad2" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#DC2626"/>
                            <stop offset="50%" stop-color="#F59E0B"/>
                            <stop offset="100%" stop-color="#10B981"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div style="font-size:32px;font-weight:800;color:var(--primary);margin-top:8px;">${totalScore}</div>
            <div style="font-size:12px;color:var(--text-muted);">מתוך 100</div>
        `;
    }
    
    const insightsContainer = document.getElementById('gallery-insights');
    if (insightsContainer && typeof evaluateInsights === 'function') {
        const insights = evaluateInsights();
        const counts = { critical: 0, warning: 0, positive: 0, info: 0 };
        insights.forEach(i => counts[i.severity]++);
        
        insightsContainer.innerHTML = `
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                ${counts.critical ? `<span style="background:#FEE2E2;color:#991B1B;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;">🔴 ${counts.critical} קריטי</span>` : ''}
                ${counts.warning ? `<span style="background:#FEF3C7;color:#92400E;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;">🟠 ${counts.warning} אזהרה</span>` : ''}
                ${counts.positive ? `<span style="background:#D1FAE5;color:#065F46;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;">🟢 ${counts.positive} חיובי</span>` : ''}
                ${counts.info ? `<span style="background:#DBEAFE;color:#1E40AF;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;">🔵 ${counts.info} מידע</span>` : ''}
            </div>
            <div style="margin-top:12px;font-size:12px;color:var(--text-secondary);">
                סה"כ ${insights.length} תובנות זוהו
            </div>
        `;
    }
}

function closeInfographicsModal() {
    document.getElementById('infographics-modal').classList.remove('open');
    document.body.style.overflow = '';
}

// ═══════════════════════════════════════════
// AI PROMPT FOR CSV GENERATION
// ═══════════════════════════════════════════
// ═══════════════════════════════════════════
// IMPROVED CSV EXPORT/IMPORT
// ═══════════════════════════════════════════
function exportToCSV() {
    const rows = [['metric_id', 'metric_name', 'value', 'score', 'category']];
    
    baseMetrics.forEach(m => {
        const inp = document.getElementById(m.inputs[0].id);
        const scoreEl = document.getElementById(`${m.id}-card`)?.querySelector('.metric-score');
        const value = inp?.value || '';
        const score = scoreEl?.textContent || '';
        rows.push([m.id, m.name, value, score, m.category]);
    });
    
    customMetricsData.forEach(m => {
        const inp = document.getElementById(m.inputs[0].id);
        const scoreEl = document.getElementById(`${m.id}-card`)?.querySelector('.metric-score');
        const value = inp?.value || '';
        const score = scoreEl?.textContent || '';
        rows.push([m.id, m.name, value, score, m.category]);
    });
    
    rows.push([]);
    rows.push(['# Metadata']);
    rows.push(['export_date', new Date().toISOString()]);
    rows.push(['total_score', calculateTotalScoreValue() || '']);
    rows.push(['mode', document.getElementById('mode-selector')?.value || 'balanced']);
    
    if (compareModeActive) {
        rows.push(['company_name', companyData[currentCompany].name]);
    }
    
    const csv = rows.map(row => row.map(cell => {
        const str = String(cell);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
    }).join(',')).join('\n');
    
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const companyName = compareModeActive ? companyData[currentCompany].name : 'financial-health';
    a.download = `${companyName}-${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('קובץ CSV נוצר בהצלחה!');
}

function importCSVEnhanced(file) {
    Papa.parse(file, {
        complete: function(results) {
            const data = results.data;
            let imported = 0;
            
            data.forEach(row => {
                if (row.length >= 2 && row[0] && !row[0].startsWith('#')) {
                    const metricId = row[0].trim();
                    const value = row[1] || (row.length > 2 ? row[2] : '');
                    
                    if (value && !isNaN(parseFloat(value))) {
                        const baseMetric = baseMetrics.find(m => m.id === metricId);
                        const customMetric = customMetricsData.find(m => m.id === metricId);
                        const optMetric = typeof optionalMetricsData !== 'undefined' ? optionalMetricsData.find(m => m.id === metricId) : null;
                        
                        if (baseMetric) {
                            const inp = document.getElementById(baseMetric.inputs[0].id);
                            if (inp) { inp.value = parseFloat(value); imported++; }
                        } else if (customMetric) {
                            const inp = document.getElementById(customMetric.inputs[0].id);
                            if (inp) { inp.value = parseFloat(value); imported++; }
                        } else if (optMetric && !customMetricsData.find(m => m.id === metricId)) {
                            if (typeof toggleOptionalMetric === 'function') {
                                toggleOptionalMetric(metricId);
                            }
                            setTimeout(() => {
                                const inp = document.getElementById(`${metricId}-value`);
                                if (inp) inp.value = parseFloat(value);
                            }, 100);
                            imported++;
                        }
                    }
                    
                    if (metricId === 'mode' && value) {
                        const modeSelect = document.getElementById('mode-selector');
                        if (modeSelect && ['growth', 'balanced', 'value'].includes(value)) {
                            modeSelect.value = value;
                        }
                    }
                }
            });
            
            updateAllMetrics();
            showToast(`יובאו ${imported} מדדים בהצלחה!`);
        },
        error: function(err) {
            showToast('שגיאה בקריאת הקובץ: ' + err.message);
        }
    });
}


// ═══════════════════════════════════════════
// OPTIONAL PRE-BUILT METRICS (5 Additional)
// ═══════════════════════════════════════════
const optionalMetricsData = [
    {
        id: 'opt-div-yield',
        name: 'תשואת דיבידנד',
        description: 'אחוז הדיבידנד השנתי מתוך מחיר המניה',
        category: 'profitability',
        threshold: 2.0,
        compare: 'above',
        optimalValue: 6,
        worstValue: 0,
        unit: '%',
        weights: { growth: 0.5, balanced: 1.2, value: 1.8 },
        icon: '💸'
    },
    {
        id: 'opt-rev-growth',
        name: 'צמיחת הכנסות (5Y)',
        description: 'קצב צמיחה שנתי מורכב של ההכנסות',
        category: 'growth',
        threshold: 8,
        compare: 'above',
        optimalValue: 25,
        worstValue: -10,
        unit: '%',
        weights: { growth: 1.8, balanced: 1.3, value: 0.8 },
        icon: '📈'
    },
    {
        id: 'opt-op-margin',
        name: 'מרווח תפעולי',
        description: 'רווח תפעולי כאחוז מההכנסות',
        category: 'profitability',
        threshold: 15,
        compare: 'above',
        optimalValue: 30,
        worstValue: 0,
        unit: '%',
        weights: { growth: 1.1, balanced: 1.4, value: 1.5 },
        icon: '⚙️'
    },
    {
        id: 'opt-int-coverage',
        name: 'יחס כיסוי ריבית',
        description: 'פי כמה הרווח התפעולי מכסה את הוצאות הריבית',
        category: 'stability',
        threshold: 3.0,
        compare: 'above',
        optimalValue: 10,
        worstValue: 1,
        unit: 'x',
        weights: { growth: 0.8, balanced: 1.3, value: 1.6 },
        icon: '🛡️'
    },
    {
        id: 'opt-roa',
        name: 'תשואה על נכסים (ROA)',
        description: 'רווח נקי כאחוז מסך הנכסים',
        category: 'profitability',
        threshold: 5,
        compare: 'above',
        optimalValue: 15,
        worstValue: 0,
        unit: '%',
        weights: { growth: 1.0, balanced: 1.3, value: 1.4 },
        icon: '🏭'
    }
];

// Deep-dive data for optional metrics
const optionalDeepDive = {
    'opt-div-yield': {
        icon: '💸',
        category: 'רווחיות',
        flowQuestion: 'למה לקוחות ממשיכים לקנות מאותה חברה?',
        flow: [
            { title: 'רווחים יציבים', desc: 'החברה מרוויחה באופן עקבי' },
            { title: 'מדיניות חלוקה', desc: 'ההנהלה מחליטה לחלק לבעלי המניות' },
            { title: 'דיבידנד', desc: 'תשלום ישיר לכיס שלך' }
        ],
        whyCards: [
            {
                question: 'למה דיבידנד חשוב?',
                answer: 'דיבידנד הוא <strong>"ציפור ביד"</strong> — תזרים מזומנים ישיר לכיס שלך, לא תלוי בעליית מחיר המניה. זה מספק הכנסה פסיבית וגם סימן לביטחון ההנהלה.'
            },
            {
                question: 'מה מאפשר דיבידנד גבוה?',
                answer: '<strong>רווחים יציבים וצפויים</strong>, תזרים מזומנים חופשי חזק, ותעשייה בוגרת עם צרכי השקעה נמוכים. חברות כמו קוקה-קולה, P&G, ג\'ונסון מחלקות דיבידנד עולה 50+ שנים.'
            },
            {
                question: 'מתי תשואה גבוהה מסוכנת?',
                answer: 'תשואה מעל 8% עשויה להעיד על <strong>מחיר מניה שנפל</strong> בגלל בעיות. בדוק את יחס החלוקה (Payout Ratio) — מעל 80% לא בר-קיימא.'
            }
        ],
        examples: [
            { company: 'קוקה-קולה', ticker: 'KO', value: '3.1%', context: '60+ שנות העלאות רצופות' },
            { company: 'ריאלטי אינקם', ticker: 'O', value: '5.8%', context: 'REIT עם דיבידנד חודשי' },
            { company: 'אמזון', ticker: 'AMZN', value: '0%', context: 'משקיעה הכל בצמיחה' }
        ],
        insight: 'תשואה של 3-5% נחשבת מאוזנת. מתחת ל-2% = חברת צמיחה. מעל 6% = בדוק שהדיבידנד בר-קיימא.',
        scale: {
            ranges: [
                { min: 0, max: 1, label: 'נמוך', emoji: '📉', color: '#F97316' },
                { min: 1, max: 2.5, label: 'צמיחה', emoji: '🌱', color: '#F59E0B' },
                { min: 2.5, max: 4, label: 'מאוזן', emoji: '✅', color: '#10B981' },
                { min: 4, max: 6, label: 'גבוה', emoji: '💰', color: '#6366F1' },
                { min: 6, max: 15, label: 'גבוה מאוד', emoji: '⚠️', color: '#DC2626' }
            ]
        }
    },
    'opt-rev-growth': {
        icon: '📈',
        category: 'צמיחה',
        flowQuestion: 'איך חברה מגדילה הכנסות?',
        flow: [
            { title: 'שוק צומח', desc: 'ביקוש עולה למוצר/שירות' },
            { title: 'נתח שוק עולה', desc: 'החברה מנצחת מתחרים' },
            { title: 'הכנסות גדלות', desc: 'יותר מכירות, יותר פוטנציאל' }
        ],
        whyCards: [
            {
                question: 'למה צמיחת הכנסות היא הבסיס?',
                answer: 'בלי צמיחת הכנסות, כל שיפור ברווחיות מגיע מ<strong>קיצוץ הוצאות</strong> — וזה מוגבל. צמיחה אורגנית היא הדלק לצמיחת רווחים לטווח ארוך.'
            },
            {
                question: 'מה מניע צמיחת הכנסות?',
                answer: '<strong>שוק גדל</strong> (TAM), יתרון תחרותי שמאפשר לגנוב נתח שוק, מוצרים חדשים, התרחבות גיאוגרפית, ו/או יכולת להעלות מחירים.'
            },
            {
                question: 'מתי צמיחה מהירה מסוכנת?',
                answer: 'צמיחה מ<strong>רכישות</strong> לא תמיד איכותית. צמיחה ש<strong>שורפת מזומנים</strong> יכולה להיגמר. בדוק שהצמיחה רווחית או בדרך לרווחיות.'
            }
        ],
        examples: [
            { company: 'אנבידיה', ticker: 'NVDA', value: '+94%', context: 'מהפכת ה-AI מניעה ביקוש אדיר' },
            { company: 'אפל', ticker: 'AAPL', value: '+8%', context: 'צמיחה יציבה בחברת $3T' },
            { company: 'אינטל', ticker: 'INTC', value: '-12%', context: 'מאבדת נתח שוק' }
        ],
        insight: 'צמיחה דו-ספרתית (10%+) מעולה. צמיחה של 5-10% סבירה. צמיחה שלילית = בדוק למה.',
        scale: {
            ranges: [
                { min: -20, max: 0, label: 'שלילי', emoji: '🔴', color: '#DC2626' },
                { min: 0, max: 5, label: 'איטי', emoji: '🟠', color: '#F97316' },
                { min: 5, max: 10, label: 'בינוני', emoji: '🟡', color: '#F59E0B' },
                { min: 10, max: 20, label: 'חזק', emoji: '🟢', color: '#10B981' },
                { min: 20, max: 100, label: 'מטאורי', emoji: '🚀', color: '#6366F1' }
            ]
        }
    },
    'opt-op-margin': {
        icon: '⚙️',
        category: 'רווחיות',
        flowQuestion: 'מה משפיע על המרווח התפעולי?',
        flow: [
            { title: 'מרווח גולמי', desc: 'מה נשאר אחרי עלות המכר' },
            { title: 'הוצאות תפעול', desc: 'מכירות, שיווק, G&A, מו"פ' },
            { title: 'מרווח תפעולי', desc: 'הרווחיות מהפעילות הליבתית' }
        ],
        barriers: {
            question: 'למה אין מתחרים שמציעים את אותו מוצר בזול יותר?',
            types: [
                { title: 'מחסום ידע', subtitle: 'לא יודעים איך להתחרות', detail: 'עסקים שמוכרים משהו מורכב וקשה לשכפל (טכנולוגיה קניינית). מתחרה יצטרך גישה לסודות מסחריים.', examples: 'להתחרות עם <strong>ASML, AMAT, KLA</strong> דורש ידע מוגן בפטנטים ו-know-how של עשרות שנים.' },
                { title: 'מחסום יכולת', subtitle: 'לא מסוגלים להתחרות', detail: 'עסקים שדורשים שרשרת אספקה קשה לגישה, תשתית יקרה, או סקייל עצום.', examples: 'להתחרות עם <strong>TSMC</strong> דורש $20B+ השקעה. להתחרות עם <strong>Visa</strong> דורש רשת של מיליוני סוחרים.' },
                { title: 'מחסום רגולטורי', subtitle: 'לא מורשים להתחרות', detail: 'עסקים מוגנים ע"י קניין רוחני, רישיונות, או רגולציה.', examples: 'להתחרות עם <strong>FICO, Moody\'s</strong> דורש שינוי רגולציה בנקאית ואמון של כל המערכת הפיננסית.' }
            ]
        },
        whyCards: [
            {
                question: 'למה מרווח תפעולי חשוב יותר מגולמי?',
                answer: 'מרווח גולמי לא מספר את כל הסיפור — חברה יכולה להיות עם מרווח גולמי 60% ועדיין להפסיד כסף אם ההוצאות התפעוליות גבוהות מדי.'
            },
            {
                question: 'מה מאפשר מרווח תפעולי גבוה?',
                answer: '<strong>יתרון תחרותי</strong> — מותג חזק, עלויות החלפה, אפקט רשת, או יעילות תפעולית מעולה. גם <strong>סקייל</strong> עוזר — הוצאות קבועות מתפרסות על יותר הכנסות.'
            },
            {
                question: 'כמה שונה בין ענפים?',
                answer: '<strong>תוכנה: 25-40%</strong> — הוצאות שוליות אפסיות. <strong>קמעונאות: 3-8%</strong> — תחרות עזה. <strong>בנקים: 30-40%</strong> — עסק ממונף. השווה רק בתוך אותו ענף!'
            }
        ],
        examples: [
            { company: 'מטא', ticker: 'META', value: '35%', context: 'עסק דיגיטלי סקיילבילי' },
            { company: 'מיקרוסופט', ticker: 'MSFT', value: '44%', context: 'מלך המרווחים' },
            { company: 'וולמארט', ticker: 'WMT', value: '4.2%', context: 'קמעונאות = מרווחים דקים' }
        ],
        insight: 'מרווח תפעולי מעל 20% מעיד על יתרון תחרותי. מתחת ל-10% = עסק תחרותי. בדוק את המגמה לאורך זמן.',
        scale: {
            ranges: [
                { min: -10, max: 5, label: 'חלש', emoji: '🔴', color: '#DC2626' },
                { min: 5, max: 12, label: 'בינוני', emoji: '🟠', color: '#F97316' },
                { min: 12, max: 20, label: 'טוב', emoji: '🟢', color: '#10B981' },
                { min: 20, max: 35, label: 'מצוין', emoji: '🔵', color: '#6366F1' },
                { min: 35, max: 60, label: 'יוצא דופן', emoji: '⭐', color: '#8B5CF6' }
            ]
        }
    },
    'opt-int-coverage': {
        icon: '🛡️',
        category: 'יציבות',
        flowQuestion: 'האם החברה יכולה לשלם את הריבית על החובות?',
        flow: [
            { title: 'רווח תפעולי', desc: 'EBIT — לפני ריבית ומסים' },
            { title: 'הוצאות ריבית', desc: 'התשלום השנתי על החוב' },
            { title: 'יחס כיסוי', desc: 'פי כמה הרווח מכסה את הריבית' }
        ],
        whyCards: [
            {
                question: 'למה זה קריטי?',
                answer: 'אם החברה לא יכולה לשלם ריבית, היא <strong>בדרך לחדלות פירעון</strong>. יחס מתחת ל-1.5 הוא אזור סכנה אדום.'
            },
            {
                question: 'מה יחס בטוח?',
                answer: 'יחס מעל <strong>5x</strong> נחשב בטוח — גם אם הרווחים יורדים 50%, עדיין יש כיסוי. מתחת ל-<strong>3x</strong> = סיכון מוגבר בהאטה כלכלית.'
            },
            {
                question: 'מה קורה כשהריבית עולה?',
                answer: 'חברות עם חוב בריבית משתנה נפגעות. <strong>הכפל את הריבית הנוכחית</strong> ובדוק אם היחס עדיין מעל 2 — זה מבחן עמידות.'
            }
        ],
        examples: [
            { company: 'מיקרוסופט', ticker: 'MSFT', value: '42x', context: 'כמעט ללא סיכון ריבית' },
            { company: 'AT&T', ticker: 'T', value: '3.2x', context: 'ממונפת, רגישה לריבית' },
            { company: 'בואינג', ticker: 'BA', value: '-2x', context: 'רווח תפעולי שלילי = בעיה' }
        ],
        insight: 'יחס מעל 8x = מבצר. 5-8x = בריא. 3-5x = לנטר. מתחת ל-3x = סיכון.',
        scale: {
            ranges: [
                { min: 0, max: 2, label: 'מסוכן', emoji: '🔴', color: '#DC2626' },
                { min: 2, max: 4, label: 'נמוך', emoji: '🟠', color: '#F97316' },
                { min: 4, max: 8, label: 'בריא', emoji: '🟢', color: '#10B981' },
                { min: 8, max: 15, label: 'חזק', emoji: '🔵', color: '#6366F1' },
                { min: 15, max: 50, label: 'מבצר', emoji: '🏰', color: '#8B5CF6' }
            ]
        }
    },
    'opt-roa': {
        icon: '🏭',
        category: 'רווחיות',
        flowQuestion: 'כמה טוב החברה מנצלת את הנכסים שלה?',
        flow: [
            { title: 'סך הנכסים', desc: 'כל מה שהחברה מחזיקה' },
            { title: 'פעילות עסקית', desc: 'הנכסים מייצרים הכנסות ורווח' },
            { title: 'ROA', desc: 'יעילות ניצול כל הנכסים' }
        ],
        whyCards: [
            {
                question: 'מה ההבדל בין ROA ל-ROE?',
                answer: 'ROE מודד תשואה על <strong>ההון העצמי</strong> בלבד. ROA מודד תשואה על <strong>כל הנכסים</strong> — כולל אלה שמומנו בחוב. ROA לא "מנופח" ע"י מינוף.'
            },
            {
                question: 'למה ROA חשוב?',
                answer: 'ROA גבוה מעיד שהחברה <strong>יעילה</strong> בניצול המשאבים שלה. חברה יכולה לצמוח מהר יותר בלי לגייס הון או חוב.'
            },
            {
                question: 'מה משפיע על ROA?',
                answer: 'שני גורמים: <strong>מרווח רווח</strong> (כמה רווח מכל שקל מכירות) ו-<strong>מחזור נכסים</strong> (כמה מכירות מכל שקל נכסים). חברות שונות משתמשות באסטרטגיות שונות.'
            }
        ],
        examples: [
            { company: 'ויזה', ticker: 'V', value: '15%', context: 'עסק קל-נכסים' },
            { company: 'אפל', ticker: 'AAPL', value: '28%', context: 'יעילות יוצאת דופן' },
            { company: 'GM', ticker: 'GM', value: '4%', context: 'תעשייה עתירת הון' }
        ],
        insight: 'ROA מעל 10% = מצוין. 5-10% = טוב. מתחת ל-5% = בדוק אם זה אופייני לענף.',
        scale: {
            ranges: [
                { min: -5, max: 2, label: 'חלש', emoji: '🔴', color: '#DC2626' },
                { min: 2, max: 5, label: 'בינוני', emoji: '🟠', color: '#F97316' },
                { min: 5, max: 10, label: 'טוב', emoji: '🟢', color: '#10B981' },
                { min: 10, max: 20, label: 'מצוין', emoji: '🔵', color: '#6366F1' },
                { min: 20, max: 40, label: 'יוצא דופן', emoji: '⭐', color: '#8B5CF6' }
            ]
        }
    }
};

// Enhanced deep-dive data for base metrics
const enhancedBaseDeepDive = {
    'roi': {
        flowQuestion: 'איך השקעה הופכת לתשואה?',
        flow: [
            { title: 'השקעת הון', desc: 'הון עצמי + חוב לטווח ארוך' },
            { title: 'פעילות עסקית', desc: 'החברה מייצרת הכנסות ורווח' },
            { title: 'תשואה', desc: 'כמה חוזר על כל שקל שהושקע' }
        ],
        whyCards: [
            {
                question: 'למה ROI משנה לערך החברה?',
                answer: 'ROI גבוה מעיד שהחברה <strong>יוצרת ערך</strong> — כל שקל שמושקע בה מחזיר יותר ממה שעולה לגייס הון. זה הבסיס ליצירת ערך לבעלי מניות לטווח ארוך.'
            },
            {
                question: 'מה מניע ROI גבוה?',
                answer: '<strong>יתרון תחרותי בר-קיימא</strong> — מותג חזק, פטנטים, אפקט רשת, עלויות החלפה גבוהות, או יעילות תפעולית מעולה שמאפשרים להרוויח יותר מהמתחרים.'
            },
            {
                question: 'מתי ROI גבוה מטעה?',
                answer: 'ROI גבוה מ<strong>מינוף גבוה</strong> = רווחיות לא אורגנית. גם <strong>חשבונאות אגרסיבית</strong> יכולה לנפח ROI באופן זמני. תמיד בדוק עקביות לאורך שנים.'
            }
        ],
        barriers: {
            question: 'למה מתחרים לא מצליחים להשיג את אותו ROI?',
            types: [
                { title: 'מחסום ידע', subtitle: 'לא יודעים איך להתחרות', detail: 'טכנולוגיה קניינית, סודות מסחריים, ו-know-how שנצבר לאורך שנים.', examples: '<strong>ASML</strong> — היחידה בעולם שיודעת לייצר מכונות EUV ליתוגרפיה.' },
                { title: 'מחסום יכולת', subtitle: 'לא מסוגלים להתחרות', detail: 'דורש השקעה עצומה, זמן רב, או תשתיות שקשה לבנות.', examples: '<strong>TSMC</strong> — $50B השקעה שנתית ו-30 שנות ניסיון בייצור שבבים.' },
                { title: 'מחסום רגולטורי', subtitle: 'לא מורשים להתחרות', detail: 'פטנטים, רישיונות, רגולציה, או סטנדרטים שמגינים על השחקנים הקיימים.', examples: '<strong>Moody\'s, S&P</strong> — רגולציה בנקאית מחייבת שימוש בדירוגים שלהם.' }
            ]
        },
        examples: [
            { company: 'אפל', ticker: 'AAPL', value: '56%', context: 'מותג + אקוסיסטם = ROI עצום' },
            { company: 'קוסטקו', ticker: 'COST', value: '18%', context: 'יעילות תפעולית מעולה' },
            { company: 'דלתא', ticker: 'DAL', value: '8%', context: 'תעשייה תחרותית' }
        ],
        insight: 'ROI גבוה ועקבי (מעל 15%) לאורך 5+ שנים מעיד על יתרון תחרותי בר-קיימא. זהו אחד הסימנים החזקים ביותר לחברה איכותית.'
    },
    'roe': {
        flowQuestion: 'איך ההון העצמי מייצר רווח?',
        flow: [
            { title: 'הון עצמי', desc: 'הכסף של בעלי המניות' },
            { title: 'יצירת רווח', desc: 'החברה מרוויחה מההון הזה' },
            { title: 'תשואה על ההון', desc: 'כמה רווח לכל שקל הון' }
        ],
        whyCards: [
            {
                question: 'למה ROE חשוב לבעלי מניות?',
                answer: 'ROE גבוה = <strong>ההון שלך עובד קשה</strong>. חברה עם ROE 20% מכפילה את ההון העצמי כל 3.6 שנים (כלל 72). זה קצב יצירת הערך.'
            },
            {
                question: 'מה יוצר ROE גבוה?',
                answer: 'שלושה גורמים (DuPont): <strong>מרווח רווח</strong> × <strong>מחזור נכסים</strong> × <strong>מינוף</strong>. רק 2 הראשונים איכותיים!'
            },
            {
                question: 'המלכודת של ROE ממונף',
                answer: 'חברה יכולה "לנפח" ROE ע"י חוב. <strong>ROE גבוה + D/E גבוה = אזהרה</strong>. בדוק תמיד את יחס החוב להון במקביל.'
            }
        ],
        examples: [
            { company: 'נייקי', ticker: 'NKE', value: '38%', context: 'מותג + Asset-light' },
            { company: 'ג\'ונסון', ticker: 'JNJ', value: '22%', context: 'רווחיות יציבה, מינוף נמוך' },
            { company: 'פורד', ticker: 'F', value: '12%', context: 'תעשייה עתירת הון' }
        ],
        insight: 'ROE מעל 15% עם D/E מתחת ל-0.5 הוא שילוב מנצח — רווחיות אורגנית ולא ממונפת.'
    },
    'gross-margin': {
        flowQuestion: 'למה לקוחות משלמים יותר מעלות הייצור?',
        flow: [
            { title: 'עלות ייצור', desc: 'כמה עולה לייצר את המוצר' },
            { title: 'מחיר מכירה', desc: 'כמה הלקוח מוכן לשלם' },
            { title: 'מרווח גולמי', desc: 'הפער — הבסיס לכל רווח' }
        ],
        barriers: {
            question: 'למה לקוחות ממשיכים לקנות מאותה חברה?',
            types: [
                { title: 'המוצר חיוני', subtitle: 'Mission-critical', detail: 'אם המוצר חיוני (לא דיסקרציונרי), אי-קנייה תפגע בלקוח — בהכנסות, עלויות, מוניטין, או יכולת תחרותית.', examples: '<strong>מיקרוסופט Office</strong> — חיוני לכל עסק. <strong>Salesforce</strong> — מערכת ה-CRM שכולם תלויים בה.' },
                { title: 'אין אלטרנטיבות', subtitle: 'מונופול/דואופול', detail: 'אם אין חלופות באיכות ובמחיר דומים, הלקוחות נאלצים להמשיך לקנות.', examples: '<strong>ASML</strong> — היחידה בעולם עם מכונות EUV. <strong>Visa/Mastercard</strong> — דואופול בתשלומים.' },
                { title: 'עלויות מעבר', subtitle: 'Switching costs', detail: 'אם המעבר יקר, מסוכן, או מסובך — הלקוחות נשארים. זה נובע מהטמעה עמוקה בתהליכים.', examples: '<strong>SAP, Oracle</strong> — מערכות ERP שמוטמעות לעומק בארגון. עלות החלפה = מיליונים ושנים.' }
            ]
        },
        whyCards: [
            {
                question: 'למה מרווח גולמי כל כך חשוב?',
                answer: 'מרווח גולמי הוא <strong>"כרית הביטחון"</strong>. מרווח 60% אומר שגם אם ההוצאות התפעוליות גבוהות, יש מרחב לרווח. מרווח 20% לא משאיר מקום לטעויות.'
            },
            {
                question: 'מה מאפשר מרווח גבוה?',
                answer: '<strong>כוח תמחור</strong> — יכולת לגבות יותר. נובע ממותג, בידול, עלויות החלפה גבוהות, או חוסר תחרות. חברות עם "חפיר" נהנות ממרווחים גבוהים.'
            },
            {
                question: 'מה ההבדלים בין ענפים?',
                answer: '<strong>תוכנה: 70-85%</strong>, <strong>תרופות: 60-80%</strong>, <strong>יוקרה: 60-75%</strong>, <strong>תעשייה: 25-40%</strong>, <strong>קמעונאות: 20-35%</strong>, <strong>מכולת: 2-5%</strong>.'
            }
        ],
        examples: [
            { company: 'הרמס', ticker: 'RMS.PA', value: '72%', context: 'מותג יוקרה = מרווח עצום' },
            { company: 'מיקרוסופט', ticker: 'MSFT', value: '69%', context: 'תוכנה = עלות שולית אפסית' },
            { company: 'קרוגר', ticker: 'KR', value: '22%', context: 'סופרמרקט = מרווחים דקים' }
        ],
        insight: 'מרווח גולמי יציב ועולה לאורך שנים הוא אחד הסימנים הטובים ביותר ליתרון תחרותי בר-קיימא.'
    },
    'pe': {
        flowQuestion: 'מה מחיר המניה אומר על הציפיות?',
        flow: [
            { title: 'רווח נוכחי', desc: 'כמה החברה מרוויחה היום' },
            { title: 'ציפיות לעתיד', desc: 'האם הרווח יגדל? יישאר? יירד?' },
            { title: 'מכפיל רווח', desc: 'המחיר שהשוק מוכן לשלם' }
        ],
        whyCards: [
            {
                question: 'מה P/E באמת אומר?',
                answer: 'P/E הוא <strong>מחיר הציפיות</strong>. P/E 30 אומר שאתה משלם 30 שנות רווח נוכחי. זה הגיוני רק אם אתה מצפה שהרווח יגדל משמעותית.'
            },
            {
                question: 'מה מצדיק P/E גבוה?',
                answer: 'שלושה דברים: <strong>צמיחה עתידית גבוהה</strong>, <strong>איכות רווחים</strong> (יציבים וצפויים), ו<strong>סיכון נמוך</strong>. שלושתם מצדיקים פרמיה.'
            },
            {
                question: 'המלכודת של P/E נמוך',
                answer: 'P/E נמוך לא תמיד = מציאה! השוק עשוי לתמחר <strong>בעיות שאתה לא רואה</strong> — ירידה ברווחים, תחרות, סיכונים רגולטוריים, או שינוי טכנולוגי.'
            }
        ],
        examples: [
            { company: 'אמזון', ticker: 'AMZN', value: '60x', context: 'צמיחה + דומיננטיות = פרמיה' },
            { company: 'ג\'יי פי מורגן', ticker: 'JPM', value: '12x', context: 'בנק — צמיחה מוגבלת' },
            { company: 'אינטל', ticker: 'INTC', value: '25x', context: 'P/E גבוה למרות בעיות — ציפיות להתאוששות' }
        ],
        insight: 'אל תסתכל על P/E בבידוד. השווה לענף, לצמיחה (PEG), ול-P/E ההיסטורי של אותה חברה.'
    },
    'de': {
        flowQuestion: 'מי מממן את הפעילות — בעלי מניות או נושים?',
        flow: [
            { title: 'הון עצמי', desc: 'הכסף של בעלי המניות' },
            { title: 'חוב', desc: 'כסף שהחברה לוותה' },
            { title: 'יחס מינוף', desc: 'כמה חוב לכל שקל הון' }
        ],
        whyCards: [
            {
                question: 'למה מינוף חשוב?',
                answer: 'חוב הוא <strong>חרב פיפיות</strong>. בזמנים טובים — מגדיל תשואות לבעלי המניות. בזמנים רעים — יכול להרוס חברה. משבר 2008 הוכיח את זה.'
            },
            {
                question: 'מתי חוב "טוב"?',
                answer: 'חוב בריבית נמוכה, לטווח ארוך, שמממן <strong>נכסים מניבים</strong>. המפתח: התשואה על ההשקעה צריכה להיות גבוהה מעלות החוב.'
            },
            {
                question: 'מתי חוב הופך לבעיה?',
                answer: 'כש<strong>הריבית עולה</strong>, כשההכנסות יורדות, או כשיש <strong>פירעונות גדולים</strong> בקרוב. חברות ממונפות קורסות ראשונות בהאטה כלכלית.'
            }
        ],
        examples: [
            { company: 'אלפבית', ticker: 'GOOGL', value: '0.1x', context: 'כמעט ללא חוב — מבצר' },
            { company: 'AT&T', ticker: 'T', value: '1.4x', context: 'ממונפת משמעותית' },
            { company: 'נכסי סימון', ticker: 'SPG', value: '8.5x', context: 'REIT — מינוף גבוה בעיצוב' }
        ],
        insight: 'D/E מתחת ל-0.5 שמרני, 0.5-1.0 מאוזן, מעל 1.0 ממונף. תמיד בדוק גם את יחס כיסוי הריבית!'
    },
    'altman-z': {
        flowQuestion: 'האם החברה בסכנה של חדלות פירעון?',
        flow: [
            { title: '5 יחסים פיננסיים', desc: 'נזילות, רווחיות, מינוף, יעילות, שווי' },
            { title: 'נוסחה משוקללת', desc: 'כל יחס מקבל משקל ספציפי' },
            { title: 'ציון Z', desc: 'מנבא סיכון חדלות פירעון' }
        ],
        whyCards: [
            {
                question: 'כמה מדויק ה-Z-Score?',
                answer: 'פותח ב-1968 ע"י פרופ\' אלטמן, ה-Z צדק ב-<strong>80-90%</strong> מהמקרים בחיזוי פשיטות רגל עד שנתיים קדימה. עדיין רלוונטי היום.'
            },
            {
                question: 'מה 5 הרכיבים?',
                answer: '<strong>A</strong>=הון חוזר/נכסים, <strong>B</strong>=עודפים/נכסים, <strong>C</strong>=EBIT/נכסים, <strong>D</strong>=שווי שוק/חוב, <strong>E</strong>=מכירות/נכסים. הנוסחה: 1.2A+1.4B+3.3C+0.6D+1.0E'
            },
            {
                question: 'מגבלות המודל',
                answer: 'פותח לחברות <strong>תעשייה</strong> — פחות מדויק לבנקים, ביטוח, נדל"ן, וסטארטאפים. גם לא מתאים לחברות עם הון עצמי שלילי.'
            }
        ],
        examples: [
            { company: 'ברקשיר', ticker: 'BRK.B', value: '5.2', context: 'יציבות מצוינת — אזור בטוח' },
            { company: 'בואינג', ticker: 'BA', value: '1.9', context: 'אזור אפור — נדרש ניטור' },
            { company: 'AMC', ticker: 'AMC', value: '0.4', context: 'אזור סכנה חמור' }
        ],
        insight: 'Z > 2.99 = בטוח. 1.81-2.99 = אזור אפור. Z < 1.81 = סיכון גבוה. עקוב אחרי המגמה, לא רק הציון הנקודתי.'
    },
    
    // ═══ PM - Profit Margin ═══
    'pm': {
        flowQuestion: 'מכל שקל הכנסה — כמה נשאר כרווח?',
        flow: [
            { title: '💰 הכנסות', desc: 'סך המכירות השנתיות' },
            { title: '➖ עלויות', desc: 'עלות המכר + הוצאות תפעול' },
            { title: '➖ מימון ומסים', desc: 'ריבית + מס הכנסה' },
            { title: '✅ רווח נקי', desc: 'מה שנשאר לבעלי המניות' }
        ],
        whyCards: [
            { question: 'למה שולי רווח חשוב?', answer: 'הוא מראה כמה יעילה החברה בהפיכת מכירות לרווח. <strong>שוליים גבוהים = יתרון תחרותי</strong>.' },
            { question: 'מה משפיע על שולי רווח?', answer: '<strong>כוח תמחור</strong>, יעילות תפעולית, עלויות מימון, ושיעור מס. חברות עם מותג חזק נהנות משוליים גבוהים יותר.' },
            { question: 'מתי שוליים נמוכים זה בסדר?', answer: 'בעסקים <strong>עתירי נפח</strong> כמו קמעונאות — הרווח מגיע מסיבוב מהיר של מלאי, לא משוליים גבוהים.' }
        ],
        barriers: {
            question: 'למה חברות מסוימות שומרות על שולי רווח גבוהים?',
            types: [
                { title: 'יתרון קנה מידה', subtitle: 'Scale advantage', detail: 'חברות גדולות מפזרות עלויות קבועות על יותר מכירות, מה שמשפר את השוליים.', examples: '<strong>אמזון AWS</strong> — עלויות תשתית מתפזרות על מיליוני לקוחות.' },
                { title: 'מותג חזק', subtitle: 'Pricing power', detail: 'מותג מאפשר תמחור פרימיום ושוליים גבוהים יותר מהמתחרים.', examples: '<strong>אפל</strong> — מוכרת אייפון ב-$1000+ כששאר השוק מתחרה על $300.' }
            ]
        },
        examples: [
            { company: 'מיקרוסופט', ticker: 'MSFT', value: '36%', context: 'מודל תוכנה עם עלויות שוליות נמוכות' },
            { company: 'וולמארט', ticker: 'WMT', value: '2.5%', context: 'קמעונאות = נפחים גבוהים, שוליים נמוכים' },
            { company: 'קוקה קולה', ticker: 'KO', value: '23%', context: 'מותג חזק = כוח תמחור' }
        ],
        insight: 'השווה לממוצע הענף. שוליים של 15%+ בטכנולוגיה נחשב טוב, בקמעונאות 3% יכול להיות מצוין.'
    },
    
    // ═══ FCF Yield ═══
    'fcf-yield': {
        flowQuestion: 'כמה מזומן חופשי מייצרת החברה ביחס לשווי השוק?',
        flow: [
            { title: '💵 FCF', desc: 'תזרים מזומנים חופשי שנתי' },
            { title: '÷', desc: 'חלקי' },
            { title: '📊 שווי שוק', desc: 'מחיר מניה × מספר מניות' },
            { title: '📈 תשואה', desc: 'אחוז התשואה השנתית' }
        ],
        whyCards: [
            { question: 'למה FCF Yield חשוב?', answer: 'הוא מראה כמה <strong>"תשואת מזומן"</strong> אתה מקבל על ההשקעה — בדומה לתשואת דיבידנד אבל יותר מקיף.' },
            { question: 'מה נחשב תשואה טובה?', answer: 'מעל <strong>5%</strong> נחשב אטרקטיבי, מעל <strong>8%</strong> עשוי להצביע על הזדמנות או על בעיה.' },
            { question: 'איך משתמשים במדד?', answer: 'השווה לתשואת האג"ח הממשלתי. אם FCF Yield גבוה משמעותית — המניה עשויה להיות <strong>זולה</strong>.' }
        ],
        examples: [
            { company: 'אלטריה', ticker: 'MO', value: '9%', context: 'תשואת מזומן גבוהה, צמיחה נמוכה' },
            { company: 'אמזון', ticker: 'AMZN', value: '2%', context: 'משקיעה הרבה בצמיחה עתידית' },
            { company: 'אפל', ticker: 'AAPL', value: '4%', context: 'איזון בין תשואה לצמיחה' }
        ],
        insight: 'FCF Yield גבוה + צמיחה יציבה = שילוב מנצח. FCF Yield גבוה מאוד לבד עשוי להעיד על בעיות צפויות.'
    },
    
    // ═══ FCF Growth ═══
    'fcf-growth': {
        flowQuestion: 'באיזה קצב גדל התזרים החופשי?',
        flow: [
            { title: '📊 FCF שנה קודמת', desc: 'נקודת ההשוואה' },
            { title: '📈 FCF השנה', desc: 'התזרים הנוכחי' },
            { title: '🔢 חישוב צמיחה', desc: '(חדש-ישן)/ישן × 100' },
            { title: '✅ אחוז צמיחה', desc: 'התוצאה הסופית' }
        ],
        whyCards: [
            { question: 'למה צמיחת FCF חשובה?', answer: 'FCF צומח = יותר כסף ל<strong>דיבידנדים, רכישות עצמיות, או השקעות בצמיחה</strong>. זו הנשמה של יצירת ערך.' },
            { question: 'מה משפיע על צמיחת FCF?', answer: 'צמיחת הכנסות, שיפור ברווחיות, <strong>ניהול יעיל של הון חוזר</strong>, והשקעות הון נמוכות יותר.' },
            { question: 'מה צריך לבדוק?', answer: 'האם הצמיחה <strong>עקבית לאורך שנים</strong> או חד פעמית? האם היא מגיעה מצמיחה אורגנית?' }
        ],
        examples: [
            { company: 'ויזה', ticker: 'V', value: '15%', context: 'צמיחה דו-ספרתית עקבית' },
            { company: 'פרוקטר', ticker: 'PG', value: '5%', context: 'צמיחה צנועה אבל יציבה' },
            { company: 'אינטל', ticker: 'INTC', value: '-8%', context: 'ירידה בתזרים עקב תחרות' }
        ],
        insight: 'צמיחת FCF עקבית של 10%+ לאורך 5 שנים היא סימן מובהק לאיכות. חפש עקביות, לא שיאים חד-פעמיים.'
    },
    
    // ═══ EPS Growth ═══
    'eps-growth': {
        flowQuestion: 'באיזה קצב גדל הרווח למניה?',
        flow: [
            { title: '💰 רווח נקי', desc: 'הרווח הכולל של החברה' },
            { title: '÷', desc: 'חלקי' },
            { title: '📊 מספר מניות', desc: 'כמות המניות בשוק' },
            { title: '📈 EPS', desc: 'רווח למניה' }
        ],
        whyCards: [
            { question: 'למה צמיחת EPS חשובה?', answer: 'מחיר המניה נוטה <strong>לעקוב אחרי צמיחת הרווח</strong> לטווח ארוך. EPS צומח = מניה עולה.' },
            { question: 'מה ההבדל בין EPS ל-FCF?', answer: 'EPS מבוסס על <strong>רווח חשבונאי</strong>, FCF על <strong>מזומן אמיתי</strong>. שניהם חשובים אבל FCF קשה יותר "להנדס".' },
            { question: 'מתי צמיחת EPS מטעה?', answer: 'כשהיא מגיעה מ<strong>רכישות עצמיות</strong> (פחות מניות) ולא מצמיחה אמיתית ברווח.' }
        ],
        examples: [
            { company: 'נבידיה', ticker: 'NVDA', value: '40%', context: 'צמיחה מטאורית בתחום ה-AI' },
            { company: 'ג\'ונסון', ticker: 'JNJ', value: '5%', context: 'צמיחה יציבה, חברה בוגרת' },
            { company: 'AT&T', ticker: 'T', value: '-2%', context: 'ירידה בתעשייה מתבגרת' }
        ],
        insight: 'צמיחת EPS צריכה להיות מגובה בצמיחת FCF דומה. פער גדול ביניהם מצריך בדיקה נוספת.'
    },
    
    // ═══ Buyback ═══
    'buyback': {
        flowQuestion: 'כמה מניות החברה רוכשת חזרה?',
        flow: [
            { title: '💵 מזומן עודף', desc: 'כסף שנשאר אחרי השקעות' },
            { title: '🎯 החלטה', desc: 'מה לעשות עם הכסף' },
            { title: '📉 רכישה עצמית', desc: 'קניית מניות מהשוק' },
            { title: '📈 פחות מניות', desc: 'EPS עולה אוטומטית' }
        ],
        whyCards: [
            { question: 'למה רכישות עצמיות טובות?', answer: 'הן מקטינות את מספר המניות, מה שמגדיל את <strong>הרווח למניה (EPS)</strong> ואת הערך לכל בעל מניות.' },
            { question: 'מתי זה פחות טוב?', answer: 'כשהחברה רוכשת <strong>במחירים מנופחים</strong>, או כשהיא ממנת רכישות בחוב במקום ממזומן עודף.' },
            { question: 'מה לבדוק?', answer: 'האם <strong>מספר המניות באמת קטן</strong> לאורך זמן? חברות רבות מנפיקות מניות לעובדים במקביל.' }
        ],
        examples: [
            { company: 'אפל', ticker: 'AAPL', value: '3%', context: 'רכישות עקביות במזומן עודף' },
            { company: 'מטא', ticker: 'META', value: '4%', context: 'רכישות אגרסיביות בשנים האחרונות' },
            { company: 'טסלה', ticker: 'TSLA', value: '0%', context: 'מעדיפה להשקיע בצמיחה' }
        ],
        insight: 'רכישות של 2-4% בשנה עם תזרים חזק = יעיל. רכישות אגרסיביות במינוף = מסוכן.'
    },
    
    // ═══ PEG ═══
    'peg': {
        flowQuestion: 'האם המכפיל מוצדק ביחס לצמיחה?',
        flow: [
            { title: '📊 P/E', desc: 'מכפיל הרווח הנוכחי' },
            { title: '÷', desc: 'חלקי' },
            { title: '📈 צמיחת EPS', desc: 'קצב הצמיחה הצפוי' },
            { title: '🎯 PEG', desc: 'מכפיל מתואם לצמיחה' }
        ],
        whyCards: [
            { question: 'למה PEG עדיף על P/E?', answer: 'P/E לא מתחשב בצמיחה. חברה עם <strong>P/E 30 וצמיחה 30%</strong> עדיפה על P/E 15 עם צמיחה 5%.' },
            { question: 'מה נחשב PEG טוב?', answer: '<strong>PEG < 1</strong> נחשב זול, <strong>PEG 1-2</strong> הוגן, <strong>PEG > 2</strong> יקר. אבל זה תלוי גם באיכות הצמיחה.' },
            { question: 'מה החסרונות של PEG?', answer: 'הוא מסתמך על <strong>תחזית צמיחה שעלולה להיות שגויה</strong>. תמיד בדוק את הנחות הצמיחה.' }
        ],
        examples: [
            { company: 'גוגל', ticker: 'GOOGL', value: '0.9', context: 'צמיחה גבוהה במחיר סביר' },
            { company: 'נטפליקס', ticker: 'NFLX', value: '1.5', context: 'מוערכת בהוגנות' },
            { company: 'קוקה קולה', ticker: 'KO', value: '4.0', context: 'יקרה ביחס לצמיחה האיטית' }
        ],
        insight: 'PEG < 1 עם צמיחה איכותית ועקבית = הזדמנות. אל תסתמך על PEG לבד — בדוק את מקור הצמיחה.'
    },
    
    // ═══ Current Ratio ═══
    'cr': {
        flowQuestion: 'האם החברה יכולה לשלם את החובות הקרובים?',
        flow: [
            { title: '💰 נכסים שוטפים', desc: 'מזומן + לקוחות + מלאי' },
            { title: '÷', desc: 'חלקי' },
            { title: '📋 התחייבויות שוטפות', desc: 'ספקים + הלוואות לפירעון' },
            { title: '📊 יחס נזילות', desc: 'יכולת פירעון לשנה הקרובה' }
        ],
        whyCards: [
            { question: 'למה יחס שוטף חשוב?', answer: 'הוא מודד את יכולת החברה <strong>לעמוד בהתחייבויות לטווח קצר</strong>. יחס נמוך מדי = סיכון נזילות.' },
            { question: 'מה נחשב יחס בריא?', answer: 'בדרך כלל <strong>1.5-2.0</strong>. מתחת ל-1 עלול להעיד על בעיה, מעל 3 עשוי להעיד על ניהול לא יעיל.' },
            { question: 'מה לא רואים ביחס?', answer: '<strong>איכות הנכסים</strong> — מלאי שקשה למכור או לקוחות שלא ישלמו לא יעזרו במשבר.' }
        ],
        barriers: {
            question: 'למה חברות מסוימות יכולות לעבוד עם יחס נמוך?',
            types: [
                { title: 'כוח מול ספקים', subtitle: 'Supplier power', detail: 'חברות עם כוח קנייה גדול יכולות לדחות תשלומים לספקים ולעבוד עם יחס נמוך יותר.', examples: '<strong>וולמארט</strong> — מקבלת תנאי תשלום של 60+ יום מספקים.' },
                { title: 'מזומן שלילי', subtitle: 'Negative cash cycle', detail: 'חברות שגובות מלקוחות לפני שמשלמות לספקים יכולות לעבוד עם יחס נמוך.', examples: '<strong>אמזון</strong> — מוכרת ללקוחות מיד, משלמת לספקים אחרי 30-60 יום.' }
            ]
        },
        examples: [
            { company: 'ג\'ונסון', ticker: 'JNJ', value: '1.8', context: 'יחס בריא, כרית ביטחון טובה' },
            { company: 'אמזון', ticker: 'AMZN', value: '0.9', context: 'נמוך אבל בטוח — מחזור מזומנים שלילי' },
            { company: 'בואינג', ticker: 'BA', value: '1.1', context: 'יחס נמוך, דורש מעקב' }
        ],
        insight: 'יחס שוטף יציב לאורך זמן חשוב יותר מהמספר עצמו. ירידה חדה ביחס היא דגל אדום.'
    }
};

// ═══════════════════════════════════════════
// RENDER OPTIONAL METRICS PICKER
// ═══════════════════════════════════════════
function renderOptionalMetricsPicker() {
    const grid = document.getElementById('oms-grid');
    if (!grid) return;
    
    const catNames = { profitability: 'רווחיות', growth: 'צמיחה', valuation: 'הערכת שווי', stability: 'יציבות' };
    
    grid.innerHTML = optionalMetricsData.map(m => {
        const isAdded = customMetricsData.some(cm => cm.id === m.id);
        return `
            <div class="oms-item${isAdded ? ' added' : ''}" data-id="${m.id}">
                <div class="oi-icon" data-icon="${m.icon}"></div>
                <div class="oi-info">
                    <div class="oi-name">${m.name}</div>
                    <div class="oi-desc">${m.description}</div>
                </div>
                <span class="oi-badge cat-${m.category}">${catNames[m.category]}</span>
            </div>
        `;
    }).join('');
    
    // Add click handlers
    grid.querySelectorAll('.oms-item').forEach(item => {
        item.onclick = () => toggleOptionalMetric(item.dataset.id);
    });
}

function toggleOptionalMetric(id) {
    const optMetric = optionalMetricsData.find(m => m.id === id);
    if (!optMetric) return;
    
    const existingIndex = customMetricsData.findIndex(cm => cm.id === id);
    
    if (existingIndex >= 0) {
        // Remove
        const card = document.getElementById(`${id}-card`);
        if (card) card.remove();
        customMetricsData.splice(existingIndex, 1);
        saveCustomStorage();
        showToast(`"${optMetric.name}" הוסר`);
    } else {
        // Add
        const newMetric = {
            id: optMetric.id,
            name: optMetric.name,
            description: optMetric.description,
            threshold: optMetric.threshold,
            compare: optMetric.compare,
            optimalValue: optMetric.optimalValue,
            worstValue: optMetric.worstValue,
            weights: { ...optMetric.weights },
            unit: optMetric.unit,
            inputs: [{ id: `${optMetric.id}-value`, step: 0.1, unit: optMetric.unit }],
            isOptionalPreset: true
        };
        customMetricsData.push(newMetric);
        saveCustomStorage();
        addCustomMetricCard(newMetric);
        showToast(`"${optMetric.name}" נוסף בהצלחה`);
    }
    
    renderOptionalMetricsPicker();
    updateAllMetrics();
}

// ═══════════════════════════════════════════
// ENHANCED DEEP-DIVE GENERATOR
// ═══════════════════════════════════════════
function generateEnhancedDeepDiveContent(metricId, originalData, currentValue, metric) {
    // Check if we have enhanced data
    const enhanced = enhancedBaseDeepDive[metricId] || optionalDeepDive[metricId] || null;
    
    if (!enhanced && !originalData) {
        return '<div style="padding:20px;text-align:center;color:var(--text-muted);">אין מידע מפורט זמין עבור מדד זה</div>';
    }
    
    const data = { ...originalData, ...enhanced };
    let html = '';
    
    // TABS
    html += `
        <div class="dd-tabs">
            <button class="dd-tab active" data-tab="overview">סקירה</button>
            <button class="dd-tab" data-tab="why">למה זה חשוב</button>
            ${data.barriers ? '<button class="dd-tab" data-tab="barriers">מחסומי כניסה</button>' : ''}
            <button class="dd-tab" data-tab="examples">דוגמאות</button>
            <button class="dd-tab" data-tab="calculate">חישוב</button>
        </div>
    `;
    
    // ═══ TAB: OVERVIEW ═══
    html += `<div class="dd-tab-content active" id="dd-tab-overview">`;
    
    // Flow diagram
    if (data.flow) {
        html += `
            <div class="dd-flow-container">
                ${data.flowQuestion ? `<div class="dd-flow-question">${data.flowQuestion}</div>` : ''}
                <div class="dd-flow-row">
                    ${data.flow.map((f, i) => `
                        ${i > 0 ? '<div class="dd-flow-arrow">→</div>' : ''}
                        <div class="dd-flow-box">
                            <div class="fb-title">${f.title}</div>
                            <div class="fb-desc">${f.desc}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Scale visualization
    if (data.scale) {
        const hasValue = !isNaN(currentValue);
        const ranges = data.scale.ranges;
        let markerPos = 50, verdict = '', verdictColor = '#64748B';
        
        if (hasValue) {
            for (const r of ranges) {
                if (currentValue >= r.min && currentValue < r.max) {
                    verdict = r.label;
                    verdictColor = r.color;
                    const totalRange = ranges[ranges.length-1].max - ranges[0].min;
                    const clamped = Math.max(ranges[0].min, Math.min(currentValue, ranges[ranges.length-1].max));
                    markerPos = ((clamped - ranges[0].min) / totalRange) * 100;
                    break;
                }
            }
        }
        
        html += `
            <div class="dd-scale-enhanced">
                <div class="dd-scale-title">איפה אתה על הסקאלה</div>
                <div class="dd-scale-bar-wrap">
                    <div class="dd-scale-bar"></div>
                    ${hasValue ? `<div class="dd-scale-marker" style="right:${markerPos}%"></div>` : ''}
                </div>
                <div class="dd-scale-labels">
                    ${ranges.slice(0,5).map(r => `
                        <div class="dd-scale-label">
                            <span class="sl-emoji">${r.emoji}</span>
                            <span class="sl-text">${r.label}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="dd-your-value-box">
                    ${hasValue ? `
                        <div class="yv-label">הערך שהזנת</div>
                        <div class="yv-num">${currentValue.toFixed(1)}${metric?.unit || ''}</div>
                        <div class="yv-verdict" style="background:${verdictColor}20;color:${verdictColor}">${verdict}</div>
                    ` : '<div class="yv-label">הזן ערך כדי לראות את המיקום שלך</div>'}
                </div>
            </div>
        `;
    }
    
    // Insight box
    if (data.insight) {
        html += `
            <div class="dd-insight-box">
                <div class="ib-icon">💡</div>
                <div class="ib-content">
                    <div class="ib-title">המסקנה העיקרית</div>
                    <div class="ib-text">${data.insight}</div>
                </div>
            </div>
        `;
    }
    
    html += `</div>`; // End overview tab
    
    // ═══ TAB: WHY ═══
    html += `<div class="dd-tab-content" id="dd-tab-why">`;
    
    if (data.whyCards) {
        html += `
            <div class="dd-why-section">
                <div class="dd-why-grid">
                    ${data.whyCards.map(c => `
                        <div class="dd-why-card">
                            <div class="wc-question">${c.question}</div>
                            <div class="wc-answer">${c.answer}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Analogy
    if (data.analogy) {
        html += `
            <div class="dd-analogy" style="margin-top:16px;">
                <div class="dd-analogy-title">💡 הסבר פשוט</div>
                <div class="dd-analogy-text">${data.analogy}</div>
            </div>
        `;
    }
    
    // Pitfalls
    if (data.pitfalls) {
        html += `
            <div class="dd-pitfalls" style="margin-top:16px;">
                <div class="dd-pitfalls-title">⚠️ טעויות נפוצות</div>
                ${data.pitfalls.map((p, i) => `
                    <div class="dd-pitfall-item">
                        <span class="pi-icon">${i + 1}</span>
                        <span class="pi-text">${p}</span>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    html += `</div>`; // End why tab
    
    // ═══ TAB: BARRIERS (if exists) ═══
    if (data.barriers) {
        html += `<div class="dd-tab-content" id="dd-tab-barriers">`;
        html += `
            <div class="dd-barriers-section">
                <div class="dd-barriers-question">${data.barriers.question}</div>
                <div class="dd-barriers-grid">
                    ${data.barriers.types.map(b => `
                        <div class="dd-barrier-box">
                            <div class="bb-title">${b.title}</div>
                            <div class="bb-subtitle">${b.subtitle}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="dd-barrier-details">
                    ${data.barriers.types.map(b => `
                        <div class="dd-barrier-detail">
                            <div class="bd-question">למי יש את זה?</div>
                            <div class="bd-answer">${b.detail}</div>
                            <div class="bd-examples-title">דוגמאות</div>
                            <div class="bd-examples">${b.examples}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        html += `</div>`;
    }
    
    // ═══ TAB: EXAMPLES ═══
    html += `<div class="dd-tab-content" id="dd-tab-examples">`;
    
    if (data.examples) {
        html += `
            <div class="dd-examples-section">
                <div class="dd-examples-title">📊 דוגמאות מהשוק האמיתי</div>
                <div class="dd-examples-grid">
                    ${data.examples.map(e => `
                        <div class="dd-example-card">
                            <div class="ec-company">${e.company}</div>
                            <span class="ec-ticker">${e.ticker}</span>
                            <div class="ec-value">${e.value}</div>
                            <div class="ec-context">${e.context}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Related metrics
    if (data.related) {
        html += `
            <div class="dd-section" style="margin-top:16px;">
                <div class="dd-section-title">מדדים קשורים</div>
                <div class="dd-related">
                    ${data.related.map(r => `
                        <div class="dd-related-item" onclick="openDeepDive('${r.id}')">
                            <div class="ri-name">${r.name}</div>
                            <div class="ri-relation">${r.relation}</div>
                            <span class="ri-arrow">לחץ לפרטים ←</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    html += `</div>`; // End examples tab
    
    // ═══ TAB: CALCULATE ═══
    html += `<div class="dd-tab-content" id="dd-tab-calculate">`;
    
    if (data.formula) {
        html += `
            <div class="dd-section">
                <div class="dd-section-title">נוסחת החישוב</div>
                <div class="dd-formula-box">
                    <div class="dd-formula-main">${data.formula.main}</div>
                    <div class="dd-formula-parts">
                        ${data.formula.parts.map(p => `
                            <div class="dd-formula-part">
                                <span class="fp-symbol">${p.symbol}</span>
                                <span class="fp-meaning">${p.meaning}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Interpretation thresholds
    if (data.interpretation?.thresholds) {
        html += `
            <div class="dd-section" style="margin-top:16px;">
                <div class="dd-section-title">פרשנות לפי ערכים</div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    ${data.interpretation.thresholds.slice(0,5).map(t => `
                        <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:var(--bg);border-radius:var(--radius-sm);">
                            <span style="font-size:12px;font-weight:700;min-width:60px;color:${t.verdict==='excellent'||t.verdict==='good'?'var(--success)':t.verdict==='average'?'var(--warning)':'var(--danger)'}">≤ ${t.max >= 100 ? '∞' : t.max}</span>
                            <span style="font-size:12px;color:var(--text-secondary)">${t.text}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Questions
    if (data.interpretation?.questions) {
        html += `
            <div class="dd-section" style="margin-top:16px;">
                <div class="dd-section-title">שאלות לבדיקה נוספת</div>
                <div style="display:flex;flex-direction:column;gap:6px;">
                    ${data.interpretation.questions.map(q => `
                        <div style="display:flex;align-items:flex-start;gap:8px;padding:8px 12px;background:var(--primary-bg);border-radius:var(--radius-sm);">
                            <span style="color:var(--primary);font-weight:700;">?</span>
                            <span style="font-size:13px;color:var(--text-secondary)">${q}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    html += `</div>`; // End calculate tab
    
    return html;
}

// ═══════════════════════════════════════════
// OVERRIDE openDeepDive
// ═══════════════════════════════════════════
const _originalOpenDeepDive = typeof openDeepDive === 'function' ? openDeepDive : null;

openDeepDive = function(metricId) {
    const originalData = metricDeepDive?.[metricId] || null;
    const optData = optionalDeepDive?.[metricId] || null;
    const metric = baseMetrics?.find(m => m.id === metricId) || customMetricsData?.find(m => m.id === metricId) || optionalMetricsData?.find(m => m.id === metricId);
    
    if (!originalData && !optData && !metric) {
        console.log('No data for metric:', metricId);
        return;
    }
    
    const modal = document.getElementById('deepdive-modal');
    const content = document.getElementById('dd-content');
    
    // Set header
    const icon = originalData?.icon || optData?.icon || '📊';
    const category = originalData?.category || optData?.category || '';
    document.getElementById('dd-icon').textContent = icon;
    document.getElementById('dd-title').textContent = metric?.name || metricId;
    document.getElementById('dd-category').textContent = category;
    
    // Get current value
    const inputId = metric?.inputs?.[0]?.id;
    const inp = inputId ? document.getElementById(inputId) : null;
    const currentValue = inp ? parseFloat(inp.value) : NaN;
    
    // Generate content
    content.innerHTML = generateEnhancedDeepDiveContent(metricId, originalData, currentValue, metric);
    
    // Bind tab clicks
    content.querySelectorAll('.dd-tab').forEach(tab => {
        tab.onclick = () => {
            content.querySelectorAll('.dd-tab').forEach(t => t.classList.remove('active'));
            content.querySelectorAll('.dd-tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`dd-tab-${tab.dataset.tab}`)?.classList.add('active');
        };
    });
    
    // Show modal
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
};


const metricDeepDive = {
    'roi': {
        icon: '💰',
        category: 'רווחיות',
        formula: {
            main: '<span class="fm-num">רווח נקי</span> <span class="fm-op">÷</span> <span class="fm-den">סך השקעות</span> <span class="fm-op">×</span> 100%',
            parts: [
                { symbol: 'רווח נקי', meaning: 'הרווח לאחר כל ההוצאות והמסים' },
                { symbol: 'סך השקעות', meaning: 'הון עצמי + חוב לטווח ארוך' }
            ]
        },
        scale: {
            ranges: [
                { min: -100, max: 0, label: 'שלילי', emoji: '🔴', color: '#DC2626' },
                { min: 0, max: 5, label: 'חלש', emoji: '🟠', color: '#F97316' },
                { min: 5, max: 10, label: 'בינוני', emoji: '🟡', color: '#F59E0B' },
                { min: 10, max: 20, label: 'טוב', emoji: '🟢', color: '#10B981' },
                { min: 20, max: 100, label: 'מצוין', emoji: '🔵', color: '#6366F1' }
            ]
        },
        analogy: 'דמיין שהשקעת 100,000 ₪ בעסק. ROI של 15% אומר שהרווחת 15,000 ₪ בשנה על ההשקעה הזו. זה כמו לשאול: "על כל שקל שהשקעתי, כמה אגורות רווח קיבלתי?"',
        pitfalls: [
            'ROI גבוה בחברה ממונפת עלול להסתיר סיכון — החוב מגדיל את התשואה אבל גם את הסיכון',
            'השוואת ROI בין ענפים שונים אינה משמעותית — לכל ענף יש נורמות שונות',
            'ROI נקודתי לא מספר את כל הסיפור — חפש עקביות לאורך שנים'
        ],
        related: [
            { id: 'roe', name: 'תשואה על ההון (ROE)', relation: 'ROE מתמקד רק בהון העצמי, בעוד ROI כולל גם חוב. פער גדול ביניהם מעיד על מינוף.' },
            { id: 'pm', name: 'שולי רווח נקי', relation: 'PM גבוה תורם ל-ROI גבוה — אם הרווחיות על המכירות טובה, התשואה על ההשקעה תהיה טובה.' }
        ],
        interpretation: {
            thresholds: [
                { max: 0, verdict: 'poor', text: 'תשואה שלילית — החברה מפסידה על ההשקעות שלה. מצב שדורש בדיקה מעמיקה.' },
                { max: 5, verdict: 'poor', text: 'תשואה נמוכה מאוד — פחות מפיקדון בנקאי. יש לבחון אם מדובר בהשקעה בצמיחה עתידית.' },
                { max: 10, verdict: 'average', text: 'תשואה סבירה אך לא מרשימה. החברה מייצרת ערך, אך יש מקום לשיפור.' },
                { max: 15, verdict: 'good', text: 'תשואה טובה — החברה מצליחה להפיק ערך משמעותי מההשקעות שלה.' },
                { max: 25, verdict: 'excellent', text: 'תשואה מצוינת! החברה מפגינה יעילות גבוהה בניצול ההון המושקע בה.' },
                { max: 999, verdict: 'excellent', text: 'תשואה יוצאת דופן — בדוק שאין גורמים חד-פעמיים או הנהלה חשבונאית אגרסיבית.' }
            ],
            questions: [
                'האם ה-ROI עקבי לאורך 3-5 שנים?',
                'מהו ה-ROI של המתחרים באותו ענף?',
                'האם יש פרויקטים חדשים שיפגעו ב-ROI בטווח הקצר?'
            ]
        }
    },
    'roe': {
        icon: '📈',
        category: 'רווחיות',
        formula: {
            main: '<span class="fm-num">רווח נקי</span> <span class="fm-op">÷</span> <span class="fm-den">הון עצמי</span> <span class="fm-op">×</span> 100%',
            parts: [
                { symbol: 'רווח נקי', meaning: 'הרווח השנתי לאחר מסים' },
                { symbol: 'הון עצמי', meaning: 'נכסים פחות התחייבויות' }
            ]
        },
        scale: {
            ranges: [
                { min: -100, max: 0, label: 'שלילי', emoji: '🔴', color: '#DC2626' },
                { min: 0, max: 8, label: 'חלש', emoji: '🟠', color: '#F97316' },
                { min: 8, max: 15, label: 'בינוני', emoji: '🟡', color: '#F59E0B' },
                { min: 15, max: 25, label: 'טוב', emoji: '🟢', color: '#10B981' },
                { min: 25, max: 100, label: 'מצוין', emoji: '🔵', color: '#6366F1' }
            ]
        },
        analogy: 'אם יש לך 100 ₪ בהון עצמי ו-ROE של 18%, זה כמו לקבל 18 ₪ רווח בשנה. זה קצב ה"הכפלה" של הכסף שלך — ב-ROE של 18%, ההון יכפיל את עצמו בערך כל 4 שנים (כלל 72).',
        pitfalls: [
            'ROE גבוה + חוב גבוה = סיכון! המינוף מנפח את ה-ROE אבל מגביר את הסיכון בהאטה',
            'ROE גבוה מאוד (מעל 40%) עשוי להצביע על הון עצמי נמוך מדי — לא תמיד חיובי',
            'השוואת ROE בין ענפים שונים מטעה — בנקים עובדים עם ROE אחר מחברות טכנולוגיה'
        ],
        related: [
            { id: 'de', name: 'יחס חוב להון (D/E)', relation: 'D/E גבוה "מנפח" את ה-ROE. בדוק את שניהם יחד כדי להבין אם הרווחיות אורגנית או ממונפת.' },
            { id: 'roi', name: 'תשואה על ההשקעה (ROI)', relation: 'אם ROE >> ROI, החברה משתמשת במינוף משמעותי.' }
        ],
        interpretation: {
            thresholds: [
                { max: 0, verdict: 'poor', text: 'תשואה שלילית על ההון — החברה שורפת את ההון העצמי של בעלי המניות.' },
                { max: 8, verdict: 'poor', text: 'תשואה נמוכה — פחות מתשואת שוק ההון הממוצעת. ההון לא מנוצל ביעילות.' },
                { max: 15, verdict: 'average', text: 'תשואה סבירה. עומד בסף המינימלי לחברה ציבורית בריאה.' },
                { max: 22, verdict: 'good', text: 'תשואה טובה — החברה מייצרת ערך משמעותי לבעלי המניות.' },
                { max: 35, verdict: 'excellent', text: 'תשואה מצוינת! בדוק שאינה נובעת ממינוף מסוכן.' },
                { max: 999, verdict: 'excellent', text: 'תשואה חריגה — ייתכן שההון העצמי נמוך מאוד או שיש אירוע חד-פעמי.' }
            ],
            questions: [
                'מה יחס החוב להון? (ROE ממונף פחות איכותי)',
                'האם ה-ROE יציב או תנודתי לאורך השנים?',
                'מהי מדיניות חלוקת הדיבידנדים?'
            ]
        }
    },
    'gross-margin': {
        icon: '📊',
        category: 'רווחיות',
        formula: {
            main: '(<span class="fm-num">הכנסות</span> <span class="fm-op">−</span> <span class="fm-den">עלות המכר</span>) <span class="fm-op">÷</span> <span class="fm-num">הכנסות</span> <span class="fm-op">×</span> 100%',
            parts: [
                { symbol: 'הכנסות', meaning: 'סך המכירות לפני הוצאות' },
                { symbol: 'עלות המכר', meaning: 'עלות ישירה של המוצרים/שירותים' }
            ]
        },
        scale: {
            ranges: [
                { min: -100, max: 10, label: 'חלש', emoji: '🔴', color: '#DC2626' },
                { min: 10, max: 20, label: 'נמוך', emoji: '🟠', color: '#F97316' },
                { min: 20, max: 35, label: 'בינוני', emoji: '🟡', color: '#F59E0B' },
                { min: 35, max: 50, label: 'טוב', emoji: '🟢', color: '#10B981' },
                { min: 50, max: 100, label: 'מצוין', emoji: '🔵', color: '#6366F1' }
            ]
        },
        analogy: 'אם אתה מוכר כוס קפה ב-15 ₪ והקפה+החלב+הכוס עולים 5 ₪, המרווח הגולמי הוא 67%. זה מה שנשאר לך לפני שכירות, משכורות ושאר ההוצאות. מרווח גבוה = יותר "כרית" למקרה של בעיות.',
        pitfalls: [
            'מרווח גולמי גבוה לא מבטיח רווחיות — הוצאות תפעוליות יכולות "לאכול" את הכל',
            'מרווח יורד עם הזמן? סימן אזהרה — ייתכן לחץ תחרותי או עליית עלויות',
            'ענפים שונים = מרווחים שונים: תוכנה ~80%, קמעונאות ~25%, מכולת ~3%'
        ],
        related: [
            { id: 'pm', name: 'שולי רווח נקי', relation: 'הפער בין מרווח גולמי לרווח נקי מראה כמה "נאכל" בהוצאות תפעוליות.' },
            { id: 'fcf-yield', name: 'תשואת FCF', relation: 'מרווח גולמי גבוה לרוב מוביל ל-FCF חזק — פחות צורך בהשקעות הוניות.' }
        ],
        interpretation: {
            thresholds: [
                { max: 10, verdict: 'poor', text: 'מרווח גולמי נמוך מאוד — קשה מאוד להרוויח עם בסיס כזה. אופייני לסחורות.' },
                { max: 20, verdict: 'poor', text: 'מרווח נמוך — החברה צריכה נפח מכירות גבוה מאוד כדי להרוויח.' },
                { max: 29, verdict: 'average', text: 'מרווח סביר. יש מקום לרווח אם ההוצאות התפעוליות מנוהלות היטב.' },
                { max: 45, verdict: 'good', text: 'מרווח טוב — מעיד על יתרון תחרותי או מותג חזק.' },
                { max: 65, verdict: 'excellent', text: 'מרווח מצוין! אופייני לחברות תוכנה, תרופות, או מותגי יוקרה.' },
                { max: 100, verdict: 'excellent', text: 'מרווח יוצא דופן — בדוק שאין הכרה בהכנסות חריגה.' }
            ],
            questions: [
                'מה הטרנד של המרווח ב-3 שנים האחרונות?',
                'האם יש תלות בספק יחיד שעלול להעלות מחירים?',
                'מה המרווח של המתחרים העיקריים?'
            ]
        }
    },
    'pm': {
        icon: '💵',
        category: 'רווחיות',
        formula: {
            main: '<span class="fm-num">רווח נקי</span> <span class="fm-op">÷</span> <span class="fm-den">הכנסות</span> <span class="fm-op">×</span> 100%',
            parts: [
                { symbol: 'רווח נקי', meaning: 'מה שנשאר אחרי הכל' },
                { symbol: 'הכנסות', meaning: 'סך המכירות השנתיות' }
            ]
        },
        scale: {
            ranges: [
                { min: -100, max: 0, label: 'הפסד', emoji: '🔴', color: '#DC2626' },
                { min: 0, max: 5, label: 'חלש', emoji: '🟠', color: '#F97316' },
                { min: 5, max: 10, label: 'בינוני', emoji: '🟡', color: '#F59E0B' },
                { min: 10, max: 20, label: 'טוב', emoji: '🟢', color: '#10B981' },
                { min: 20, max: 100, label: 'מצוין', emoji: '🔵', color: '#6366F1' }
            ]
        },
        analogy: 'מכל 100 ₪ שנכנסים לקופה, כמה נשארים בסוף כרווח? שולי רווח של 12% אומר שמכל 100 ₪ מכירות, 12 ₪ הופכים לרווח נקי — השאר הולך להוצאות.',
        pitfalls: [
            'שולי רווח נמוכים + צמיחה מהירה עלולים להיות בסדר — השקעה בצמיחה',
            'שולי רווח גבוהים במיוחד עלולים למשוך תחרות — קשה לשמור לאורך זמן',
            'השוואה בין ענפים חסרת משמעות — סופרמרקט 2%, תוכנה 25%'
        ],
        related: [
            { id: 'gross-margin', name: 'מרווח גולמי', relation: 'הפער ביניהם = ההוצאות התפעוליות. פער גדול = הרבה "בזבוז" בדרך.' },
            { id: 'fcf-yield', name: 'תשואת FCF', relation: 'אם PM גבוה אבל FCF נמוך — הרווחים לא הופכים למזומנים (בעייתי).' }
        ],
        interpretation: {
            thresholds: [
                { max: 0, verdict: 'poor', text: 'החברה מפסידה על כל שקל הכנסה. נדרשת בחינה מעמיקה של המודל העסקי.' },
                { max: 3, verdict: 'poor', text: 'שולי רווח דקים מאוד — רגישות גבוהה לכל שינוי בעלויות או במחירים.' },
                { max: 8, verdict: 'average', text: 'שולי רווח סבירים לענפים תחרותיים. יש לוודא שהמצב יציב.' },
                { max: 15, verdict: 'good', text: 'שולי רווח טובים — החברה מצליחה לשמור על רווחיות בריאה.' },
                { max: 25, verdict: 'excellent', text: 'שולי רווח מצוינים! מעיד על יתרון תחרותי או ניהול יעיל.' },
                { max: 999, verdict: 'excellent', text: 'שולי רווח יוצאי דופן — בדוק שאין אירועים חד-פעמיים.' }
            ],
            questions: [
                'האם השולי יציב או נשחק עם הזמן?',
                'מה קורה לשולי אם ההכנסות יורדות 10%?',
                'האם יש הוצאות מו"פ משמעותיות שמפחיתות את השולי?'
            ]
        }
    },
    'fcf-yield': {
        icon: '💧',
        category: 'רווחיות',
        formula: {
            main: '<span class="fm-num">FCF למניה</span> <span class="fm-op">÷</span> <span class="fm-den">מחיר המניה</span> <span class="fm-op">×</span> 100%',
            parts: [
                { symbol: 'FCF', meaning: 'תזרים מזומנים חופשי (אחרי CAPEX)' },
                { symbol: 'מחיר המניה', meaning: 'שווי השוק למניה' }
            ]
        },
        scale: {
            ranges: [
                { min: -100, max: 0, label: 'שלילי', emoji: '🔴', color: '#DC2626' },
                { min: 0, max: 3, label: 'נמוך', emoji: '🟠', color: '#F97316' },
                { min: 3, max: 5, label: 'בינוני', emoji: '🟡', color: '#F59E0B' },
                { min: 5, max: 8, label: 'טוב', emoji: '🟢', color: '#10B981' },
                { min: 8, max: 100, label: 'גבוה', emoji: '🔵', color: '#6366F1' }
            ]
        },
        analogy: 'תשואת FCF היא כמו "ריבית" על ההשקעה שלך במניה, רק שהיא מבוססת על מזומנים אמיתיים ולא על רווח חשבונאי. 6% תשואת FCF אומר שהחברה מייצרת 6 אגורות מזומנים על כל שקל שאתה משלם על המניה.',
        pitfalls: [
            'תשואת FCF גבוהה מאוד עשויה להצביע על חברה שלא משקיעה בצמיחה',
            'FCF שלילי לא תמיד רע — חברות צומחות משקיעות הרבה',
            'FCF יכול להיות תנודתי — הסתכל על ממוצע 3 שנים'
        ],
        related: [
            { id: 'pm', name: 'שולי רווח נקי', relation: 'PM גבוה + FCF נמוך = הרווחים "נתקעים" בלקוחות או במלאי. בעייתי.' },
            { id: 'fcf-growth', name: 'צמיחת FCF', relation: 'תשואה גבוהה + צמיחה חיובית = שילוב מנצח.' }
        ],
        interpretation: {
            thresholds: [
                { max: 0, verdict: 'poor', text: 'תזרים מזומנים שלילי — החברה שורפת מזומנים. בדוק אם זו השקעה בצמיחה או בעיה.' },
                { max: 2, verdict: 'poor', text: 'תשואה נמוכה — החברה לא מייצרת הרבה מזומנים ביחס למחיר.' },
                { max: 5, verdict: 'average', text: 'תשואה סבירה. החברה מייצרת מזומנים בקצב סביר.' },
                { max: 8, verdict: 'good', text: 'תשואה טובה — יש מספיק מזומנים לדיבידנדים, רכישות עצמיות או הפחתת חוב.' },
                { max: 12, verdict: 'excellent', text: 'תשואה מצוינת! החברה היא "מכונת מזומנים".' },
                { max: 999, verdict: 'excellent', text: 'תשואה גבוהה במיוחד — בדוק שאין אירוע חד-פעמי או שהשוק לא מתמחר סיכון.' }
            ],
            questions: [
                'האם ה-FCF יציב או תנודתי מאוד?',
                'איפה הולך ה-FCF — דיבידנדים, רכישות עצמיות, או החזר חוב?',
                'האם יש השקעות הוניות גדולות צפויות?'
            ]
        }
    },
    'fcf-growth': {
        icon: '🌱',
        category: 'צמיחה',
        formula: {
            main: 'CAGR = [(<span class="fm-num">FCF סוף</span> <span class="fm-op">÷</span> <span class="fm-den">FCF התחלה</span>)<sup>1/n</sup> <span class="fm-op">−</span> 1] <span class="fm-op">×</span> 100%',
            parts: [
                { symbol: 'CAGR', meaning: 'קצב צמיחה שנתי מורכב' },
                { symbol: 'n', meaning: 'מספר השנים (בד"כ 5)' }
            ]
        },
        scale: {
            ranges: [
                { min: -100, max: 0, label: 'שלילי', emoji: '🔴', color: '#DC2626' },
                { min: 0, max: 5, label: 'חלש', emoji: '🟠', color: '#F97316' },
                { min: 5, max: 10, label: 'בינוני', emoji: '🟡', color: '#F59E0B' },
                { min: 10, max: 20, label: 'חזק', emoji: '🟢', color: '#10B981' },
                { min: 20, max: 100, label: 'יוצא דופן', emoji: '🔵', color: '#6366F1' }
            ]
        },
        analogy: 'אם הילד שלך גדל 10% בשנה, תוך 7 שנים הוא יהיה כפול מהגובה. צמיחת FCF עובדת אותו דבר — 15% צמיחה שנתית אומר שהתזרים יוכפל תוך ~5 שנים.',
        pitfalls: [
            'צמיחה מבסיס נמוך קלה — 50% צמיחה מ-1 מיליון פחות מרשימה מ-10% מ-100 מיליון',
            'צמיחת FCF לעתים תנודתית יותר מצמיחת EPS — זה נורמלי',
            'צמיחה שנובעת מצמצום CAPEX = צמיחה "מזויפת" שפוגעת בעתיד'
        ],
        related: [
            { id: 'eps-growth', name: 'צמיחת EPS', relation: 'אם צמיחת FCF > צמיחת EPS, איכות הרווחים גבוהה. להיפך — יש לבדוק.' },
            { id: 'fcf-yield', name: 'תשואת FCF', relation: 'צמיחה חזקה + תשואה גבוהה = שילוב נדיר ואטרקטיבי.' }
        ],
        interpretation: {
            thresholds: [
                { max: 0, verdict: 'poor', text: 'צמיחה שלילית — התזרים יורד. יש לבדוק אם זה מגמה או אירוע חד-פעמי.' },
                { max: 5, verdict: 'average', text: 'צמיחה צנועה — עדיף מאפס, אך לא מרשים. אופייני לחברות בוגרות.' },
                { max: 10, verdict: 'good', text: 'צמיחה טובה — החברה מגדילה את יכולת ייצור המזומנים שלה.' },
                { max: 20, verdict: 'excellent', text: 'צמיחה מרשימה! התזרים גדל בקצב מהיר — סימן לעסק בריא.' },
                { max: 999, verdict: 'excellent', text: 'צמיחה יוצאת דופן — בדוק שהיא בת-קיימא ולא חד-פעמית.' }
            ],
            questions: [
                'מה מניע את הצמיחה — הכנסות או קיצוץ הוצאות?',
                'האם הצמיחה עקבית או הייתה שנה חריגה?',
                'מה התחזיות להמשך הצמיחה?'
            ]
        }
    },
    'eps-growth': {
        icon: '📈',
        category: 'צמיחה',
        formula: {
            main: 'CAGR = [(<span class="fm-num">EPS סוף</span> <span class="fm-op">÷</span> <span class="fm-den">EPS התחלה</span>)<sup>1/n</sup> <span class="fm-op">−</span> 1] <span class="fm-op">×</span> 100%',
            parts: [
                { symbol: 'EPS', meaning: 'רווח למניה (Earnings Per Share)' },
                { symbol: 'n', meaning: 'מספר השנים (בד"כ 5)' }
            ]
        },
        scale: {
            ranges: [
                { min: -100, max: 0, label: 'שלילי', emoji: '🔴', color: '#DC2626' },
                { min: 0, max: 5, label: 'איטי', emoji: '🟠', color: '#F97316' },
                { min: 5, max: 10, label: 'בינוני', emoji: '🟡', color: '#F59E0B' },
                { min: 10, max: 20, label: 'חזק', emoji: '🟢', color: '#10B981' },
                { min: 20, max: 100, label: 'מטאורי', emoji: '🔵', color: '#6366F1' }
            ]
        },
        analogy: 'אם הרווח למניה גדל 12% בשנה, ואתה מחזיק 100 מניות, הרווח "שלך" גדל באותו קצב. זו הסיבה שחברות צמיחה נסחרות במכפילים גבוהים — המשקיעים קונים רווחים עתידיים.',
        pitfalls: [
            'צמיחת EPS מרכישות עצמיות היא "קוסמטית" — פחות מניות = יותר EPS גם בלי צמיחה אמיתית',
            'EPS ניתן למניפולציה קלה יותר מ-FCF — הקפד על השוואה',
            'צמיחה מבסיס נמוך או שלילי מעוותת את התמונה'
        ],
        related: [
            { id: 'fcf-growth', name: 'צמיחת FCF', relation: 'פער גדול בין צמיחת EPS ל-FCF מעיד על בעיית איכות רווחים.' },
            { id: 'pe', name: 'יחס P/E', relation: 'צמיחת EPS גבוהה מצדיקה P/E גבוה יותר.' },
            { id: 'peg', name: 'יחס PEG', relation: 'PEG משלב את P/E עם צמיחת EPS — תמונה מלאה יותר.' }
        ],
        interpretation: {
            thresholds: [
                { max: 0, verdict: 'poor', text: 'צמיחה שלילית — הרווח למניה יורד. יש לבדוק את הסיבות.' },
                { max: 5, verdict: 'average', text: 'צמיחה איטית — אופייני לחברות בוגרות בשווקים רוויים.' },
                { max: 12, verdict: 'good', text: 'צמיחה טובה — החברה מגדילה רווחים בקצב בריא.' },
                { max: 20, verdict: 'excellent', text: 'צמיחה מרשימה! אם עקבית, מצדיקה פרמיית מחיר.' },
                { max: 999, verdict: 'excellent', text: 'צמיחה אגרסיבית — בדוק שאינה נובעת מאירועים חד-פעמיים.' }
            ],
            questions: [
                'כמה מהצמיחה נובעת מרכישות עצמיות?',
                'האם הצמיחה אורגנית או מרכישות חברות?',
                'מהן תחזיות האנליסטים להמשך?'
            ]
        }
    },
    'buyback': {
        icon: '🔄',
        category: 'צמיחה',
        formula: {
            main: '<span class="fm-num">מניות שנרכשו</span> <span class="fm-op">÷</span> <span class="fm-den">סך מניות בתחילת שנה</span> <span class="fm-op">×</span> 100%',
            parts: [
                { symbol: 'מניות שנרכשו', meaning: 'מספר המניות שהחברה קנתה מהשוק' },
                { symbol: 'סך מניות', meaning: 'כמות המניות הקיימת' }
            ]
        },
        scale: {
            ranges: [
                { min: -10, max: 0, label: 'דילול', emoji: '🔴', color: '#DC2626' },
                { min: 0, max: 1, label: 'מינימלי', emoji: '🟠', color: '#F97316' },
                { min: 1, max: 2, label: 'בינוני', emoji: '🟡', color: '#F59E0B' },
                { min: 2, max: 4, label: 'משמעותי', emoji: '🟢', color: '#10B981' },
                { min: 4, max: 20, label: 'אגרסיבי', emoji: '🔵', color: '#6366F1' }
            ]
        },
        analogy: 'דמיין פיצה מחולקת ל-8. אם מישהו קונה חתיכה ושורף אותה, עכשיו יש רק 7 חתיכות — וכל חתיכה שלך שווה יותר. רכישה עצמית עושה בדיוק את זה למניות שלך.',
        pitfalls: [
            'רכישה עצמית במחיר גבוה מדי הורסת ערך — בדוק באיזה מחיר קונים',
            'רכישות ממומנות מחוב = העברת סיכון מבעלי המניות למחזיקי האג"ח',
            'רכישות עצמיות גדולות לפעמים מסתירות חוסר הזדמנויות השקעה'
        ],
        related: [
            { id: 'de', name: 'יחס חוב להון', relation: 'אם D/E עולה במקביל לרכישות — הרכישות ממומנות מחוב. פחות טוב.' },
            { id: 'fcf-yield', name: 'תשואת FCF', relation: 'רכישות עצמיות צריכות להיות ממומנות מ-FCF חופשי, לא מחוב.' }
        ],
        interpretation: {
            thresholds: [
                { max: 0, verdict: 'poor', text: 'החברה מנפיקה מניות — מדללת את בעלי המניות הקיימים.' },
                { max: 0.5, verdict: 'average', text: 'רכישה עצמית מינימלית — בעיקר מקזזת הנפקות לעובדים.' },
                { max: 2, verdict: 'good', text: 'רכישה עצמית משמעותית — ההנהלה מאמינה שהמניה זולה.' },
                { max: 5, verdict: 'excellent', text: 'רכישה אגרסיבית — סימן לאמון גבוה של ההנהלה במניה.' },
                { max: 999, verdict: 'excellent', text: 'רכישה חריגה — בדוק שממומנת מתזרים ולא מחוב.' }
            ],
            questions: [
                'מאיפה מגיע הכסף לרכישות — FCF או חוב?',
                'באיזה מחיר ממוצע בוצעו הרכישות?',
                'האם ההנהלה רוכשת גם לעצמה מניות?'
            ]
        }
    },
    'pe': {
        icon: '⚖️',
        category: 'הערכת שווי',
        formula: {
            main: '<span class="fm-num">מחיר המניה</span> <span class="fm-op">÷</span> <span class="fm-den">רווח למניה (EPS)</span>',
            parts: [
                { symbol: 'מחיר', meaning: 'מה שאתה משלם על המניה' },
                { symbol: 'EPS', meaning: 'הרווח השנתי לכל מניה' }
            ]
        },
        scale: {
            ranges: [
                { min: 0, max: 10, label: 'זול', emoji: '🟢', color: '#10B981' },
                { min: 10, max: 18, label: 'סביר', emoji: '🟡', color: '#F59E0B' },
                { min: 18, max: 30, label: 'יקר', emoji: '🟠', color: '#F97316' },
                { min: 30, max: 100, label: 'יקר מאוד', emoji: '🔴', color: '#DC2626' }
            ]
        },
        analogy: 'P/E של 15 אומר שאתה משלם 15 ₪ על כל 1 ₪ של רווח שנתי. זה כמו לשאול: "כמה שנים ייקח לרווחים להחזיר לי את ההשקעה?" (בהנחה שהרווח קבוע).',
        pitfalls: [
            'P/E נמוך לא תמיד = הזדמנות. אולי השוק מתמחר בעיות שאתה לא רואה',
            'P/E גבוה לא תמיד = מניה יקרה. חברות צומחות ראויות לפרמיה',
            'P/E שלילי = הפסדי — המדד לא רלוונטי במצב כזה',
            'השוואה בין ענפים שונים מטעה — טכנולוגיה vs. בנקים'
        ],
        related: [
            { id: 'peg', name: 'יחס PEG', relation: 'PEG מתקן את P/E לפי צמיחה — P/E גבוה + צמיחה גבוהה = PEG נמוך.' },
            { id: 'eps-growth', name: 'צמיחת EPS', relation: 'P/E גבוה מוצדק רק אם יש צמיחת EPS חזקה.' }
        ],
        interpretation: {
            thresholds: [
                { max: 8, verdict: 'excellent', text: 'P/E נמוך מאוד — ייתכן שהשוק מתמחר סיכון או בעיה. בדוק לעומק.' },
                { max: 15, verdict: 'good', text: 'P/E סביר — מחיר הוגן לחברה יציבה.' },
                { max: 25, verdict: 'average', text: 'P/E גבוה — מצדיק את עצמו רק אם יש צמיחה חזקה.' },
                { max: 40, verdict: 'poor', text: 'P/E גבוה מאוד — המשקיעים מצפים לצמיחה אגרסיבית. סיכון גבוה.' },
                { max: 999, verdict: 'poor', text: 'P/E קיצוני — אלא אם יש צמיחה יוצאת דופן, זה מחיר מנופח.' }
            ],
            questions: [
                'מהו ה-P/E הממוצע בענף?',
                'מהו ה-P/E ההיסטורי של החברה?',
                'האם הרווחים כוללים אירועים חד-פעמיים?'
            ]
        }
    },
    'peg': {
        icon: '📐',
        category: 'הערכת שווי',
        formula: {
            main: '<span class="fm-num">P/E</span> <span class="fm-op">÷</span> <span class="fm-den">צמיחת EPS (%)</span>',
            parts: [
                { symbol: 'P/E', meaning: 'יחס מחיר לרווח' },
                { symbol: 'צמיחת EPS', meaning: 'קצב צמיחת הרווח (%)' }
            ]
        },
        scale: {
            ranges: [
                { min: 0, max: 0.8, label: 'זול', emoji: '🟢', color: '#10B981' },
                { min: 0.8, max: 1.2, label: 'הוגן', emoji: '🟡', color: '#F59E0B' },
                { min: 1.2, max: 2, label: 'יקר', emoji: '🟠', color: '#F97316' },
                { min: 2, max: 10, label: 'יקר מאוד', emoji: '🔴', color: '#DC2626' }
            ]
        },
        analogy: 'PEG של 1 אומר שאתה משלם "מחיר הוגן" על הצמיחה — P/E של 20 עם צמיחה של 20%. PEG מתחת ל-1 = אתה מקבל צמיחה "בהנחה".',
        pitfalls: [
            'PEG מניח שהצמיחה תימשך — אם היא תיעצר, ה-PEG חסר משמעות',
            'צמיחה נמוכה מאוד (2-3%) מעוותת את ה-PEG — המספר מתנפח',
            'PEG לא מתאים לחברות מחזוריות או עם רווחים תנודתיים'
        ],
        related: [
            { id: 'pe', name: 'יחס P/E', relation: 'PEG "מתקן" את P/E לצמיחה — נותן תמונה מלאה יותר.' },
            { id: 'eps-growth', name: 'צמיחת EPS', relation: 'המכנה של ה-PEG. צמיחה גבוהה יותר = PEG נמוך יותר.' }
        ],
        interpretation: {
            thresholds: [
                { max: 0.7, verdict: 'excellent', text: 'PEG מצוין! הצמיחה "זולה" ביחס למחיר. הזדמנות פוטנציאלית.' },
                { max: 1.0, verdict: 'excellent', text: 'PEG מצוין — מחיר הוגן עד זול לצמיחה שמקבלים.' },
                { max: 1.5, verdict: 'good', text: 'PEG סביר — לא זול, אבל גם לא יקר. בהתאם לאיכות החברה.' },
                { max: 2.0, verdict: 'average', text: 'PEG גבוה — משלמים פרמיה על הצמיחה.' },
                { max: 999, verdict: 'poor', text: 'PEG גבוה מאוד — המחיר לא מוצדק ע"י הצמיחה הצפויה.' }
            ],
            questions: [
                'האם הצמיחה הצפויה ריאלית או אופטימית מדי?',
                'מהו ה-PEG של המתחרים?',
                'איך נראה ה-PEG ההיסטורי של החברה?'
            ]
        }
    },
    'cr': {
        icon: '💳',
        category: 'יציבות פיננסית',
        formula: {
            main: '<span class="fm-num">נכסים שוטפים</span> <span class="fm-op">÷</span> <span class="fm-den">התחייבויות שוטפות</span>',
            parts: [
                { symbol: 'נכסים שוטפים', meaning: 'מזומנים, לקוחות, מלאי' },
                { symbol: 'התחייב\' שוטפות', meaning: 'חובות לשנה הקרובה' }
            ]
        },
        scale: {
            ranges: [
                { min: 0, max: 1.0, label: 'מסוכן', emoji: '🔴', color: '#DC2626' },
                { min: 1.0, max: 1.3, label: 'נמוך', emoji: '🟠', color: '#F97316' },
                { min: 1.3, max: 2.0, label: 'בריא', emoji: '🟢', color: '#10B981' },
                { min: 2.0, max: 3.0, label: 'חזק', emoji: '🔵', color: '#6366F1' },
                { min: 3.0, max: 20, label: 'גבוה מאוד', emoji: '🟡', color: '#F59E0B' }
            ]
        },
        analogy: 'יחס שוטף של 1.5 אומר: על כל 1 ₪ שהחברה חייבת בשנה הקרובה, יש לה 1.5 ₪ נכסים נזילים. זה כמו לשאול: "אם כל החובות מגיעים לפירעון מחר, האם יש מספיק כסף?"',
        pitfalls: [
            'יחס גבוה מדי (מעל 3) עשוי להעיד על ניהול לא יעיל של ההון',
            'מלאי לא תמיד נזיל — יחס מהיר (Quick Ratio) מדויק יותר',
            'ענפים שונים = נורמות שונות. קמעונאות עובדת עם יחס נמוך יותר'
        ],
        related: [
            { id: 'de', name: 'יחס חוב להון', relation: 'D/E גבוה + CR נמוך = תמהיל מסוכן. בדוק את שניהם יחד.' },
            { id: 'altman-z', name: 'Altman Z-Score', relation: 'היחס השוטף הוא חלק מחישוב Altman Z.' }
        ],
        interpretation: {
            thresholds: [
                { max: 0.8, verdict: 'poor', text: 'יחס מסוכן — החברה עלולה להתקשות לשלם חובות קצרי טווח.' },
                { max: 1.2, verdict: 'poor', text: 'יחס נמוך — "כרית הביטחון" דקה מדי.' },
                { max: 1.8, verdict: 'average', text: 'יחס סביר — החברה יכולה לעמוד בהתחייבויות, אך הכרית דקה.' },
                { max: 2.5, verdict: 'good', text: 'יחס בריא — נזילות טובה ויציבות פיננסית.' },
                { max: 999, verdict: 'excellent', text: 'יחס חזק מאוד — נזילות מצוינת. (יחס גבוה מאוד עשוי להעיד על הון לא מנוצל)' }
            ],
            questions: [
                'כמה מהנכסים השוטפים הם מזומנים לעומת מלאי?',
                'האם יש עונתיות בתזרים שעלולה ליצור לחץ זמני?',
                'מה קווי האשראי הזמינים לחברה?'
            ]
        }
    },
    'de': {
        icon: '⚖️',
        category: 'יציבות פיננסית',
        formula: {
            main: '<span class="fm-num">סך החובות</span> <span class="fm-op">÷</span> <span class="fm-den">הון עצמי</span>',
            parts: [
                { symbol: 'סך החובות', meaning: 'חוב לטווח קצר + ארוך' },
                { symbol: 'הון עצמי', meaning: 'נכסים פחות התחייבויות' }
            ]
        },
        scale: {
            ranges: [
                { min: 0, max: 0.3, label: 'שמרני', emoji: '🔵', color: '#6366F1' },
                { min: 0.3, max: 0.7, label: 'מאוזן', emoji: '🟢', color: '#10B981' },
                { min: 0.7, max: 1.2, label: 'ממונף', emoji: '🟡', color: '#F59E0B' },
                { min: 1.2, max: 2.0, label: 'ממונף מאוד', emoji: '🟠', color: '#F97316' },
                { min: 2.0, max: 20, label: 'מסוכן', emoji: '🔴', color: '#DC2626' }
            ]
        },
        analogy: 'D/E של 0.5 אומר: על כל 1 ₪ של כסף "שלך" (הון עצמי), יש 0.5 ₪ חוב. זה כמו לקנות דירה — אם שילמת 60% והלוואה 40%, ה-D/E שלך הוא 0.67.',
        pitfalls: [
            'D/E נמוך מאוד יכול להעיד על חברה שמפחדת להשתמש במינוף — מפספסת הזדמנויות',
            'ענפים שונים = נורמות שונות לחלוטין. בנקים עובדים עם D/E של 10+',
            'חשוב להבדיל בין חוב "טוב" (ריבית נמוכה, לטווח ארוך) לחוב "רע"'
        ],
        related: [
            { id: 'roe', name: 'תשואה על ההון', relation: 'D/E גבוה יכול "לנפח" את ה-ROE. רווחיות ממונפת פחות איכותית.' },
            { id: 'cr', name: 'יחס שוטף', relation: 'D/E גבוה + CR נמוך = סיכון גבוה לקשיים פיננסיים.' },
            { id: 'altman-z', name: 'Altman Z-Score', relation: 'מינוף גבוה פוגע ב-Altman Z ומגדיל סיכון פשיטת רגל.' }
        ],
        interpretation: {
            thresholds: [
                { max: 0.3, verdict: 'excellent', text: 'מינוף נמוך מאוד — החברה כמעט לא משתמשת בחוב. יציבות גבוהה.' },
                { max: 0.6, verdict: 'good', text: 'מינוף מאוזן — שילוב בריא של הון עצמי וחוב.' },
                { max: 1.0, verdict: 'average', text: 'מינוף משמעותי — עדיין סביר, אך יש להיות עם האצבע על הדופק.' },
                { max: 1.8, verdict: 'poor', text: 'מינוף גבוה — רגישות גבוהה לשינויי ריבית או האטה כלכלית.' },
                { max: 999, verdict: 'poor', text: 'מינוף קיצוני — סיכון משמעותי. בדוק יכולת החזר החוב.' }
            ],
            questions: [
                'מהי הריבית הממוצעת על החוב?',
                'מתי מגיעים החובות לפירעון?',
                'האם יש קובננטים (תנאים) שעלולים להיפרץ?'
            ]
        }
    },
    'altman-z': {
        icon: '🛡️',
        category: 'יציבות פיננסית',
        formula: {
            main: '1.2<span class="fm-num">A</span> + 1.4<span class="fm-num">B</span> + 3.3<span class="fm-num">C</span> + 0.6<span class="fm-num">D</span> + 1.0<span class="fm-num">E</span>',
            parts: [
                { symbol: 'A', meaning: 'הון חוזר / סך נכסים' },
                { symbol: 'B', meaning: 'עודפים / סך נכסים' },
                { symbol: 'C', meaning: 'EBIT / סך נכסים' },
                { symbol: 'D', meaning: 'שווי שוק / סך התחייבויות' },
                { symbol: 'E', meaning: 'מכירות / סך נכסים' }
            ]
        },
        scale: {
            ranges: [
                { min: 0, max: 1.81, label: 'אזור סכנה', emoji: '🔴', color: '#DC2626' },
                { min: 1.81, max: 2.99, label: 'אזור אפור', emoji: '🟡', color: '#F59E0B' },
                { min: 2.99, max: 4.0, label: 'בטוח', emoji: '🟢', color: '#10B981' },
                { min: 4.0, max: 10, label: 'חזק מאוד', emoji: '🔵', color: '#6366F1' }
            ]
        },
        analogy: 'Altman Z הוא כמו "בדיקת דם" פיננסית מקיפה. הוא משלב 5 מדדים שונים לציון אחד שמנבא את הסיכוי לפשיטת רגל. מעל 3 = בטוח, מתחת ל-1.8 = אזור סכנה.',
        pitfalls: [
            'המודל פותח לחברות תעשייה אמריקאיות — פחות מדויק לבנקים, נדל"ן, סטארטאפים',
            'ציון גבוה לא מבטיח הצלחה — רק שהחברה לא צפויה לפשוט רגל בקרוב',
            'שינויים חדים ב-Z מסמנים שינוי במצב — גם אם עדיין באזור "בטוח"'
        ],
        related: [
            { id: 'de', name: 'יחס חוב להון', relation: 'מינוף גבוה פוגע ב-Z-Score. D/E ו-Altman Z נעים בכיוונים הפוכים.' },
            { id: 'cr', name: 'יחס שוטף', relation: 'נזילות (הון חוזר) היא חלק מהותי מחישוב ה-Z.' }
        ],
        interpretation: {
            thresholds: [
                { max: 1.1, verdict: 'poor', text: 'אזור סכנה חמור — סיכון גבוה מאוד לקשיים פיננסיים. נדרשת בדיקה מעמיקה.' },
                { max: 1.81, verdict: 'poor', text: 'אזור סכנה — היסטורית, חברות באזור זה נוטות לפשוט רגל.' },
                { max: 2.99, verdict: 'average', text: 'אזור אפור — לא ברור. יש לנטר מקרוב ולבדוק מגמות.' },
                { max: 4.0, verdict: 'good', text: 'אזור בטוח — סיכון נמוך לקשיים פיננסיים.' },
                { max: 999, verdict: 'excellent', text: 'יציבות מצוינת — החברה במצב פיננסי חזק מאוד.' }
            ],
            questions: [
                'מהי המגמה — האם ה-Z עולה או יורד?',
                'איזה רכיב הכי פוגע ב-Z?',
                'האם יש אירועים צפויים שעלולים לפגוע ביציבות?'
            ]
        }
    }
};

// ═══════════════════════════════════════════
// DEEP-DIVE RENDERING (closeDeepDive helper)
// ═══════════════════════════════════════════
// Note: openDeepDive is defined above with the enhanced version

function closeDeepDive() {
    document.getElementById('deepdive-modal')?.classList.remove('open');
    document.body.style.overflow = '';
}

// ═══════════════════════════════════════════
// DYNAMIC VALUE INTERPRETATION ENGINE
// ═══════════════════════════════════════════
function generateInterpretation(metricId, value) {
    const data = metricDeepDive[metricId];
    if (!data || !data.interpretation) return null;

    const { thresholds, questions } = data.interpretation;
    if (isNaN(value)) return null;

    // Find matching threshold
    let result = thresholds[thresholds.length - 1]; // default to last
    for (const t of thresholds) {
        if (value <= t.max) {
            result = t;
            break;
        }
    }

    return {
        verdict: result.verdict,
        text: result.text,
        questions: questions
    };
}

function getInterpretationXref(metricId, value, allValues) {
    // Cross-reference logic
    const xrefs = [];

    if (metricId === 'roe' && allValues.de !== undefined) {
        if (value > 15 && allValues.de > 1.0) {
            xrefs.push({ type: 'warning', text: `ROE גבוה של ${value.toFixed(1)}% אך יחס חוב/הון ${allValues.de.toFixed(2)} מעיד על מינוף — הרווחיות עלולה להיות לא אורגנית.` });
        } else if (value > 15 && allValues.de < 0.5) {
            xrefs.push({ type: 'positive', text: `ROE גבוה עם מינוף נמוך — רווחיות איכותית ואורגנית.` });
        }
    }

    if (metricId === 'pm' && allValues['fcf-yield'] !== undefined) {
        if (value > 10 && allValues['fcf-yield'] < 3) {
            xrefs.push({ type: 'warning', text: `שולי רווח טובים אך תשואת FCF נמוכה — הרווחים עשויים לא להתממש כמזומנים.` });
        }
    }

    if (metricId === 'pe' && allValues['eps-growth'] !== undefined) {
        if (value > 25 && allValues['eps-growth'] < 10) {
            xrefs.push({ type: 'warning', text: `P/E גבוה אך צמיחת EPS מתונה — ייתכן תמחור יתר.` });
        } else if (value < 15 && allValues['eps-growth'] > 15) {
            xrefs.push({ type: 'positive', text: `P/E נמוך עם צמיחה חזקה — הזדמנות ערך פוטנציאלית.` });
        }
    }

    if (metricId === 'de' && allValues.cr !== undefined) {
        if (value > 1.0 && allValues.cr < 1.3) {
            xrefs.push({ type: 'warning', text: `מינוף גבוה בשילוב נזילות נמוכה — תמהיל מסוכן.` });
        }
    }

    if (metricId === 'fcf-growth' && allValues['eps-growth'] !== undefined) {
        if (value > allValues['eps-growth'] * 1.3) {
            xrefs.push({ type: 'positive', text: `צמיחת FCF עולה על צמיחת EPS — סימן לאיכות רווחים גבוהה.` });
        } else if (value < allValues['eps-growth'] * 0.5 && allValues['eps-growth'] > 10) {
            xrefs.push({ type: 'warning', text: `פער משמעותי בין צמיחת EPS ל-FCF — יש לבדוק את איכות הרווחים.` });
        }
    }

    return xrefs;
}

function renderMetricInterpretation(metricId) {
    const card = document.getElementById(`${metricId}-card`);
    if (!card) return;

    let interpEl = card.querySelector('.metric-interpretation');
    if (!interpEl) {
        interpEl = document.createElement('div');
        interpEl.className = 'metric-interpretation';
        const footer = card.querySelector('.metric-footer');
        if (footer) footer.before(interpEl);
        else card.appendChild(interpEl);
    }

    const metric = baseMetrics.find(m => m.id === metricId);
    if (!metric) return;

    const inp = card.querySelector(`#${metric.inputs[0].id}`);
    const value = inp ? parseFloat(inp.value) : NaN;

    if (isNaN(value)) {
        interpEl.classList.remove('visible');
        return;
    }

    const interp = generateInterpretation(metricId, value);
    if (!interp) {
        interpEl.classList.remove('visible');
        return;
    }

    // Get all values for cross-reference
    const allValues = {};
    baseMetrics.forEach(m => {
        const i = document.getElementById(m.inputs[0].id);
        if (i && i.value !== '') allValues[m.id] = parseFloat(i.value);
    });

    const xrefs = getInterpretationXref(metricId, value, allValues);

    const verdictLabels = { excellent: 'מצוין', good: 'טוב', average: 'בינוני', poor: 'חלש' };
    const verdictEmojis = { excellent: '🌟', good: '✅', average: '⚠️', poor: '🔴' };

    interpEl.innerHTML = `
        <div class="interp-header">
            <div class="interp-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 2a10 10 0 0 1 10 10"/></svg>
                פרשנות אישית
            </div>
            <button class="interp-toggle" onclick="document.getElementById('${metricId}-card').querySelector('.metric-interpretation').classList.toggle('visible')">הסתר</button>
        </div>
        <div class="interp-body">
            <span class="interp-verdict ${interp.verdict}">${verdictEmojis[interp.verdict]} ${verdictLabels[interp.verdict]}</span>
            ${interp.text}
            ${xrefs.length ? xrefs.map(x => `
                <div class="interp-xref" style="border-right-color: ${x.type === 'warning' ? 'var(--warning)' : 'var(--success)'}">
                    <strong>${x.type === 'warning' ? '⚠️ שים לב:' : '✅ נקודת חוזק:'}</strong> ${x.text}
                </div>
            `).join('') : ''}
            ${interp.questions.length ? `
                <div class="interp-questions">
                    <div class="interp-questions-title">שאלות לבדיקה נוספת</div>
                    ${interp.questions.map(q => `<div class="interp-question">${q}</div>`).join('')}
                </div>
            ` : ''}
        </div>
    `;

    interpEl.classList.add('visible');
}

function updateAllInterpretations() {
    baseMetrics.forEach(m => {
        if (metricDeepDive[m.id]) {
            renderMetricInterpretation(m.id);
        }
    });
}

// ═══════════════════════════════════════════
// INSIGHTS & RED FLAG ENGINE
// ═══════════════════════════════════════════
const metricAbbr = {
    'roi':'ROI','roe':'ROE','gross-margin':'GM','pm':'PM','fcf-yield':'FCF%',
    'fcf-growth':'FCFg','eps-growth':'EPSg','buyback':'BB',
    'pe':'P/E','peg':'PEG','cr':'CR','de':'D/E','altman-z':'AZ'
};

const insightRules = [
    // ─── A. SINGLE-METRIC RED FLAGS ───
    {
        id:'altman-critical', title:'סיכון גבוה לקשיים פיננסיים',
        desc:'ציון Altman Z מתחת ל-1.81 — אזור סכנה. מצביע על סיכון משמעותי לחדלות פירעון. יש לבחון את מבנה החוב ותזרימי המזומנים.',
        severity:'critical', icon:'💀', metrics:['altman-z'],
        check:(v)=> v['altman-z']!==undefined && v['altman-z']<1.81
    },
    {
        id:'extreme-leverage', title:'מינוף פיננסי קיצוני',
        desc:'יחס חוב להון מעל 2.0 — החברה נושאת נטל חוב כבד שעלול להגביל גמישות ולהגדיל סיכון בתקופות שפל.',
        severity:'critical', icon:'⚡', metrics:['de'],
        check:(v)=> v.de!==undefined && v.de>2.0
    },
    {
        id:'liquidity-crisis', title:'סיכון נזילות חמור',
        desc:'יחס שוטף מתחת ל-1.0 — החברה עלולה להתקשות לכסות התחייבויות שוטפות. מצב שעלול לדרוש גיוס הון דחוף.',
        severity:'critical', icon:'🚨', metrics:['cr'],
        check:(v)=> v.cr!==undefined && v.cr<1.0
    },
    {
        id:'negative-roe', title:'תשואה שלילית על ההון',
        desc:'ROE שלילי מעיד על כך שהחברה שורפת הון במקום לייצר ערך לבעלי המניות.',
        severity:'critical', icon:'📉', metrics:['roe'],
        check:(v)=> v.roe!==undefined && v.roe<0
    },
    {
        id:'negative-margins', title:'שולי רווח שליליים',
        desc:'החברה מפסידה על כל שקל הכנסה — יש לבחון האם מדובר במצב זמני או מבני.',
        severity:'warning', icon:'📊', metrics:['pm'],
        check:(v)=> v.pm!==undefined && v.pm<0
    },
    {
        id:'extreme-pe', title:'מכפיל רווח גבוה במיוחד',
        desc:'P/E מעל 40 — המשקיעים משלמים פרמיה חריגה. נדרשת צמיחה יוצאת דופן כדי להצדיק.',
        severity:'warning', icon:'🎈', metrics:['pe'],
        check:(v)=> v.pe!==undefined && v.pe>40
    },
    {
        id:'weak-fcf', title:'תזרים מזומנים חופשי חלש',
        desc:'תשואת FCF מתחת ל-2% — יכולת נמוכה לייצר מזומנים פנויים לדיבידנדים, רכישות עצמיות או השקעות.',
        severity:'warning', icon:'💧', metrics:['fcf-yield'],
        check:(v)=> v['fcf-yield']!==undefined && v['fcf-yield']>0 && v['fcf-yield']<2
    },
    {
        id:'aggressive-buyback', title:'רכישה עצמית אגרסיבית',
        desc:'רכישה עצמית מעל 5% בשנה — ההנהלה מפגינה אמון במניה. כדאי לבחון שהמימון לא מחוב.',
        severity:'info', icon:'🔄', metrics:['buyback'],
        check:(v)=> v.buyback!==undefined && v.buyback>5
    },

    // ─── B. CROSS-METRIC CORRELATIONS ───
    {
        id:'leveraged-growth', title:'צמיחה ממונפת — ROE תלוי חוב',
        desc:'ROE גבוה נתמך ע"י חוב משמעותי. הרווחיות עלולה להיפגע בעליית ריבית או בהאטה כלכלית.',
        severity:'warning', icon:'⚠️', metrics:['roe','de'],
        check:(v)=> v.roe!==undefined && v.de!==undefined && v.roe>15 && v.de>1.5
    },
    {
        id:'organic-profitability', title:'רווחיות אורגנית מעולה',
        desc:'ROE גבוה עם מינוף נמוך — החברה מייצרת תשואה חזקה על ההון מכוח עצמה, ללא תלות בחוב.',
        severity:'positive', icon:'🌱', metrics:['roe','de'],
        check:(v)=> v.roe!==undefined && v.de!==undefined && v.roe>15 && v.de<0.5
    },
    {
        id:'value-opportunity', title:'הזדמנות ערך פוטנציאלית',
        desc:'P/E נמוך עם צמיחת EPS חזקה — ייתכן שהשוק לא מתמחר את פוטנציאל הצמיחה.',
        severity:'positive', icon:'💎', metrics:['pe','eps-growth'],
        check:(v,s,m)=>{
            const peT=m==='growth'?25:m==='value'?12:15;
            return v.pe!==undefined && v['eps-growth']!==undefined && v.pe>0 && v.pe<peT && v['eps-growth']>10;
        }
    },
    {
        id:'overvalued-no-growth', title:'מכפיל גבוה ללא גיבוי צמיחה',
        desc:'P/E מעל 25 אך צמיחת EPS חלשה — השוק מתמחר ציפיות שייתכן ולא יתממשו.',
        severity:'warning', icon:'🎯', metrics:['pe','eps-growth'],
        check:(v)=> v.pe!==undefined && v['eps-growth']!==undefined && v.pe>25 && v['eps-growth']<5
    },
    {
        id:'margin-erosion', title:'שחיקת מרווחים',
        desc:'צמיחת מרווח גולמי שלילית — ייתכן לחץ תחרותי, עליית עלויות חומרי גלם, או אובדן כוח תמחור.',
        severity:'warning', icon:'✂️', metrics:['gross-margin'],
        check:(v)=> v['gross-margin-growth']!==undefined && v['gross-margin-growth']<0
    },
    {
        id:'cash-machine', title:'מכונת מזומנים',
        desc:'שולי רווח גבוהים בשילוב תשואת FCF חזקה — החברה ממירה הכנסות למזומנים ביעילות רבה.',
        severity:'positive', icon:'💰', metrics:['pm','fcf-yield'],
        check:(v)=> v.pm!==undefined && v['fcf-yield']!==undefined && v.pm>15 && v['fcf-yield']>5
    },
    {
        id:'accounting-vs-cash', title:'פער בין רווח חשבונאי לתזרים',
        desc:'רווח נקי חיובי אך FCF חלש — ייתכן שהרווחים אינם מגובים במזומנים ממשיים. יש לבדוק הוצאות הוניות.',
        severity:'warning', icon:'🔍', metrics:['pm','fcf-yield'],
        check:(v)=> v.pm!==undefined && v['fcf-yield']!==undefined && v.pm>10 && v['fcf-yield']<2
    },
    {
        id:'leverage-liquidity-combo', title:'מינוף גבוה + נזילות נמוכה',
        desc:'חוב גבוה בשילוב יחס שוטף נמוך — תמהיל מסוכן שעלול להוביל לקשיים בשירות החוב.',
        severity:'critical', icon:'🔥', metrics:['de','cr'],
        check:(v)=> v.de!==undefined && v.cr!==undefined && v.de>1.0 && v.cr<1.5
    },
    {
        id:'eps-fcf-divergence', title:'פער צמיחה: EPS מול FCF',
        desc:'צמיחת EPS גבוהה משמעותית מצמיחת FCF — ייתכנו מניפולציות חשבונאיות או הוצאות הוניות גבוהות.',
        severity:'warning', icon:'↔️', metrics:['eps-growth','fcf-growth'],
        check:(v)=> v['eps-growth']!==undefined && v['fcf-growth']!==undefined && v['eps-growth']>v['fcf-growth']*2 && v['eps-growth']>10
    },
    {
        id:'double-efficiency', title:'יעילות כפולה',
        desc:'תשואה גבוהה הן על ההשקעה והן על ההון — ניהול אפקטיבי ומיצוי מרבי של כל שקל מושקע.',
        severity:'positive', icon:'🏆', metrics:['roi','roe'],
        check:(v)=> v.roi!==undefined && v.roe!==undefined && v.roi>15 && v.roe>15
    },
    {
        id:'attractive-valuation', title:'תמחור אטרקטיבי כפול',
        desc:'PEG מתחת ל-1 וגם P/E נמוך — שני מדדי ההערכה מצביעים על מניה זולה ביחס לצמיחתה.',
        severity:'positive', icon:'🏷️', metrics:['peg','pe'],
        check:(v)=> v.peg!==undefined && v.pe!==undefined && v.peg<1 && v.pe>0 && v.pe<20
    },
    {
        id:'double-overvalued', title:'הערכת יתר כפולה',
        desc:'PEG מעל 2 ו-P/E מעל 30 — שני מדדי ההערכה מצביעים על תמחור יקר.',
        severity:'warning', icon:'💸', metrics:['peg','pe'],
        check:(v)=> v.peg!==undefined && v.pe!==undefined && v.peg>2 && v.pe>30
    },
    {
        id:'fortress-balance', title:'מאזן מבוצר',
        desc:'Altman Z גבוה עם מינוף נמוך — החברה בעמדה פיננסית חזקה ויציבה במיוחד.',
        severity:'positive', icon:'🏰', metrics:['altman-z','de'],
        check:(v)=> v['altman-z']!==undefined && v.de!==undefined && v['altman-z']>3 && v.de<0.5
    },
    {
        id:'altman-gray', title:'Altman Z — אזור אפור',
        desc:'ציון בטווח 1.81–2.99. לא בסכנה מיידית, אך נדרש ניטור צמוד של היציבות הפיננסית.',
        severity:'warning', icon:'🌫️', metrics:['altman-z'],
        check:(v)=> v['altman-z']!==undefined && v['altman-z']>=1.81 && v['altman-z']<2.99
    },
    {
        id:'economic-moat', title:'חפיר כלכלי (Economic Moat)',
        desc:'מרווח גולמי ושולי רווח נקי גבוהים במיוחד — מעיד על יתרון תחרותי עמיד וכוח תמחור.',
        severity:'positive', icon:'🛡️', metrics:['gross-margin','pm'],
        check:(v)=> v['gross-margin']!==undefined && v.pm!==undefined && v['gross-margin']>50 && v.pm>20
    },
    {
        id:'fcf-leads-eps', title:'איכות רווחים גבוהה',
        desc:'צמיחת FCF עולה על צמיחת EPS — הרווחים מגובים בתזרים אמיתי. סימן חיובי לאיכות הדוחות.',
        severity:'positive', icon:'💵', metrics:['fcf-growth','eps-growth'],
        check:(v)=> v['fcf-growth']!==undefined && v['eps-growth']!==undefined && v['fcf-growth']>v['eps-growth'] && v['fcf-growth']>10
    },
    {
        id:'buyback-from-debt', title:'רכישה עצמית ממומנת מחוב?',
        desc:'רכישה עצמית משמעותית בשילוב חוב גבוה — יש לבדוק אם המימון מתזרים חופשי או מהנפקת חוב.',
        severity:'warning', icon:'🔄', metrics:['buyback','de'],
        check:(v)=> v.buyback!==undefined && v.de!==undefined && v.buyback>3 && v.de>1.0
    },
    {
        id:'high-gm-low-pm', title:'פער בין מרווח גולמי לנקי',
        desc:'מרווח גולמי גבוה אך שולי רווח נקי נמוכים — הוצאות תפעוליות, מו"פ, או ריבית משחקות את הרווח.',
        severity:'warning', icon:'📐', metrics:['gross-margin','pm'],
        check:(v)=> v['gross-margin']!==undefined && v.pm!==undefined && v['gross-margin']>40 && v.pm<10
    },

    // ─── C. CATEGORY-LEVEL RULES ───
    {
        id:'strong-profitability', title:'רווחיות חזקה רוחבית',
        desc:'מרבית מדדי הרווחיות מציגים ביצועים טובים — בסיס יציב לצמיחה עתידית.',
        severity:'positive', icon:'⭐', metrics:['roi','roe','gross-margin','pm','fcf-yield'],
        check:(v,s)=>{
            const ids=['roi','roe','gross-margin','pm','fcf-yield'];
            const f=ids.filter(id=>s[id]!==undefined&&s[id]>0);
            return f.length>=3 && f.every(id=>s[id]>=50);
        }
    },
    {
        id:'weak-profitability', title:'חולשה מערכתית ברווחיות',
        desc:'מרבית מדדי הרווחיות חלשים — ייתכן שהמודל העסקי לא יעיל או שהחברה בתקופת מעבר.',
        severity:'critical', icon:'⚠️', metrics:['roi','roe','gross-margin','pm','fcf-yield'],
        check:(v,s)=>{
            const ids=['roi','roe','gross-margin','pm','fcf-yield'];
            const f=ids.filter(id=>v[id]!==undefined);
            return f.length>=3 && f.filter(id=>(s[id]||0)<30).length>=3;
        }
    },
    {
        id:'growth-engine', title:'מנוע צמיחה פעיל',
        desc:'מדדי הצמיחה מרשימים — החברה מגדילה רווחים ותזרים בקצב חזק.',
        severity:'positive', icon:'🚀', metrics:['fcf-growth','eps-growth'],
        check:(v,s)=>{
            const ids=['fcf-growth','eps-growth'];
            const f=ids.filter(id=>s[id]!==undefined&&s[id]>0);
            return f.length>=2 && f.every(id=>s[id]>=60);
        }
    },
    {
        id:'stagnant-growth', title:'קיפאון בצמיחה',
        desc:'מדדי הצמיחה חלשים — החברה לא מצליחה להגדיל רווחים או תזרימים בקצב מספק.',
        severity:'warning', icon:'🐌', metrics:['fcf-growth','eps-growth'],
        check:(v,s)=>{
            const ids=['fcf-growth','eps-growth'];
            const f=ids.filter(id=>v[id]!==undefined);
            return f.length>=2 && f.every(id=>(s[id]||0)<25);
        }
    },
    {
        id:'cheap-on-both', title:'נסחרת בהנחה',
        desc:'שני מדדי ההערכה מצביעים על תמחור אטרקטיבי — שווה בחינה מעמיקה.',
        severity:'positive', icon:'🟢', metrics:['pe','peg'],
        check:(v,s)=> s.pe!==undefined && s.peg!==undefined && s.pe>=60 && s.peg>=60
    },
    {
        id:'expensive-on-both', title:'נסחרת בפרמיה',
        desc:'שני מדדי ההערכה מצביעים על תמחור יקר — צמיחה חזקה נדרשת כדי להצדיק את המחיר.',
        severity:'warning', icon:'💸', metrics:['pe','peg'],
        check:(v,s)=> s.pe!==undefined && s.peg!==undefined && s.pe<30 && s.peg<30
    },
    {
        id:'rock-solid', title:'יציבות פיננסית מעולה',
        desc:'כל מדדי היציבות חזקים — מאזן בריא, נזילות גבוהה, וסיכון פשיטת רגל נמוך.',
        severity:'positive', icon:'🪨', metrics:['cr','de','altman-z'],
        check:(v,s)=>{
            const ids=['cr','de','altman-z'];
            const f=ids.filter(id=>s[id]!==undefined&&s[id]>0);
            return f.length>=2 && f.every(id=>s[id]>=60);
        }
    },
    {
        id:'mixed-stability', title:'אותות מעורבים ביציבות',
        desc:'חלק ממדדי היציבות חזקים וחלקם חלשים — כדאי לבחון מה גורם לפער ולנטר מקרוב.',
        severity:'info', icon:'🔀', metrics:['cr','de','altman-z'],
        check:(v,s)=>{
            const ids=['cr','de','altman-z'];
            const f=ids.filter(id=>s[id]!==undefined);
            if(f.length<2)return false;
            return f.filter(id=>s[id]>=60).length>=1 && f.filter(id=>s[id]<40).length>=1;
        }
    },

    // ─── D. MODE-SPECIFIC ───
    {
        id:'growth-mode-weak-eps', title:'צמיחת EPS חלשה לפרופיל צמיחה',
        desc:'בפרופיל צמיחה, EPS מתחת ל-5% אינו עומד בציפיות. שקול פרופיל ערך או מאוזן.',
        severity:'warning', icon:'🔄', metrics:['eps-growth'],
        check:(v,s,m)=> m==='growth' && v['eps-growth']!==undefined && v['eps-growth']<5
    },
    {
        id:'value-mode-high-pe', title:'P/E גבוה לפרופיל ערך',
        desc:'P/E מעל 20 בפרופיל ערך — המניה לא עונה על קריטריוני ערך קלאסיים. שקול פרופיל צמיחה.',
        severity:'warning', icon:'💰', metrics:['pe'],
        check:(v,s,m)=> m==='value' && v.pe!==undefined && v.pe>20
    },
    {
        id:'value-low-fcf', title:'FCF חלש בפרופיל ערך',
        desc:'תשואת FCF מתחת ל-4% בפרופיל ערך — משקיעי ערך מחפשים תזרים מזומנים חזק כמנגנון הגנה.',
        severity:'warning', icon:'💧', metrics:['fcf-yield'],
        check:(v,s,m)=> m==='value' && v['fcf-yield']!==undefined && v['fcf-yield']>0 && v['fcf-yield']<4
    },
    {
        id:'growth-strong-fcfg', title:'צמיחת FCF מרשימה',
        desc:'בפרופיל צמיחה — צמיחת תזרים חזקה מעידה על מנוע צמיחה בריא ואיכותי.',
        severity:'positive', icon:'🌟', metrics:['fcf-growth'],
        check:(v,s,m)=> m==='growth' && v['fcf-growth']!==undefined && v['fcf-growth']>15
    },

    // ─── E. ADVANCED PATTERNS ───
    {
        id:'small-sample', title:'ציון מבוסס על מדגם קטן',
        desc:'הניתוח מבוסס על פחות מ-6 מדדים. הוסף עוד נתונים לקבלת תמונה מלאה ומהימנה יותר.',
        severity:'info', icon:'📊', metrics:[],
        check:(v,s)=>{
            const filled=Object.keys(v).filter(k=>k!=='gross-margin-growth').length;
            return filled>=3 && filled<6;
        }
    },
    {
        id:'comprehensive-weak', title:'חולשה מהותית בתמונה הרחבה',
        desc:'עם 10+ מדדים מלאים והציון נמוך — הנתונים מצביעים על בעיות יסודיות בחברה.',
        severity:'critical', icon:'🚩', metrics:[],
        check:(v,s)=>{
            const filled=Object.keys(v).filter(k=>k!=='gross-margin-growth').length;
            const sc=Object.values(s).filter(x=>x>0);
            const avg=sc.length>0?sc.reduce((a,b)=>a+b,0)/sc.length:0;
            return filled>=10 && avg<35;
        }
    },
    {
        id:'roi-over-roe', title:'ROI עולה על ROE',
        desc:'תשואת ההשקעה גבוהה משמעותית מתשואת ההון — ייתכן שההון העצמי לא ממונף בצורה אופטימלית.',
        severity:'info', icon:'🔬', metrics:['roi','roe'],
        check:(v)=> v.roi!==undefined && v.roe!==undefined && v.roi>v.roe*1.5 && v.roi>10
    },
    {
        id:'balanced-excellence', title:'פרופיל מאוזן ואיכותי',
        desc:'בפרופיל מאוזן עם נתונים מגוונים — הציון הכולל מרשים ומעיד על חברה איכותית.',
        severity:'positive', icon:'🌈', metrics:[],
        check:(v,s,m)=>{
            if(m!=='balanced')return false;
            const sc=Object.values(s).filter(x=>x>0);
            const avg=sc.length>0?sc.reduce((a,b)=>a+b,0)/sc.length:0;
            return sc.length>=6 && avg>65;
        }
    }
];

// ── Gather metric values from inputs ──
function getInsightValues() {
    const vals={};
    baseMetrics.forEach(m=>{
        const inp=document.getElementById(m.inputs[0].id);
        if(inp&&inp.value!==''){const p=parseFloat(inp.value);if(!isNaN(p))vals[m.id]=p;}
        if(m.id==='gross-margin'){
            const g=document.getElementById('gross-margin-growth-value');
            if(g&&g.value!==''){const p=parseFloat(g.value);if(!isNaN(p))vals['gross-margin-growth']=p;}
        }
    });
    return vals;
}

// ── Evaluate all rules ──
function evaluateInsights() {
    const vals=getInsightValues();
    const scores={...metricScores};
    const triggered=[];
    insightRules.forEach(rule=>{
        try {
            if(rule.check(vals, scores, currentMode)) triggered.push(rule);
        } catch(e) {
            console.warn(`Insight rule "${rule.id}" failed:`, e.message);
        }
    });
    const order={critical:0,warning:1,info:2,positive:3};
    triggered.sort((a,b)=>(order[a.severity]??9)-(order[b.severity]??9));
    return triggered;
}

// ── Score to heatmap color ──
function scoreToHeatmapBg(score){
    if(score>=80) return {bg:'linear-gradient(135deg,#059669,#10B981)',color:'#fff'};
    if(score>=60) return {bg:'linear-gradient(135deg,#10B981,#34D399)',color:'#fff'};
    if(score>=40) return {bg:'linear-gradient(135deg,#F59E0B,#FBBF24)',color:'#fff'};
    if(score>=20) return {bg:'linear-gradient(135deg,#F97316,#FB923C)',color:'#fff'};
    return {bg:'linear-gradient(135deg,#DC2626,#EF4444)',color:'#fff'};
}

// ── Render category ring charts ──
function renderCategoryRings(scores){
    const c=document.getElementById('insights-rings');if(!c)return;
    c.innerHTML='';
    const cats=[
        {id:'profitability',name:'רווחיות',color:'#2563EB',ids:['roi','roe','gross-margin','pm','fcf-yield']},
        {id:'growth',name:'צמיחה',color:'#059669',ids:['fcf-growth','eps-growth','buyback']},
        {id:'valuation',name:'הערכת שווי',color:'#D97706',ids:['pe','peg']},
        {id:'stability',name:'יציבות',color:'#4338CA',ids:['cr','de','altman-z']}
    ];
    cats.forEach(cat=>{
        const filled=cat.ids.filter(id=>scores[id]!==undefined&&scores[id]>0);
        const avg=filled.length>0?Math.round(filled.reduce((a,id)=>a+scores[id],0)/filled.length):0;
        const R=24, circ=2*Math.PI*R;
        const offset=circ*(1-avg/100);
        const ring=document.createElement('div');
        ring.className='ring-item';
        ring.innerHTML=`
            <svg class="ring-svg" viewBox="0 0 64 64">
                <circle cx="32" cy="32" r="${R}" fill="none" stroke="#E2E8F0" stroke-width="5"/>
                <circle cx="32" cy="32" r="${R}" fill="none" stroke="${cat.color}" stroke-width="5"
                    stroke-dasharray="${circ.toFixed(2)}" stroke-dashoffset="${offset.toFixed(2)}"
                    transform="rotate(-90 32 32)" stroke-linecap="round"/>
                <text x="32" y="36" text-anchor="middle" font-family="Rubik" font-size="16" font-weight="700"
                    fill="${avg>0?cat.color:'#94A3B8'}">${avg}</text>
            </svg>
            <span class="ring-label">${cat.name}</span>
            <span class="ring-score">${filled.length}/${cat.ids.length} מדדים</span>`;
        c.appendChild(ring);
    });
}

// ── Render heatmap ──
function renderHeatmap(vals,scores){
    const grid=document.getElementById('heatmap-grid');if(!grid)return;
    grid.innerHTML='';
    baseMetrics.forEach(m=>{
        const cell=document.createElement('div');
        cell.className='heatmap-cell';
        const score=scores[m.id]||0;
        const hasFilled=vals[m.id]!==undefined;
        if(!hasFilled){
            cell.classList.add('hm-empty');
            cell.innerHTML=`<span class="hm-abbr">${metricAbbr[m.id]||m.id}</span><span class="hm-score">—</span>`;
        } else {
            cell.classList.add('hm-filled');
            const style=scoreToHeatmapBg(score);
            cell.style.background=style.bg;
            cell.style.color=style.color;
            cell.innerHTML=`<span class="hm-abbr">${metricAbbr[m.id]||m.id}</span><span class="hm-score">${score}</span>`;
        }
        cell.title=`${m.name}: ${hasFilled?score+'/100':'טרם הוזן'}`;
        grid.appendChild(cell);
    });
}

// ── Render severity summary badges ──
function renderSeveritySummary(insights){
    const c=document.getElementById('severity-summary');if(!c)return;
    const counts={critical:0,warning:0,positive:0,info:0};
    insights.forEach(i=>counts[i.severity]++);
    const defs=[
        {key:'critical',label:'קריטי',cls:'sev-critical'},
        {key:'warning',label:'אזהרה',cls:'sev-warning'},
        {key:'positive',label:'חיובי',cls:'sev-positive'},
        {key:'info',label:'מידע',cls:'sev-info'}
    ];
    c.innerHTML=defs.filter(d=>counts[d.key]>0).map(d=>
        `<div class="severity-badge ${d.cls}"><span class="sev-dot"></span>${counts[d.key]} ${d.label}</div>`
    ).join('');
}

// ── Render grouped insight cards ──
function renderInsightGroups(insights){
    const c=document.getElementById('insights-groups');if(!c)return;
    c.innerHTML='';
    if(!insights.length){
        c.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">לא נמצאו תובנות מיוחדות — המשך להזין נתונים</div>';
        return;
    }
    const metricNames={};
    baseMetrics.forEach(m=>metricNames[m.id]=m.name);
    const groups=[
        {severity:'critical',title:'דגלים אדומים',emoji:'🔴'},
        {severity:'warning',title:'נקודות לתשומת לב',emoji:'🟡'},
        {severity:'positive',title:'נקודות חוזק',emoji:'🟢'},
        {severity:'info',title:'מידע נוסף',emoji:'🔵'}
    ];
    groups.forEach(g=>{
        const items=insights.filter(i=>i.severity===g.severity);
        if(!items.length)return;
        const grp=document.createElement('div');
        grp.className='insight-group';
        let html=`<div class="insight-group-title"><span class="igt-icon ${g.severity}">${g.emoji}</span>${g.title} (${items.length})</div>`;
        items.forEach(item=>{
            const pills=item.metrics.filter(id=>metricNames[id]).map(id=>
                `<span class="insight-metric-pill">${metricNames[id]}</span>`
            ).join('');
            html+=`<div class="insight-item sev-${item.severity}">
                <div class="insight-icon ${item.severity}">${item.icon}</div>
                <div class="insight-content">
                    <div class="insight-title">${item.title}</div>
                    <div class="insight-desc">${item.desc}</div>
                    ${pills?`<div class="insight-metrics">${pills}</div>`:''}
                </div>
            </div>`;
        });
        grp.innerHTML=html;
        c.appendChild(grp);
    });
}

// ── Render strongest & weakest metrics ──
function renderExtremes(scores){
    const c=document.getElementById('insights-extremes');if(!c)return;
    c.innerHTML='';
    const filled=baseMetrics.filter(m=>scores[m.id]!==undefined&&scores[m.id]>0)
        .map(m=>({id:m.id,name:m.name,score:scores[m.id]}));
    if(filled.length<4){c.style.display='none';return;}
    c.style.display='';
    const sorted=[...filled].sort((a,b)=>b.score-a.score);
    const top3=sorted.slice(0,3);
    const bot3=sorted.slice(-3).reverse();
    function buildSec(title,emoji,items,isStrong){
        const color=isStrong?'#059669':'#DC2626';
        const rankCls=isStrong?'strong':'weak';
        return `<div class="extreme-section">
            <div class="extreme-title">${emoji} ${title}</div>
            ${items.map((item,i)=>{
                let nm=item.name;if(nm.length>22)nm=nm.substring(0,20)+'…';
                return `<div class="extreme-item">
                    <span class="extreme-rank ${rankCls}">${i+1}</span>
                    <span class="extreme-name">${nm}</span>
                    <div class="extreme-bar-wrap"><div class="extreme-bar-fill" style="width:${item.score}%;background:${color}"></div></div>
                    <span class="extreme-score-val" style="color:${color}">${item.score}</span>
                </div>`;
            }).join('')}
        </div>`;
    }
    c.innerHTML=buildSec('חזקים ביותר','🏆',top3,true)+buildSec('לשיפור','⚡',bot3,false);
}

// ── Main update function ──
function updateInsights(){
    const vals=getInsightValues();
    const scores={...metricScores};
    const insights=evaluateInsights();
    const filledCount=Object.keys(vals).filter(k=>k!=='gross-margin-growth').length;
    const emptyEl=document.getElementById('insights-empty');
    const contentEl=document.getElementById('insights-content');
    const subtitleEl=document.getElementById('insights-subtitle');
    if(filledCount<3){
        if(emptyEl)emptyEl.style.display='';
        if(contentEl)contentEl.classList.remove('active');
        if(subtitleEl)subtitleEl.textContent='הזן לפחות 3 מדדים כדי לקבל תובנות';
        return;
    }
    if(emptyEl)emptyEl.style.display='none';
    if(contentEl)contentEl.classList.add('active');
    if(subtitleEl){
        const crit=insights.filter(i=>i.severity==='critical').length;
        const warn=insights.filter(i=>i.severity==='warning').length;
        const pos=insights.filter(i=>i.severity==='positive').length;
        let txt=`${insights.length} תובנות`;
        if(crit>0)txt+=` · ${crit} קריטיות`;
        else if(pos>warn)txt+=` · מצב חיובי`;
        subtitleEl.textContent=txt;
    }
    renderCategoryRings(scores);
    renderHeatmap(vals,scores);
    renderSeveritySummary(insights);
    renderInsightGroups(insights);
    renderExtremes(scores);
}

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {

    // Compare mode toggle
    document.getElementById('compare-toggle')?.addEventListener('click', toggleCompareMode);
    
    // Company tab clicks
    document.querySelectorAll('.company-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            if (!e.target.classList.contains('company-tab-edit')) {
                switchCompany(parseInt(tab.dataset.company));
            }
        });
    });
    document.querySelectorAll('.company-tab-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            editCompanyName(parseInt(btn.dataset.company));
        });
    });
    
    // Infographics gallery
    document.getElementById('view-infographics-btn')?.addEventListener('click', openInfographicsGallery);
    document.getElementById('infographics-close')?.addEventListener('click', closeInfographicsGallery);
    document.getElementById('infographics-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'infographics-modal') closeInfographicsGallery();
    });
    
    // AI Prompt modal
    document.getElementById('ai-prompt-close')?.addEventListener('click', closeAIPromptModal);
    document.getElementById('ai-prompt-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'ai-prompt-modal') closeAIPromptModal();
    });
    document.getElementById('copy-ai-prompt')?.addEventListener('click', copyAIPrompt);
    document.getElementById('download-ai-prompt')?.addEventListener('click', downloadAIPrompt);
    
    // CSV modal
    document.getElementById('csv-close')?.addEventListener('click', closeCSVModal);
    document.getElementById('csv-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'csv-modal') closeCSVModal();
    });
    document.getElementById('csv-download-current')?.addEventListener('click', downloadCurrentDataCSV);
    document.getElementById('csv-download-template')?.addEventListener('click', downloadEmptyTemplate);
    document.getElementById('csv-ai-generate')?.addEventListener('click', () => {
        closeCSVModal();
        openAIPromptModal();
    });
    
    // Render cards
    renderBaseCards();
    renderOptionalMetricsPicker();
    loadCustomStorage();
    getAllMetrics().forEach(m=>{metricScores[m.id]=0});
    createMiniGauge();

    // Bind metric inputs
    baseMetrics.forEach(m=>{
        const card=document.getElementById(`${m.id}-card`);if(!card)return;
        m.inputs.forEach(inp=>{
            const el=card.querySelector(`#${inp.id}`);
            if(el)el.addEventListener('input',()=>{updateSingleMetric(m);updateTotalScore();updateProgress();updateCategoryStats();updateRadar()});
        });
        const infoBtn=card.querySelector('.info-btn[data-term]');
        if(infoBtn)infoBtn.onclick=e=>{e.stopPropagation();openDeepDive(m.id)};
        const ctBtn=card.querySelector('.ct-apply');
        if(ctBtn)ctBtn.onclick=()=>{
            const ctInp=card.querySelector(`#${m.id}-ct-input`);
            const nv=parseFloat(ctInp?.value);
            if(!isNaN(nv)&&m.compare!=='combined'&&m.id!=='pe'){customThresholds[m.id]=nv;updateSingleMetric(m);updateTotalScore();showToast('סף עודכן');}
            else{delete customThresholds[m.id];if(ctInp)ctInp.value='';updateSingleMetric(m);updateTotalScore();showToast('סף אופס','warning');}
        };
    });

    // Mode tabs
    document.querySelectorAll('.mode-tab').forEach(b=>b.onclick=()=>switchMode(b.dataset.mode));

    // Category toggle
    document.querySelectorAll('.category-head').forEach(h=>h.onclick=()=>{
        const cat=h.dataset.cat;
        const body=h.nextElementSibling;
        const chevron=h.querySelector('.cat-chevron');
        if(body)body.classList.toggle('collapsed');
        if(chevron)chevron.classList.toggle('collapsed');
    });

    // Company name
    const cnInput=document.getElementById('company-name');
    cnInput?.addEventListener('input',()=>{document.getElementById('topbar-company').textContent=cnInput.value.trim()||'ניתוח חדש'});

    // Scroll handler
    window.addEventListener('scroll',()=>{document.body.classList.toggle('scrolled',window.scrollY>50)},{passive:true});

    // Buttons
    document.getElementById('show-templates-btn')?.addEventListener('click',()=>{renderTemplateButtons();openModal('templates-modal')});
    document.getElementById('apply-template-btn')?.addEventListener('click',applyTemplate);
    document.getElementById('show-summary-btn')?.addEventListener('click',()=>{updateSummary();openModal('summary-modal')});
    document.getElementById('show-terms-btn')?.addEventListener('click',()=>{renderTerms('terms-profit');openModal('terms-modal')});
    document.getElementById('save-btn')?.addEventListener('click',saveAnalysis);
    document.getElementById('load-btn')?.addEventListener('click',()=>{populateHistory();openModal('history-modal')});
    document.getElementById('reset-btn')?.addEventListener('click',resetAll);
    document.getElementById('add-custom-btn')?.addEventListener('click',()=>{['cm-name','cm-desc','cm-threshold','cm-optimal','cm-worst','cm-unit'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=''});['cm-wg','cm-wb','cm-wv'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='1.0'});document.getElementById('cm-compare').value='above';openModal('custom-modal')});
    document.getElementById('save-custom-btn')?.addEventListener('click',saveCustomMetric);

    // CSV
    const csvInput=document.getElementById('csv-file-input');
    document.getElementById('import-csv-btn')?.addEventListener('click',()=>csvInput?.click());
    csvInput?.addEventListener('change',e=>{if(e.target.files[0])importCSV(e.target.files[0]);e.target.value=null});
    document.getElementById('download-csv-btn')?.addEventListener('click', openCSVModal);

    // Advanced toggle
    const advToggle=document.getElementById('advanced-toggle');
    advToggle?.addEventListener('click',()=>{
        isAdvancedMode=!isAdvancedMode;
        advToggle.classList.toggle('active',isAdvancedMode);
        advToggle.setAttribute('aria-checked',isAdvancedMode);
        document.querySelectorAll('.custom-threshold').forEach(el=>el.classList.toggle('visible',isAdvancedMode));
        if(isAdvancedMode){
            getAllMetrics().forEach(m=>{
                const ci=document.getElementById(`${m.id}-ct-input`);
                if(ci){ci.value=customThresholds[m.id]!==undefined?customThresholds[m.id]:'';ci.placeholder=String(m.threshold);
                if(!m.isCustom&&(m.compare==='combined'||m.id==='pe')){ci.disabled=true;ci.nextElementSibling.disabled=true}else{ci.disabled=false;ci.nextElementSibling.disabled=false}}
            });
        }
        updateAllMetrics();showToast(`מצב מתקדם ${isAdvancedMode?'מופעל':'כבוי'}`);
    });
    advToggle?.addEventListener('keydown',e=>{if(e.key===' '||e.key==='Enter'){e.preventDefault();advToggle.click()}});

    // Modal close
    document.querySelectorAll('.modal-close').forEach(b=>b.onclick=()=>closeModal(b.dataset.modal));
    document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)closeModal(m.id)}));
    window.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-overlay.open').forEach(m=>closeModal(m.id))});

    // Term tabs
    document.querySelectorAll('#terms-tabs .modal-tab').forEach(tab=>tab.onclick=()=>{
        document.querySelectorAll('#terms-tabs .modal-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        renderTerms(tab.dataset.tab);
    });

    // Tour
    document.getElementById('tour-btn')?.addEventListener('click',startTour);


    // Infographics modal backdrop click
    document.getElementById('infographics-modal')?.addEventListener('click', e => {
        if (e.target.id === 'infographics-modal') closeInfographicsModal();
    });
    
    // AI Prompt modal backdrop click
    document.getElementById('ai-prompt-modal')?.addEventListener('click', e => {
        if (e.target.id === 'ai-prompt-modal') closeAIPromptModal();
    });
    
    // CSV upload handler
    const csvUploadEl = document.getElementById('csv-upload');
    if (csvUploadEl) {
        csvUploadEl.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (typeof importCSVEnhanced === 'function') {
                    importCSVEnhanced(file);
                } else if (typeof importCSV === 'function') {
                    importCSV(file);
                }
            }
            e.target.value = '';
        });
    }
    
    // Deep-dive modal close
    document.getElementById('deepdive-close')?.addEventListener('click', closeDeepDive);
    document.getElementById('deepdive-modal')?.addEventListener('click', e => {
        if (e.target.id === 'deepdive-modal') closeDeepDive();
    });

    // Insights panel toggle
    document.getElementById('insights-toggle')?.addEventListener('click',()=>{
        const body=document.getElementById('insights-body');
        const btn=document.getElementById('insights-toggle');
        if(!body||!btn)return;
        body.classList.toggle('collapsed');
        btn.textContent=body.classList.contains('collapsed')?'הצג ▾':'הסתר ▴';
    });

    updateAllMetrics();
    console.log('Financial Health Score — Initialized ✓');
});

// ═══════════════════════════════════════════
// SIMPLE TOUR (no Shepherd dependency)
// ═══════════════════════════════════════════
function startTour() {
    const steps = [
        {el:null, title:'ברוכים הבאים!', text:'סיור קצר שיעזור להתחיל. הכלי מאפשר להעריך את הבריאות הפיננסית של חברות על בסיס 13 מדדים מרכזיים.'},
        {el:'#input-section', title:'הגדרות ניתוח', text:'הזן שם חברה, בחר פרופיל השקעה (צמיחה/מאוזן/ערך), והשתמש בכלים: תבניות ענפיות, ייבוא CSV, שמירה וטעינה.'},
        {el:'#progress-card', title:'מד התקדמות', text:'עוקב אחר כמות המדדים שמילאת. ככל שתמלא יותר — הניתוח מדויק יותר.'},
        {el:'#cat-profitability', title:'קטגוריות מדדים', text:'המדדים מחולקים לקטגוריות: רווחיות, צמיחה, הערכת שווי ויציבות. לחץ על כותרת לפתיחה/סגירה.'},
        {el:'#score-card', title:'לוח ציון', text:'המד מסכם את הציון הכולל. הגרף הרדיאלי מציג ביצועים לפי קטגוריה. לחץ "הצג סיכום" לסקירה מלאה.'},
    ];
    let current=0;
    const overlay=document.createElement('div');
    overlay.style.cssText='position:fixed;inset:0;background:rgba(15,23,42,0.6);z-index:9998;transition:opacity .3s;';
    const popup=document.createElement('div');
    popup.style.cssText='position:fixed;z-index:9999;background:white;border-radius:16px;padding:24px;max-width:380px;width:90%;box-shadow:0 24px 48px rgba(0,0,0,0.2);transition:opacity .3s,transform .3s;';

    function show(idx) {
        const step=steps[idx];
        let top='50%',left='50%',transform='translate(-50%,-50%)';
        if(step.el){
            const el=document.querySelector(step.el);
            if(el){
                el.scrollIntoView({behavior:'smooth',block:'center'});
                const rect=el.getBoundingClientRect();
                top=`${Math.min(rect.bottom+12,window.innerHeight-250)}px`;
                left=`${Math.max(16,Math.min(rect.left,window.innerWidth-400))}px`;
                transform='none';
            }
        }
        popup.style.top=top;popup.style.left=left;popup.style.transform=transform;
        popup.innerHTML=`<div style="font-weight:700;font-size:16px;margin-bottom:8px;color:var(--primary)">${step.title}</div>
            <div style="font-size:14px;color:var(--text-secondary);line-height:1.7;margin-bottom:16px">${step.text}</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
                <span style="font-size:12px;color:var(--text-muted)">${idx+1}/${steps.length}</span>
                <div style="display:flex;gap:8px">
                    ${idx>0?'<button class="tour-prev-btn" style="padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:white;font-weight:500;cursor:pointer">הקודם</button>':''}
                    <button class="tour-next-btn" style="padding:8px 16px;border-radius:8px;border:none;background:var(--primary);color:white;font-weight:500;cursor:pointer">${idx===steps.length-1?'סיום':'הבא'}</button>
                </div>
            </div>`;
        
        // Bind button clicks directly
        const nextBtn = popup.querySelector('.tour-next-btn');
        const prevBtn = popup.querySelector('.tour-prev-btn');
        if(nextBtn) nextBtn.onclick = handleNext;
        if(prevBtn) prevBtn.onclick = handlePrev;
    }
    
    function cleanup() {
        overlay.removeEventListener('click', cleanup);
        overlay.remove();
        popup.remove();
    }
    
    function handleNext() {
        if(current < steps.length - 1) {
            current++;
            show(current);
        } else {
            cleanup();
        }
    }
    
    function handlePrev() {
        if(current > 0) {
            current--;
            show(current);
        }
    }
    
    overlay.addEventListener('click', cleanup);
    document.body.appendChild(overlay);
    document.body.appendChild(popup);
    show(0);
}
    </script>
</body>
</html>